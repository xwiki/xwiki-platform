'use strict';var XWiki=function(c){function l(){return new h.Comments}var h=c.viewers=c.viewers||{};h.Comments=Class.create({commentNumberRegex:/.+_(\d+)/,xcommentSelector:".xwikicomment",commentPlaceHolderSelector:"commentFormPlaceholder",extractCommentNumber:function(a){return a.id.match(this.commentNumberRegex)[1]},hasCommentNumber:function(a){return 1<a.id.match(this.commentNumberRegex).length},initialize:function(){if(void 0===c.viewers.initialized){c.viewers.initialized=!0;var a=$("commentscontent");
a&&this.startup();$("Commentstab")?this.container=$("Commentspane"):a&&(this.container=a.wrap("div",{id:"Commentspane"}));this.addTabLoadListener()}},startup:function(){this.formDisplayed=!1;this.loadIDs();this.getForm();this.addReplyListener();this.addEditListener();var a=$("openCommentForm");a&&a.observe("click",function(b){b.stop();$(this.commentPlaceHolderSelector).show();this.displayHiddenForm();this.reloadEditor({callback:function(){this.getForm();this.addSubmitListener(this.form);this.addCancelListener();
this.addPreview(this.form)}.bind(this)})}.bind(this))},getForm:function(){var a=$("commentform");this.form=a?a.up("form"):void 0},displayHiddenForm:function(){if(!this.formDisplayed){var a=$(this.commentPlaceHolderSelector);a&&a.removeClassName("hidden");(a=$("openCommentForm"))&&a.hide();this.formDisplayed=!0}},loadIDs:function(){$$(this.xcommentSelector).each(function(a){var b=a.id;a._x_number=b.substring(b.lastIndexOf("_")+1)-0})},addEditListener:function(){$$(this.xcommentSelector).each(function(a){(a=
a.down("a.edit"))&&a.observe("click",function(b){a.blur();b.stop();this.displayHiddenForm();this.resetForm();a.disabled||(a._x_editForm?(b=a.up(this.xcommentSelector),b.hide(),b=this.extractCommentNumber(b),this.reloadEditor({commentNbr:b,callback:function(){this.getForm()}.bind(this)}),a._x_editForm.show()):new Ajax.Request(a.readAttribute("href").replace("viewer=comments","xpage=xpart&vm=commentsinline.vm"),{onCreate:function(){a.disabled=!0;a._x_notification=new c.widgets.Notification("$services.localization.render('core.viewers.comments.editForm.fetch.inProgress')",
"inprogress")},onSuccess:function(d){this.editing&&this.cancelEdit(!1,this.editing);var e=a.up(this.xcommentSelector);e.insert({before:d.responseText});a._x_editForm=e.previous();this.addSubmitListener(a._x_editForm);d=a.readAttribute("href").match(/number=(\d+)/)[1];$(this.commentPlaceHolderSelector).hide();this.reloadEditor({commentNbr:d,callback:function(){this.addPreview(a._x_editForm);a._x_editForm.down("a.cancel").observe("click",this.cancelEdit.bindAsEventListener(this,a));e.hide();a._x_notification.hide();
this.editing=a}.bind(this)})}.bind(this),onFailure:function(d){a._x_notification.replace(new c.widgets.Notification("$services.localization.render('core.viewers.comments.editForm.fetch.failed')"+(d.statusText||"Server not responding"),"error"))}.bind(this),on0:function(d){d.request.options.onFailure(d)},onComplete:function(){a.disabled=!1}}))}.bindAsEventListener(this))}.bind(this))},cancelEdit:function(a,b){a&&a.stop();a=b.up(this.xcommentSelector);b._x_editForm.hide();const d=this.extractCommentNumber(a);
this.destroyEditor("[name='XWiki.XWikiComments_"+(d+"_comment']"));a.show();this.resetForm();this.cancelPreview(b._x_editForm);this.editing=!1},addReplyListener:function(){this.form?$$(this.xcommentSelector).each(function(a){this.addReplyListenerToComment(a)}.bind(this)):$$(this.xcommentSelector+" a.commentreply").each(function(a){a.hide()})},addReplyListenerToComment:function(a){(a=a.down("a.commentreply"))&&a.observe("click",function(b){a.blur();b.stop();this.getForm();this.form.up(".commentthread")&&
this.form.up(".commentthread").previous(this.xcommentSelector).down("a.commentreply").show();a.up(this.xcommentSelector).next(".commentthread").insert({top:this.form});this.reloadEditor({callback:function(){this.getForm();this.addSubmitListener(this.form);this.addCancelListener();this.addPreview(this.form);this.form["XWiki.XWikiComments_replyto"].value=a.up(this.xcommentSelector)._x_number;this.form["XWiki.XWikiComments_comment"].value="";this.form["XWiki.XWikiComments_comment"].focus();a.hide()}.bind(this)})}.bindAsEventListener(this))},
addSubmitListener:function(a){a&&!a._has_event&&(a._has_event=!0,a.down("input[type='submit']").observe("click",function(b){b.stop();document.fire("xwiki:actions:beforeSave");if(""!=a.down("textarea").value){b=new Hash(a.serialize(!0));b.set("xredirect",window.docgeturl+"?xpage=xpart&vm=commentsinline.vm&skin="+encodeURIComponent(c.skin));b.set("xpage","xpart");b.set("vm","commentsinline.vm");b.set("skin",c.skin);var d=$H(a.action.toQueryParams());b.keys().each(d.unset.bind(d));d=a.action.replace(/\?.*/,
"?"+d.toQueryString());b.unset("action_cancel");a._x_notification=new c.widgets.Notification("$services.localization.render('core.viewers.comments.add.inProgress')","inprogress");a.disable();this.requestSucceeded=!1;new Ajax.Request(d,{method:"post",parameters:b,onSuccess:function(){this.requestSucceeded=!0;this.editing=!1}.bind(this),onFailure:function(e){a._x_notification.replace(new c.widgets.Notification("$services.localization.render('core.viewers.comments.add.failed')"+(e.statusText||"Server not responding"),
"error"))}.bind(this),on0:function(e){e.request.options.onFailure(e)},onComplete:function(e){a.enable();var f=a.down(".xwikicomment"),g="XWiki.XWikiComments_comment";void 0!==f&&this.hasCommentNumber(f)&&(g="XWiki.XWikiComments_"+this.extractCommentNumber(f)+"_comment");this.destroyEditor("[name='"+g+"']");this.requestSucceeded&&(this.container.update(e.responseText),e=$("submittedcomment"),f="",e?(f=e.value,e.remove(),this.formDisplayed=!1,this.displayHiddenForm(),this.reloadEditor({content:f,callback:function(){this.getForm();
this.addSubmitListener(this.form);this.addCancelListener();this.addPreview(this.form)}.bind(this)})):this.resetForm(),document.fire("xwiki:docextra:loaded",{id:"Comments",element:this.container}),this.container.fire("xwiki:captcha:reloaded"),a._x_notification.replace(new c.widgets.Notification("$services.localization.render('core.viewers.comments.add.done')","done")))}.bind(this)})}}.bindAsEventListener(this)))},addCancelListener:function(){this.form&&(this.initialLocation=new Element("span",{className:"hidden"}),
$("_comments").insert(this.initialLocation),this.form.down("a.cancel").observe("click",this.resetForm.bindAsEventListener(this)))},addPreview:function(a){if(a&&c.hasEdit&&"text"===a.down("input[name='defaultEditorId']").value){var b="$xwiki.getURL('__space__.__page__', 'preview')".replace("__space__",encodeURIComponent(c.currentSpace)).replace("__page__",encodeURIComponent(c.currentPage));a.commentElt=a.down("textarea");var d=a.down("input[type=submit]").up("div");a.previewButton=(new Element("span",
{"class":"buttonwrapper"})).update(new Element("input",{type:"button","class":"button",value:"$services.localization.render('core.viewers.comments.preview.button.preview')"}));a.previewButton._x_modePreview=!1;var e=a.previewButton.down("input").value;(e=d.down("input[value='"+e+"']"))&&e.remove();d.insert({top:a.previewButton});a.previewButton.observe("click",function(){if(a.previewButton._x_modePreview||a.previewButton.disabled)this.cancelPreview(a);else{a.previewButton.disabled=!0;var f=new c.widgets.Notification("$services.localization.render('core.viewers.comments.preview.inProgress')",
"inprogress");new Ajax.Request(b,{method:"post",parameters:{xpage:"plain",sheet:"",content:a.down("textarea").value,form_token:a.form_token.value,restricted:"true"},onSuccess:function(g){var k=a.commentElt.up(this.xcommentSelector),m;void 0!==k&&this.hasCommentNumber(k)&&(m=this.extractCommentNumber(k));this.doPreview(g.responseText,a,m);f.hide()}.bind(this),on400:function(g){this.doPreview("&nbsp;",a);f.hide()}.bind(this),onFailure:function(g){f.replace(new c.widgets.Notification("$services.localization.render('core.viewers.comments.preview.failed')"+
(g.statusText||"Server not responding"),"error"))},on0:function(g){g.request.options.onFailure(g)},onComplete:function(g){a.previewButton.disabled=!1}.bind(this)})}}.bindAsEventListener(this))}},doPreview:function(a,b,d){require(["jquery"],function(e){b.previewButton._x_modePreview=!0;var f=".commenteditor";d&&(f+="-"+d);f=e(b).find(f);e(b).find(".commentPreview").length||f.before('<div class="commentcontent commentPreview" style="display: none;"></div>');const g=e(b).find(".commentcontent.commentPreview");
g.html(a);g.show();f.hide();e(b.previewButton).find("input").val("$services.localization.render('core.viewers.comments.preview.button.back')")}.bind(this))},cancelPreview:function(a){require(["jquery"],function(b){a.previewButton&&(a.previewButton._x_modePreview=!1,b(a.previewButton).find("input").val("$services.localization.render('core.viewers.comments.preview.button.preview')"));const d=b(a).find(".commentPreview");d&&(d.hide(),d.empty());(b=b(a).find(".commenteditor"))&&b.show()}.bind(this))},
resetForm:function(a){a&&a.stop();require(["jquery"],function(b){const d=b("#"+this.commentPlaceHolderSelector);this.form.up(".commentthread")&&(this.form.up(".commentthread").previous(this.xcommentSelector).down("a.commentreply").show(),d.empty().append(this.form));d.addClass("hidden");this.formDisplayed=!1;b("#openCommentForm").show();this.form["XWiki.XWikiComments_replyto"].value="";this.cancelPreview(this.form);b(document).trigger("xwiki:actions:cancel")}.bind(this))},addTabLoadListener:function(){var a=
function(b){"Comments"==b.memo.id&&this.startup()}.bindAsEventListener(this);document.observe("xwiki:docextra:loaded",a)},destroyEditor:function(a){require(["jquery","xwiki-events-bridge"],function(b){b(document).trigger("xwiki:actions:cancel");b(a).length&&b(a).parent(".commenteditor").empty()})},reloadEditor:function(a){var b=".commenteditor";a=a||{};const d=a.commentNbr,e=a.callback;var f="XWiki.XWikiComments_comment";d&&(f="XWiki.XWikiComments_"+d+"_comment",b=b+"-"+d);var g=a.content||{};this.destroyEditor("[name='"+
f+"']");require(["jquery","xwiki-events-bridge"],function(k){k(".commenteditor").length&&k.post((new c.Document).getURL("get")+"?"+k.param({xpage:"xpart",vm:"commentfield.vm",number:d,name:f,content:g}),function(m){const n=k(b);n.empty();n.append(m);n.show();k(document).trigger("xwiki:dom:updated",{elements:n.toArray()});k("#commentCaptcha").length&&k("#commentCaptcha").first().css("display","block");e&&e()})})}});c.domIsLoaded&&l()||document.observe("xwiki:dom:loaded",l);return c}(XWiki||{});
require(["jquery"],function(c){c(document).on("show.bs.modal","#permalinkModal",function(l){l=c(l.relatedTarget).prop("href");c(this).find(".form-control").val(l)});c(document).on("shown.bs.modal","#permalinkModal",function(){c(this).find(".form-control").focus()});c(document).on("click","#permalinkModal input.btn-primary",function(){window.location=c("#permalinkModal").find(".form-control").val()})});
require(["jquery","xwiki-events-bridge"],function(c){c(document).on("show.bs.modal","#deleteModal",function(h){c(this).data("relatedTarget",c(h.relatedTarget))});c(document).on("click","#deleteModal input.btn-danger",function(){var h=c("#deleteModal").data("relatedTarget"),a;c.ajax({url:h.prop("href"),beforeSend:function(){h.prop("disabled",!0);a=new XWiki.widgets.Notification("$services.localization.render('core.viewers.comments.delete.inProgress')","inprogress")},success:function(){var b=h.closest(".xwikicomment"),
d=b.nextAll(".commentthread").find("form");d.length&&d.find(".cancel")[0].click();d=b.replaceWith;var e=new Element("div",{"class":"notification"});e.update("$services.localization.render('core.viewers.comments.commentDeleted')");d.call(b,e);l();a.replace(new XWiki.widgets.Notification("$services.localization.render('core.viewers.comments.delete.done')","done"));b.hasClass("annotation")&&c(document).trigger("xwiki:annotation:tab:deleted")},error:function(){h.prop("disabled",!1);a.replace(new XWiki.widgets.Notification("$services.localization.render('core.viewers.comments.delete.failed')",
"error"))}})});var l=function(){var h=c("#Commentstab").find(".itemCount"),a=c(".xwikicomment").length;h&&h.text("$services.localization.render('docextra.extranb', ['__number__'])".replace("__number__",a));c("#tmComment").length&&(c("#tmComment")[0].normalize(),h=" $services.localization.render('docextra.comments') $services.localization.render('docextra.extranb', ['__number__'])".replace("__number__",a),c("#tmComment").contents().last()[0].nodeValue=h)};c(document).on("xwiki:docextra:loaded",function(h,
a){"Comments"===a.id&&l()})});

//# sourceMappingURL=comments.min.js.map
