## ---------------------------------------------------------------------------
## See the NOTICE file distributed with this work for additional
## information regarding copyright ownership.
##
## This is free software; you can redistribute it and/or modify it
## under the terms of the GNU Lesser General Public License as
## published by the Free Software Foundation; either version 2.1 of
## the License, or (at your option) any later version.
##
## This software is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
## Lesser General Public License for more details.
##
## You should have received a copy of the GNU Lesser General Public
## License along with this software; if not, write to the Free
## Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
## 02110-1301 USA, or see the FSF site: http://www.fsf.org.
## ---------------------------------------------------------------------------
#template('refactoringStatus_macros.vm') 

## TODO: migrate from document to attachment status

#macro (displayMoveJobRequest $moveJobRequest)
  <div class="refactoring-job-request row xform">
    <div class="col-xs-12 col-lg-6">
      <dl>
        #displayLocations('attachment.move.source.label' 'attachment.move.source.hint' $moveJobRequest.entityReferences)
        #displayBooleanConfigParam('attachment.move.children.label', 'attachment.move.children.hintWithoutParams'
          $moveJobRequest.isDeep())
        #if ($isAdvancedUser || $isSuperAdmin)
          #displayBooleanConfigParam('attachment.move.links.label', 'attachment.move.links.hintWithoutParams'
            $moveJobRequest.isUpdateLinks())
        #end
        #displayBooleanConfigParam('attachment.move.autoRedirect.label', 'attachment.move.autoRedirect.hint'
          $moveJobRequest.isAutoRedirect())
      </dl>
    </div>
    <div class="col-xs-12 col-lg-6">
      <dl>
        #displayLocations('attachment.move.target.location.label' 'attachment.move.target.location.hint'
          [$moveJobRequest.destination])
        #if ($isAdvancedUser || $isSuperAdmin)
          #set ($defaultDocumentName = $services.model.getEntityReference('DOCUMENT', 'default').name)
          #set ($terminal = $moveJobRequest.destination.type == 'DOCUMENT'
            && $moveJobRequest.destination.name != $defaultDocumentName)
          #displayBooleanConfigParam('attachment.move.target.terminal.label', 'attachment.move.target.terminal.hint' $terminal)
        #end
      </dl>
    </div>
  </div>
#end

#macro (displayMoveJobStatus $moveJobStatus)
  #set ($discard = $xwiki.jsfx.use('uicomponents/job/job.js', true))
  ## TODO: allows question templates to inject the web resources they need
  #set ($discard = $xwiki.linkx.use($services.webjars.url('org.xwiki.platform:xwiki-platform-tree-webjar', 
    'tree.min.css', {'evaluate': true}), {'type': 'text/css', 'rel': 'stylesheet'}))
##  #set ($discard = $xwiki.jsfx.use("uicomponents/job/question/ExtensionBreakingQuestion.js", true))
##  #set ($discard = $xwiki.jsfx.use("uicomponents/job/question/XClassBreakingQuestion.js", true))
  #set ($moveJobState = $moveJobStatus.state)
  STATE $moveJobState
  #set ($finished = $moveJobState == 'FINISHED')
  #set ($moveJobRequest = $moveJobStatus.request)
  #set ($jobStatusURL = $doc.getURL('get', $escapetool.url({
    'xpage': 'attachment/move',
    'outputSyntax': 'plain',
    'moveId': $moveJobRequest.id.get($mathtool.sub($moveJobRequest.id.size(), 1))
  })))
  <div class="xcontent job-status" data-url="$jobStatusURL">
    <h2>$services.localization.render('attachment.move.status.label')</h2>  
    <p class="text-muted small">$services.localization.render('attachment.move.status.hint',
      [$xwiki.getUserName($moveJobRequest.userReference), $xwiki.formatDate($moveJobStatus.startDate)])</p>
    #displayMoveJobRequest($moveJobRequest)
    #if (!$finished)
      NOT FINISHED
      #displayJobProgressBar($moveJobStatus)
      #displayJobQuestion($moveJobStatus)
    #else
      FINISHED
      #displayJobFinishedMessage($moveJobStatus)
    #end
    #if ($isAdvancedUser || $isSuperAdmin)
      #displayJobStatusLog($moveJobStatus true)
    #end
  </div>
#end

#macro (outputmoveJobStatusJSON $moveJobStatus)
  #getJobStatusJSON($moveJobStatus $json)
  $response.setContentType('application/json')
  $jsontool.serialize($json)
#end

#set ($moveJobStatus = $services.job.getJobStatus(['refactoring', 'moveAttachment', $request.moveId]))
#if ($moveJobStatus)
  #if ($xcontext.action == 'get')
    #outputMoveJobStatusJSON($moveJobStatus)
  #else
    #displayMoveJobStatus($moveJobStatus)
  #end
#else
  $response.setStatus(404)
  <div class="box errormessage">
    $services.localization.render('attachment.move.status.notFound')
  </div>
#end
