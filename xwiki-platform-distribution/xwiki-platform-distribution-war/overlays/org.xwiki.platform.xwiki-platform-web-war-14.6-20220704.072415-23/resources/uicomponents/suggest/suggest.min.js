'use strict';var XWiki=function(l){var n=l.widgets=l.widgets||{};"undefined"==typeof n.XList?"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("[Suggest widget] Required class missing: XWiki.widgets.XList"):n.Suggest=Class.create({options:{minchars:1,method:"get",varname:"input",className:"ajaxsuggest",timeout:2500,delay:500,offsety:0,shownoresults:!0,noresults:"$services.localization.render('core.widgets.suggest.noResults')",maxheight:250,cache:!1,seps:"",icon:null,resultsParameter:"results",
resultId:"id",resultValue:"value",resultInfo:"info",resultInfoHTML:!1,resultIcon:"icon",resultHint:"hint",resultType:"type",resultURL:"url",parentContainer:"body",highlight:!0,fadeOnClear:!0,hideButton:{positions:["top"],text:"$escapetool.javascript($services.localization.render('core.widgets.suggest.hide'))"},insertBeforeSuggestions:null,displayValue:!1,displayValueText:"$services.localization.render('core.widgets.suggest.valuePrefix')",align:"left",unifiedLoader:!1,loaderNode:null,propagateEventKeyCodes:[]},
sInput:"",nInputChars:0,aSuggestions:{},iHighlighted:null,isActive:!1,initialize:function(a,b){if(!a)return!1;this.setInputField(a);this.options=Object.extend(Object.clone(this.options),b||{});"object"==typeof this.options.sources?(this.isInMultiSourceMode=!0,this.sources=this.options.sources):this.sources=this.options;this.sources=[this.sources].flatten().compact();0==this.sources.length&&this.sources.push({script:function(c,d){d([])}});$(this.options.parentContainer)||(this.options.parentContainer=
$(document.body));this.seps=this.options.seps?this.options.seps:"";this.latestRequest=0},setInputField:function(a){this.detach();this.fld=$(a);this.fld.__x_suggest&&this.fld.__x_suggest.detach();this.fld.__x_suggest=this;this.onKeyUp=this.onKeyUp.bindAsEventListener(this);this.fld.observe("keyup",this.onKeyUp);this.onKeyPress=this.onKeyPress.bindAsEventListener(this);Prototype.Browser.IE||Prototype.Browser.WebKit||browser.isIE11up?this.fld.observe("keydown",this.onKeyPress):this.fld.observe("keypress",
this.onKeyPress);this.fld.setAttribute("autocomplete","off");this.fld.observe("blur",function(b){this.latestRequest++}.bind(this))},onKeyUp:function(a){switch(a.keyCode){case Event.KEY_RETURN:case Event.KEY_ESC:case Event.KEY_UP:case Event.KEY_DOWN:break;default:if(this.seps){a=-1;for(var b=0;b<this.seps.length;b++)this.fld.value.lastIndexOf(this.seps.charAt(b))>a&&(a=this.fld.value.lastIndexOf(this.seps.charAt(b)));-1==a?this.getSuggestions(this.fld.value):this.getSuggestions(this.fld.value.substring(a+
1))}else this.getSuggestions(this.fld.value)}},onKeyPress:function(a){if($(this.isActive)){var b=a.keyCode,c=!0;switch(b){case Event.KEY_RETURN:this.iHighlighted||1!=Object.keys(this.aSuggestions).length||1!=this.aSuggestions[Object.keys(this.aSuggestions)[0]].length||this.highlightFirst();this.setHighlightedValue(a);break;case Event.KEY_ESC:this.clearSuggestions();break;case Event.KEY_UP:this.changeHighlight(b);break;case Event.KEY_DOWN:this.changeHighlight(b);break;default:c=!1}c&&this.options.propagateEventKeyCodes&&
-1==this.options.propagateEventKeyCodes.indexOf(b)&&Event.stop(a)}},getSuggestions:function(a){a=a.strip().toLowerCase();if(a==this.sInput)return!1;if(a.length<this.options.minchars)return this.sInput="",this.clearSuggestions(),!1;if(a.length>this.nInputChars&&Object.keys(this.aSuggestions).length&&this.options.cache){for(var b={},c=0;c<Object.keys(this.aSuggestions).length;c++){for(var d=Object.keys(this.aSuggestions)[c],e=[],f=0;f<this.aSuggestions[d].length;f++){var g=this.aSuggestions[d][f];g.value.substr(0,
a.length).toLowerCase()==a&&e.push(g)}e.length&&(b[d]=e)}this.sInput=a;this.nInputChars=a.length;this.aSuggestions=b;for(c=0;c<sources.length;c++)a=sources[c],(b=this.aSuggestions[a.id])&&this.createList(b,a)}else{this.sInput=a;this.nInputChars=a.length;this.prepareContainer();this.latestRequest++;var h=this,k=this.latestRequest;clearTimeout(this.ajID);this.container.select(".hide-button-wrapper").invoke("hide");this.ajID=setTimeout(function(){h.doAjaxRequests(k)},this.options.delay)}return!1},doAjaxRequests:function(a,
b){if(!(this.fld.value.length<this.options.minchars))for(var c=0;c<this.sources.length;c++){var d=this.sources[c];"function"==typeof d.script?(this.fld.addClassName("loading"),d.script(this.fld.value.strip(),function(e){a==this.latestRequest&&(this.aSuggestions[d.id]=e||[],e&&this.createList(this.aSuggestions[d.id],d),this.fld.removeClassName("loading"))}.bind(this))):this.doAjaxRequest(d,a,b)}},doAjaxRequest:function(a,b,c){var d=a.script+(0>a.script.indexOf("?")?"?":"&")+a.varname+"="+encodeURIComponent(this.fld.value.strip()),
e=a.method||"get",f={};f.Accept=a.json?"application/json":"application/xml";a={method:e,requestHeaders:f,onCreate:this.fld.addClassName.bind(this.fld,"loading"),onSuccess:this.setSuggestions.bindAsEventListener(this,a,b),onFailure:function(g){new l.widgets.Notification("$services.localization.render('core.widgets.suggest.transportError')"+g.statusText,"error",{timeout:5})},onComplete:this.fld.removeClassName.bind(this.fld,"loading")};a.defaultValues=Object.clone(a);new Ajax.Request(d,Object.extend(a,
c||{}))},setSuggestions:function(a,b,c){c<this.latestRequest||(a=this.parseResponse(a,b),this.aSuggestions[b.id]=a||[],a&&this.createList(this.aSuggestions[b.id],b))},_getNestedProperty:function(a,b){for(b=b.split(".");b.length&&(a=a[b.shift()]););return 0<b.length?null:a},parseResponse:function(a,b){var c=[];if(b.json){a=a.responseJSON;if(!a)return null;a=Array.isArray(a)?a:this._getNestedProperty(a,b.resultsParameter||this.options.resultsParameter);for(var d=0;d<a.length;d++){var e=a[d];c.push({id:this._getNestedProperty(e,
b.resultId||this.options.resultId),value:this._getNestedProperty(e,b.resultValue||this.options.resultValue),info:this._getNestedProperty(e,b.resultInfo||this.options.resultInfo),icon:this._getNestedProperty(e,b.resultIcon||this.options.resultIcon),hint:this._getNestedProperty(e,b.resultHint||this.options.resultHint),type:this._getNestedProperty(e,b.resultType||this.options.resultType),url:this._getNestedProperty(e,b.resultURL||this.options.resultURL)})}}else for(a=a.responseXML.getElementsByTagName(b.resultsParameter||
this.options.resultsParameter)[0].childNodes,d=0;d<a.length;d++)a[d].hasChildNodes()&&c.push({id:a[d].getAttribute("id"),value:a[d].childNodes[0].nodeValue,info:a[d].getAttribute("info"),icon:a[d].getAttribute("icon"),hint:a[d].getAttribute("hint"),type:a[d].getAttribute("type"),url:a[d].getAttribute("url")});return c},prepareContainer:function(){if(!$(this.options.parentContainer).down(".suggestItems")){var a=new Element("div",{"class":"suggestItems "+this.options.className}),b="body"==$(this.options.parentContainer).tagName.toLowerCase()?
this.fld.cumulativeOffset():this.fld.positionedOffset(),c=this.fld.offsetWidth-2,d=this.options.width||c,e=this.fld.viewportOffset().left,f=$("body").getWidth();a.style.left="left"==this.options.align||"auto"==this.options.align&&e+this.options.width<f?b.left+"px":"center"==this.options.align?b.left+(c-d)/2+"px":b.left+c-d+"px";a.style.top=b.top+this.fld.offsetHeight+this.options.offsety+"px";a.style[this.options.width?"width":"minWidth"]=d+"px";var g=this;a.onmouseover=function(){g.killTimeout()};
a.onmouseout=function(){g.resetTimeout()};this.resultContainer=new Element("div",{"class":"resultContainer"});a.appendChild(this.resultContainer);$(this.options.parentContainer).insert(a);this.container=a;this.options.insertBeforeSuggestions&&this.resultContainer.insert(this.options.insertBeforeSuggestions);document.fire("xwiki:suggest:containerCreated",{container:this.container,suggest:this})}if(this.isInMultiSourceMode)for(a=0;a<this.sources.length;a++)b=this.sources[a],b.id=b.id||a,this.resultContainer.down(".results"+
b.id)?(this.resultContainer.down(".results"+b.id).down("ul")&&this.resultContainer.down(".results"+b.id).down("ul").remove(),this.options.unifiedLoader?((this.options.loaderNode||this.fld).addClassName("loading"),this.resultContainer.down(".results"+b.id).addClassName("hidden").addClassName("loading")):this.resultContainer.down(".results"+b.id).down(".sourceContent").addClassName("loading")):(c=new Element("div",{"class":"results results"+b.id}),d=new Element("div",{"class":"sourceName"}),this.options.unifiedLoader&&
c.addClassName("hidden").addClassName("loading"),"undefined"!=typeof b.icon&&(e=new Image,e.onload=function(){this.sourceHeader.setStyle({backgroundImage:"url("+this.iconImage.src+")"});this.sourceHeader.setStyle({textIndent:this.iconImage.width+6+"px"})}.bind({sourceHeader:d,iconImage:e}),e.src=b.icon),d.insert(b.name),c.insert(d),c.insert(new Element("div",{"class":"sourceContent "+(this.options.unifiedLoader?"":"loading")})),"undefined"!==typeof b.before&&this.resultContainer.insert(b.before),
this.resultContainer.insert(c),"undefined"!==typeof b.after&&this.resultContainer.insert(b.after));else this.resultContainer.down("ul")&&this.resultContainer.down("ul").remove();if("undefined"!==typeof this.options.hideButton&&"object"===typeof this.options.hideButton.positions&&0<this.options.hideButton.positions.length&&!this.container.down(".hide-button"))for(b=this.options.hideButton.positions,a=0;a<b.length;a++)c=(new Element("span",{"class":"hide-button"})).update(this.options.hideButton.text),
d={},d[b[a]]=(new Element("div",{"class":"hide-button-wrapper"})).update(c),c.observe("click",this.clearSuggestions.bindAsEventListener(this)),this.container.insert(d);this.container.fire("xwiki:suggest:containerPrepared",{container:this.container,suggest:this});return this.container},createList:function(a,b){this._createList(a,b);this.isInMultiSourceMode&&this.resultContainer.down(".results.loading")||document.fire("xwiki:suggest:updated",{container:this.container,suggest:this})},_createList:function(a,
b){this.isActive=!0;var c=this;this.killTimeout();if(this.isInMultiSourceMode){var d=this.resultContainer.down(".results"+b.id);d.removeClassName("loading");d.down(".sourceContent").removeClassName("loading");(0<a.length||this.options.shownoresults)&&d.removeClassName("hidden");this.options.unifiedLoader&&!this.resultContainer.down(".results.loading")&&(this.options.loaderNode||this.fld).removeClassName("loading")}else d=this.resultContainer;if(0==a.length&&!this.options.shownoresults)return!1;d.down("ul")&&
d.down("ul").remove();this.container.select(".hide-button-wrapper").invoke("show");for(var e=new l.widgets.XList([],{icon:this.options.icon,classes:"suggestList",eventListeners:{click:function(k){c.setHighlightedValue(k);return!1},mouseover:function(){c.setHighlight(this.getElement())}}}),f=0,g=a.length;f<g;f++){var h=function(k){return((k||"")+"").escapeHTML()};h=(new Element("div")).insert((new Element("span",{"class":"suggestId"})).update(h(a[f].id))).insert((new Element("span",{"class":"suggestValue"})).update(h(a[f].value))).insert((new Element("span",
{"class":"suggestInfo"})).update(h(a[f].info))).insert((new Element("span",{"class":"suggestURL"})).update(h(a[f].url)));h=new l.widgets.XListItem(this.createItemDisplay(a[f],b),{containerClasses:"suggestItem "+(a[f].type||""),value:h,noHighlight:!0});e.addItem(h)}0==a.length&&e.addItem(new l.widgets.XListItem(this.options.noresults,{classes:"noSuggestion",noHighlight:!0}));d.appendChild(e.getElement());this.suggest=d;c=this;0<this.options.timeout&&(this.toID=setTimeout(function(){c.clearSuggestions()},
this.options.timeout))},createItemDisplay:function(a,b){var c=this.sInput?this.sInput.escapeHTML():this.sInput,d=((a.value||"")+"").escapeHTML();c=b.highlight?this.emphasizeMatches(c,d):d;a.hint&&(d=(a.hint+"").escapeHTML(),c+="<span class='hint'>"+d+"</span>");this.options.displayValue?(c=(new Element("div")).insert((new Element("div",{"class":"value"})).update(c)),a.info&&(d=a.info+"",(void 0===b.resultInfoHTML?this.options.resultInfoHTML:b.resultInfoHTML)||(d=d.escapeHTML()),c.insert((new Element("div",
{"class":"info"})).update("<span class='legend'>"+this.options.displayValueText+"</span>"+d)))):c=(new Element("span",{"class":"info"})).update(c);a.icon&&(a=0<=a.icon.indexOf(".")||0<=a.icon.indexOf("/")?new Element("img",{src:a.icon,"class":"icon"}):new Element("i",{"class":"icon "+a.icon}),c.insert({top:a}));return c},emphasizeMatches:function(a,b){if(!a)return b;var c=b;a=a.split(/\s+/).uniq().compact();var d=0,e={};b=0;for(var f=a.length;b<f;b++)for(var g=c.toLowerCase().indexOf(a[b].toLowerCase());0<=
g;){var h=c.substring(g,g+a[b].length),k="";a[b].length.times(function(){k+=" "});e[g]=h;c=c.substring(0,g)+k+c.substring(g+a[b].length);g=c.toLowerCase().indexOf(a[b].toLowerCase())}Object.keys(e).sortBy(function(m){return parseInt(m)}).each(function(m){var p=c.substring(0,parseInt(m)+d),q=c.substring(parseInt(m)+e[m].length+d);c=p+"<em>"+e[m]+"</em>"+q;d+=9});return c},changeHighlight:function(a){var b=this.resultContainer;if(!b)return!1;if(this.iHighlighted)if(a==Event.KEY_DOWN){var c=this.iHighlighted.next();
if(!c&&this.iHighlighted.up("div.results"))for(a=this.iHighlighted.up("div.results").next();a&&!c;)c=a.down("li"),a=a.next();c||=b.down("li")}else{if(a==Event.KEY_UP){c=this.iHighlighted.previous();if(!c&&this.iHighlighted.up("div.results"))for(a=this.iHighlighted.up("div.results").previous();a&&!c;)c=a.down("li:last-child"),a=a.previous();c||=b.select("ul")[b.select("ul").length-1].down("li:last-child")}}else a==Event.KEY_DOWN?c=b.down("div.results")?b.down("div.results").down("li"):b.down("li"):
a==Event.KEY_UP&&0<b.select("li")&&(c=b.select("li")[b.select("li").length-1]);c&&this.setHighlight(c)},setHighlight:function(a){this.iHighlighted&&this.clearHighlight();a.addClassName("xhighlight");this.iHighlighted=a;this.killTimeout()},clearHighlight:function(){this.iHighlighted&&(this.iHighlighted.removeClassName("xhighlight"),delete this.iHighlighted)},highlightFirst:function(){if(this.suggest&&this.suggest.down("ul")){var a=this.suggest.down("ul").down("li");a&&this.setHighlight(a)}},hasActiveSelection:function(){return this.iHighlighted},
setHighlightedValue:function(a){if(this.iHighlighted&&!this.iHighlighted.hasClassName("noSuggestion")){var b=function(e){return e.textContent||e.innerText},c=this.iHighlighted.down("img.icon");b={suggest:this,id:b(this.iHighlighted.down(".suggestId")),value:b(this.iHighlighted.down(".suggestValue")),info:b(this.iHighlighted.down(".suggestInfo")),url:b(this.iHighlighted.down(".suggestURL")),icon:c?c.src:"",originalEvent:a};if(""==this.sInput&&""==this.fld.value)var d=c=b.value;else if(this.seps){a=
-1;for(c=0;c<this.seps.length;c++)this.fld.value.lastIndexOf(this.seps.charAt(c))>a&&(a=this.fld.value.lastIndexOf(this.seps.charAt(c)));-1==a?d=c=b.value:(c=this.fld.value.substring(0,a+1)+b.value,d=c.substring(a+1))}else d=c=b.value;a=Event.fire(this.fld,"xwiki:suggest:selected",Object.clone(b));!a.stopped&&(this.sInput=d,this.fld.value=c,this.fld.focus(),this.clearSuggestions(),"function"==typeof this.options.callback&&this.options.callback(Object.clone(b)),0<this.fld.id.indexOf("_suggest")&&(a=
this.fld.id.substring(0,this.fld.id.indexOf("_suggest")),a=$(a)))&&(a.value=b.info)}},killTimeout:function(){clearTimeout(this.toID)},resetTimeout:function(){clearTimeout(this.toID);var a=this;this.toID=setTimeout(function(){a.clearSuggestions()},1E3)},clearSuggestions:function(){this.clearHighlight();this.killTimeout();this.isActive=!1;var a=$(this.container),b=this;a&&a.parentNode&&(this.options.fadeOnClear&&window.Effect?new Effect.Fade(a,{duration:"0.25",afterFinish:function(){$(b.container)&&
$(b.container).remove()}}):$(this.container).remove(),document.fire("xwiki:suggest:clearSuggestions",{suggest:this}))},detach:function(){this.fld&&(Event.stopObserving(this.fld,"keyup",this.onKeyUp),Prototype.Browser.IE||Prototype.Browser.WebKit?Event.stopObserving(this.fld,"keydown",this.onKeyPress):Event.stopObserving(this.fld,"keypress",this.onKeyPress),this.clearSuggestions(),this.fld.__x_suggest=null,this.fld.setAttribute("autocomplete","on"))}});return l}(XWiki||{});

//# sourceMappingURL=suggest.min.js.map
