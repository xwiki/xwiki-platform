'use strict';var XWiki=function(f){if("undefined"===typeof File||"undefined"===typeof FormData||"undefined"===typeof XMLHttpRequest)return f;var d={secondsToTime:function(a){var b=Math.floor(a/3600),c=Math.floor((a-3600*b)/60);a=Math.floor(a-3600*b-60*c);10>b&&(b="0"+b);10>c&&(c="0"+c);10>a&&(a="0"+a);return b+":"+c+":"+a},bytesToSize:function(a){var b=["b","Kb","Mb"];if(0==a)return"n/a";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));c>=b.length&&(c=b.length-1);return(a/Math.pow(1024,c)).toFixed(1)+
" "+b[c]},createDiv:function(a,b){return(new Element("div",{"class":a||""})).update(b||"")},createSpan:function(a,b){return(new Element("span",{"class":a||""})).update(b||"")},createButton:function(a,b){return(new Element("a",{"class":"button secondary",href:"#"})).update(a||"").wrap("span",{"class":"buttonwrapper"}).observe("click",b||Prototype.emptyFunction)}},g=Class.create({initialize:function(a,b,c,e){this.file=a;this.container=b;this.formData=c;this.options=e;this.validate();this.initProgressParameters();
this.generateStatusUI()},validate:function(){if(!this.options.fileFilter.test(this.file.type))throw"INVALID_FILE_TYPE";if(this.file.size>this.options.maxFilesize)throw"UPLOAD_LIMIT_EXCEEDED";},generateStatusUI:function(){var a=this.statusUI={};a.UPLOAD_STATUS=d.createDiv("upload-status upload-inprogress");this.options.enableFileInfo&&(a.FILE_INFO=d.createDiv("file-info"),(a.FILE_NAME=d.createSpan("file-name",this.file.name)).title=this.file.type,a.FILE_SIZE=d.createSpan("file-size"," ("+d.bytesToSize(this.file.size)+
")"),a.FILE_CANCEL=d.createButton("$services.localization.render('core.widgets.html5upload.item.cancel')",this.cancelUpload.bindAsEventListener(this)),a.FILE_INFO.insert(a.FILE_NAME).insert(a.FILE_SIZE).insert(a.FILE_CANCEL),a.UPLOAD_STATUS.insert(a.FILE_INFO));this.options.enableProgressInfo&&(a.PROGRESS_INFO=d.createDiv("progress-info"),a.PROGRESS_CONTAINER=d.createDiv("progress-container"),a.PROGRESS=d.createDiv("progress"),a.PROGRESS_PERCENTAGE=d.createSpan("progress-percentage","&nbsp;"),a.PROGRESS_SPEED=
d.createSpan("progress-speed","&nbsp;"),a.PROGRESS_REMAINING=d.createSpan("progress-remaining","&nbsp;"),a.PROGRESS_TRANSFERED=d.createSpan("progress-transfered","&nbsp;"),a.PROGRESS_INFO.insert(a.PROGRESS_CONTAINER.insert(a.PROGRESS)).insert(a.PROGRESS_PERCENTAGE).insert(a.PROGRESS_TRANSFERED).insert(d.createDiv("progress-time").insert(a.PROGRESS_SPEED).insert(a.PROGRESS_REMAINING).insert(d.createDiv("clearfloats"))),a.UPLOAD_STATUS.insert(a.PROGRESS_INFO));this.options.responseContainer?a.UPLOAD_RESPONSE=
this.options.responseContainer:(a.UPLOAD_RESPONSE=d.createDiv("upload-response"),a.UPLOAD_STATUS.insert(a.UPLOAD_RESPONSE));this.container.insert(a.UPLOAD_STATUS);return a},initProgressParameters:function(){this.progressData={bytesUploaded:0,bytesTotal:0,previousBytesUploaded:0,resultFileSize:"",latestSpeed:0,updatesPerSecond:2,updatesDone:0}},startUploading:function(a){if(this.canceled)this.onUploadAbort();else{a&&a.stop();var b=new FormData;b.append(this.formData.input.name,this.file);var c=this.formData.additionalFields;
Object.keys(c).each(function(e){c[e]&&b.append(e,c[e])});a=this.request=new XMLHttpRequest;this.options.enableProgressInfo&&(a.upload.addEventListener("progress",this.onUploadProgress.bindAsEventListener(this),!1),this.timer=setInterval(this.doInnerUpdates.bind(this),Math.round(1E3/this.progressData.updatesPerSecond)));a.upload.addEventListener("load",this.onUploadFinish.bindAsEventListener(this),!1);a.addEventListener("load",this.onRequestDone.bindAsEventListener(this),!1);a.addEventListener("error",
this.onUploadError.bindAsEventListener(this),!1);a.addEventListener("abort",this.onUploadAbort.bindAsEventListener(this),!1);a.open("POST",this.formData.action);a.send(b)}},cancelUpload:function(a){a&&a.stop();this.completed||(this.request&&this.request.abort(),this.canceled=!0,clearInterval(this.timer),this.statusUI.FILE_CANCEL.addClassName("upload-canceled-label").removeClassName("buttonwrapper").update("$services.localization.render('core.widgets.html5upload.item.canceled')"),this.statusUI.UPLOAD_STATUS.removeClassName("upload-inprogress").addClassName("upload-canceled"))},
doInnerUpdates:function(){this.progressData.updatesDone+=1;var a=this.progressData.updatesDone/this.progressData.updatesPerSecond,b=this.progressData.bytesUploaded,c=b-this.progressData.previousBytesUploaded;0!==c&&(this.progressData.previousBytesUploaded=b,a=(this.progressData.bytesTotal-this.progressData.previousBytesUploaded)/(b/a),c=d.bytesToSize(c*this.progressData.updatesPerSecond)+"/s",this.progressData.latestSpeed=c,this.statusUI.PROGRESS_SPEED.update(c),this.statusUI.PROGRESS_REMAINING.update(" | "+
d.secondsToTime(a)))},onUploadProgress:function(a){if(a.lengthComputable){this.progressData.bytesUploaded=a.loaded;this.progressData.bytesTotal=a.total;a=Math.round(100*a.loaded/a.total);var b=d.bytesToSize(this.progressData.bytesUploaded);this.statusUI.PROGRESS_PERCENTAGE.update(a+"%");this.statusUI.PROGRESS.style.width=a+"%";this.statusUI.PROGRESS_TRANSFERED.update("("+b+")")}else this.statusUI.PROGRESS.update("n/a")},onUploadFinish:function(a){this.completed=!0;clearInterval(this.timer);this.statusUI.FILE_CANCEL&&
this.statusUI.FILE_CANCEL.addClassName("hidden");this.formData.input.fire("xwiki:html5upload:message",{content:"UPLOAD_FINISHING",type:"inprogress",source:this,parameters:{name:this.file.name}})},onRequestDone:function(a){if(a&&a.target&&"number"===typeof a.target.status)if(200<=a.target.status&&300>a.target.status)this.statusUI.UPLOAD_RESPONSE.update(a.target.responseText);else{this.onUploadError();return}this.options.enableProgressInfo&&(this.statusUI.PROGRESS_PERCENTAGE.update("100%"),this.statusUI.PROGRESS.style.width=
"100%",this.statusUI.PROGRESS_REMAINING.update(" | 00:00:00"),this.statusUI.PROGRESS_TRANSFERED.update("("+d.bytesToSize(this.file.size)+")"),0===this.progressData.latestSpeed&&this.statusUI.PROGRESS_SPEED.update(d.bytesToSize(this.file.size)+"/s"));this.formData.input.fire("xwiki:html5upload:message",{content:"UPLOAD_FINISHED",type:"done",source:this,parameters:{name:this.file.name,size:d.bytesToSize(this.file.size)}});this.formData.input.fire("xwiki:html5upload:fileFinished",{source:this});clearInterval(this.timer);
this.statusUI.UPLOAD_STATUS.removeClassName("upload-inprogress").addClassName("upload-done")},onUploadError:function(){this.statusUI.FILE_CANCEL.remove();this.statusUI.UPLOAD_STATUS.removeClassName("upload-inprogress").addClassName("upload-error");this.abnormalUploadFinish("UNKNOWN_ERROR")},onUploadAbort:function(){this.abnormalUploadFinish("UPLOAD_ABORTED")},abnormalUploadFinish:function(a){clearInterval(this.timer);this.formData.input.fire("xwiki:html5upload:message",{content:a,type:"error",source:this,
parameters:{name:this.file.name}});this.formData.input.fire("xwiki:html5upload:fileFinished",{source:this})}});var h=parseInt('$!escapetool.javascript($xwiki.getSpacePreference("upload_maxsize"))');f.FileUploader=Class.create({options:{maxFilesize:h,fileFilter:/.*/i,enableFileInfo:!0,enableProgressInfo:!0,progressAutohide:!1,autoUpload:!0,targetURL:null,responseContainer:null,responseURL:null},messages:{UNKNOWN_ERROR:new Template("$services.localization.render('core.widgets.html5upload.error.unknown', ['#{name}'])"),
INVALID_FILE_TYPE:new Template("$services.localization.render('core.widgets.html5upload.error.invalidType', ['#{name}'])"),UPLOAD_LIMIT_EXCEEDED:new Template("$services.localization.render('core.widgets.html5upload.error.invalidSize', ['#{name}', '#{size}'])"),UPLOAD_ABORTED:new Template("$services.localization.render('core.widgets.html5upload.error.aborted', ['#{name}'])"),UPLOAD_FINISHING:new Template("$services.localization.render('core.widgets.html5upload.status.finishing', ['#{name}'])"),UPLOAD_FINISHED:new Template("$services.localization.render('core.widgets.html5upload.status.finished', ['#{name}', '#{size}'])")},
initialize:function(a,b){this.options=Object.extend(Object.clone(this.options),b||{});!a.__x_html5uploader&&(a.__x_html5uploader=this,"file"==a.type&&(this.input=a,this.inputContainer=this.input.up(".fileupload-field")||this.input,this.form=a.form))&&(a=this.form.down("input[type=hidden][name="+a.name+"__filter]"),!this.options.fileFilter&&a&&""!=a.value&&(this.options.fileFilter=new RegExp(a.value,"i")),this.options.targetURL=this.options.targetURL||this.form.action,this.formData={input:this.input,
action:this.options.targetURL,additionalFields:{}},a=this.form.down("input[name=xredirect]"),this.formData.additionalFields.xredirect=this.options.responseURL||a&&a.value,(a=this.form.down("input[name=form_token]"))&&(this.formData.additionalFields.form_token=a.value),this.onUploadNextFile=this.onUploadNextFile.bindAsEventListener(this),this.input.observe("change",this.onFilesSelected.bindAsEventListener(this)),this.input.observe("xwiki:html5upload:start",this.showUploadStatus.bindAsEventListener(this)),
this.input.observe("xwiki:html5upload:start",this.onUploadNextFile),this.input.observe("xwiki:html5upload:fileFinished",this.onUploadNextFile),this.input.observe("xwiki:html5upload:message",this.onMessage.bindAsEventListener(this)),this.input.observe("xwiki:html5upload:done",this.onUploadDone.bindAsEventListener(this)),this.generateStatusUI())},generateStatusUI:function(){var a=this.statusUI={};a.CONTAINER=d.createDiv("upload-status-container");a.LIST=d.createDiv("upload-status-list");a.CANCEL=d.createButton("$services.localization.render('core.widgets.html5upload.cancelAll')",
this.cancelUpload.bindAsEventListener(this));a.HIDE=d.createButton("$services.localization.render('core.widgets.html5upload.hideStatus')",this.hideUploadStatus.bindAsEventListener(this));a.HIDE.hide();a.CONTAINER.insert(a.LIST).insert(a.CANCEL).insert(a.HIDE)},showUploadStatus:function(){this.inputContainer.insert({after:this.statusUI.CONTAINER});this.statusUI.HIDE.hide();this.statusUI.CANCEL.show()},hideUploadStatus:function(a){a&&a.stop();this.input.value="";this.statusUI.CONTAINER.up()&&this.statusUI.CONTAINER.remove();
this.statusUI.LIST.update("")},onFilesSelected:function(){var a=this.input.files.length;this.fileUploadItems=[];for(var b=0;b<a;++b){var c=this.input.files[b];try{this.fileUploadItems.push(new g(c,this.statusUI.LIST,this.formData,this.options))}catch(e){this.showMessage(e,"error",{size:d.bytesToSize(this.options&&this.options.maxFilesize),name:c.name,type:c.type})}}Event.fire(this.input,"xwiki:html5upload:start")},onUploadNextFile:function(){var a=this.currentUpload=this.fileUploadItems.shift();a?
a.startUploading():Event.fire(this.input,"xwiki:html5upload:done")},cancelUpload:function(a){a&&a.stop();this.fileUploadItems.invoke("cancelUpload");this.currentUpload&&this.currentUpload.cancelUpload();this.input.fire("xwiki:html5upload:done")},onUploadDone:function(){this.statusUI.CANCEL.hide();this.options.progressAutohide?setTimeout(this.hideUploadStatus.bind(this),2E3):this.statusUI.HIDE.show()},onMessage:function(a){a.memo&&a.memo.source&&a.memo.content&&(a.memo.source._currentMessage&&a.memo.source._currentMessage.hide(),
a.memo.source._currentMessage=this.showMessage(a.memo.content,a.memo.type,a.memo.parameters))},showMessage:function(a,b,c){a=this.messages[a]||a;a instanceof Template&&(a=a.evaluate(c||{}));return new f.widgets.Notification(a,b||"plain")},hideFormButtons:function(){if(!this.form.hasClassName("html5upload-initialized")){this.form.addClassName("html5upload-initialized");this.options.autoUpload&&this.form.select("input[type=submit]").invoke("hide");var a=this.form.down(".cancel");a&&a.hide()}}});return f}(XWiki||
{});

//# sourceMappingURL=upload.min.js.map
