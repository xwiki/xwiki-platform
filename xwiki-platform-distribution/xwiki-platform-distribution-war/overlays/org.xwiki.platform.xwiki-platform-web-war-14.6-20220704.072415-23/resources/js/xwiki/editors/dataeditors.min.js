'use strict';var XWiki=function(e){function m(){require(["scriptaculous/dragdrop"],function(){new n.XDataEditors});return!0}var n=e.editors=e.editors||{};n.XDataEditors=Class.create({editorStatus:{savedXObjects:{},addedXObjects:{},deletedXObjects:{}},initialize:function(){this.editedDocument=e.currentDocument;$$(".xclass").each(function(a){this.enhanceClassUX(a,!0)}.bind(this));this.ajaxObjectAdd($("add_xobject"));this.ajaxPropertyAdd();this.makeSortable($("xwikiclassproperties"));this.ajaxRemoveDeprecatedProperties($("body"),
".syncAllProperties");document.observe("xwiki:document:saved",function(a){$$("input[name=deletedObjects]").each(function(c){c.remove()});$$("input[name=addedObjects]").each(function(c){c.remove()});$$(".xobject-action.edit").invoke("show");$$(".xobject").each(function(c){c.down("a.delete").show()});for(var b in this.editorStatus.addedXObjects)void 0===this.editorStatus.savedXObjects[b]?this.editorStatus.savedXObjects[b]=this.editorStatus.addedXObjects[b]:(this.editorStatus.savedXObjects[b].concat(this.editorStatus.addedXObjects[b]),
this.editorStatus.savedXObjects[b].sort(this.numberSort));this.editorStatus.addedXObjects={};this.editorStatus.deletedXObjects={}}.bindAsEventListener(this));document.observe("xwiki:actions:cancel",function(a){$$("input[name=deletedObjects]").each(function(b){b.remove()});$$("input[name=addedObjects]").each(function(b){b.remove()});this.editorStatus.addedXObjects={};this.editorStatus.deletedXObjects={}}.bindAsEventListener(this));window.addEventListener("beforeunload",function(a){if(0<Object.keys(this.editorStatus.addedXObjects).length||
0<Object.keys(this.editorStatus.deletedXObjects).length)a.preventDefault(),a.returnValue=""}.bind(this))},numberSort:function(a,b){return a-b},getXClassNameFromXClassId:function(a){return a.substring(7)},getXClassNameFromXObjectId:function(a){return a.substring(8,a.lastIndexOf("_"))},getXObjectNumberFromXObjectId:function(a){return a.substring(a.lastIndexOf("_")+1)},xObjectAlreadyExist:function(a,b){return void 0!==this.editorStatus.savedXObjects[a]&&-1!==this.editorStatus.savedXObjects[a].indexOf(b)||
void 0!==this.editorStatus.addedXObjects[a]&&-1!==this.editorStatus.addedXObjects[a].indexOf(b)},getXObject:function(a,b){a="xobject_"+a+"_"+b;b=$$(".xobject");for(var c=0;c<b.length;c++)if(b[c].id===a)return b[c]},getDeletedXObject:function(a,b){a="deletedObject_"+a+"_"+b;b=$$("input[name=deletedObjects]");for(var c=0;c<b.length;c++)if(b[c].id===a)return b[c]},removeElementFromArray:function(a,b){-1!==a.indexOf(b)&&a.splice(a.indexOf(b),1)},getNewObjectNumber:function(a){var b=void 0!==this.editorStatus.addedXObjects[a]?
Number(this.editorStatus.addedXObjects[a].last())+1:void 0!==this.editorStatus.savedXObjects[a]?Number(this.editorStatus.savedXObjects[a].last())+1:0;b+="";var c=this.editorStatus.deletedXObjects[a];void 0!==c&&-1!==c.indexOf(b)&&(this.getDeletedXObject(a,b).remove(),this.removeElementFromArray(c,b),0===c.length&&delete this.editorStatus.deletedXObjects[a]);return b},enhanceClassUX:function(a,b){this.ajaxObjectAdd(a);this.expandCollapseClass(a);a.select(".xproperty").each(function(c){this.expandCollapseMetaProperty(c);
this.ajaxPropertyDeletion(c);this.makeDisableVisible(c)}.bind(this));a.select(".xobject").each(function(c){this.enhanceObjectUX(c,b)}.bind(this))},enhanceObjectUX:function(a,b){var c=this.getXClassNameFromXObjectId(a.id),g=this.getXObjectNumberFromXObjectId(a.id);if(b){void 0===this.editorStatus.savedXObjects[c]&&(this.editorStatus.savedXObjects[c]=[]);var h=this.editorStatus.savedXObjects[c]}else void 0===this.editorStatus.addedXObjects[c]&&(this.editorStatus.addedXObjects[c]=[]),h=this.editorStatus.addedXObjects[c];
this.xObjectAlreadyExist(c,g)||(h.push(g),h.sort(this.numberSort),b||(b=new Element("input",{type:"hidden",name:"addedObjects",id:"addedObject_"+c+"_"+g,value:c+"_"+g}),a.appendChild(b)),this.ajaxObjectDeletion(a),this.editButtonBehavior(a),this.expandCollapseObject(a),this.ajaxRemoveDeprecatedProperties(a,".syncProperties"))},ajaxObjectAdd:function(a){a&&a.select(".xobject-add-control").each(function(b){b.observe("click",function(c){b.blur();c.stop();if(b.href){c=b.href.replace(/[?&]xredirect=[^&]*/,
"");var g=!0;var h=this.getXClassNameFromXClassId(b.up(".xclass").id);c+="&objectNumber="+this.getNewObjectNumber(h)}else(c=a.down("select"))&&0<=c.selectedIndex&&(h=c.options[c.selectedIndex].value),g=h&&"-"!=h,c=this.editedDocument.getURL("edit",Object.toQueryString({xpage:"editobject",xaction:"addObject",classname:h,objectNumber:this.getNewObjectNumber(h),form_token:$$("input[name=form_token]")[0].value}));!b.disabled&&g&&new Ajax.Request(c,{onCreate:function(){b.disabled=!0;b.notification=new e.widgets.Notification("$services.localization.render('core.editors.object.add.inProgress')",
"inprogress")},onSuccess:function(f){var d=b.up(".add_xobject");if(d&&(f=this._parseHTMLResponse(f.responseText),d.up(".xclass")?(d.up().insertBefore(f,d),d=d.previous()):(d.up().insertBefore(f,d.nextSibling),d=d.next()),d)){document.fire("xwiki:dom:updated",{elements:[d]});if(d.hasClassName("xclass")){this.enhanceClassUX(d,!1);var k=d.down(".xobject")}else if(d.hasClassName("xobject")){k=d.id.replace(/^xobject_/,"xclass_").replace(/_\d+$/,"");f=this.getXClassNameFromXObjectId(d.id);if(void 0!==this.editorStatus.deletedXObjects[f]){var l=
this.editorStatus.deletedXObjects[f];-1!==l.indexOf(void 0)&&(this.removeElementFromArray(l,void 0),this.getDeletedXObject(f,void 0).remove());0===l.length&&delete this.editorStatus.deletedXObjects[f]}this.enhanceObjectUX(d,!1);if(k=$(k))k.down(".add_xobject").insert({before:d}),this.updateXObjectCount(k);k=d}k.removeClassName("collapsed");k.up(".xclass").removeClassName("collapsed");k.down(".xobject-action.edit").hide()}b.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.object.add.done')",
"done"))}.bind(this),onFailure:function(f){b.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.object.add.failed')"+(f.statusText||"Server not responding"),"error"))},onComplete:function(){b.disabled=!1;require(["xwiki-meta"],function(f){f.refreshVersion()});document.fire("xwiki:dom:refresh")},on0:function(f){f.request.options.onFailure(f)}})}.bindAsEventListener(this))}.bind(this))},_parseHTMLResponse:function(a){var b=new Element("div");b.innerHTML=a;var c=
document.body.previous("head");c&&b.select("link").each(function(g){c.insert(g)});c&&b.select("script").each(function(g){g.src&&c.insert(new Element("script",{type:g.type,src:g.readAttribute("src")}));g.remove()});return this._extractContents(b)},_extractContents:function(a){for(var b=a.ownerDocument.createDocumentFragment();a.firstChild;b.appendChild(a.firstChild));return b},ajaxObjectDeletion:function(a){var b=a.down("a.delete");a=this.getXClassNameFromXObjectId(a.id);var c=this.editorStatus.addedXObjects[a];
void 0!==c&&1<c.length&&this.getXObject(a,c[c.length-2]).down("a.delete").hide();b.observe("click",function(g){b.blur();g.stop();new e.widgets.ConfirmationBox({onYes:function(){if(!b.disabled){var h=b.up("form"),f=b.up(".xobject"),d=this.getXClassNameFromXObjectId(f.id),k=this.getXObjectNumberFromXObjectId(f.id),l=this.editorStatus.addedXObjects[d];void 0===l||-1===l.indexOf(k)?(void 0===this.editorStatus.deletedXObjects[d]&&(this.editorStatus.deletedXObjects[d]=[]),this.editorStatus.deletedXObjects[d].push(k),
this.editorStatus.deletedXObjects[d].sort(this.numberSort),l=new Element("input",{type:"hidden",name:"deletedObjects",id:"deletedObject_"+d+"_"+k,value:d+"_"+k}),h.appendChild(l),this.removeElementFromArray(this.editorStatus.savedXObjects[d],k),0===this.editorStatus.savedXObjects[d].length&&delete this.editorStatus.savedXObjects[d]):(this.removeElementFromArray(l,k),0===l.length?delete this.editorStatus.addedXObjects[d]:this.getXObject(d,l.last()).down("a.delete").show());h=f.up(".xclass");f.remove();
this.updateXObjectCount(h)}}.bind(this)},{confirmationText:"$services.localization.render('core.editors.object.delete.confirmJS')",showCancelButton:!0})}.bindAsEventListener(this))},ajaxRemoveDeprecatedProperties:function(a,b){a&&a.select(b).each(function(c){c.observe("click",function(g){c.blur();g.stop();c.disabled||new Ajax.Request(c.href,{onCreate:function(){c.disabled=!0;c.notification=new e.widgets.Notification("$services.localization.render('core.editors.object.removeDeprecatedProperties.inProgress')",
"inprogress")},onSuccess:function(h){a.select(".deprecatedProperties").invoke("remove");c.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.object.removeDeprecatedProperties.done')","done"))},onFailure:function(h){c.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.object.removeDeprecatedProperties.failed')"+(h.statusText||"Server not responding"),"error"))},onComplete:function(){c.disabled=!1},on0:function(h){h.request.options.onFailure(h)}})})})},
ajaxPropertyAdd:function(){$$("input[name=action_propadd]").each(function(a){a._x_propnameElt=$("propname");a._x_proptypeElt=$("proptype");a._x_form_tokenElt=$("form_token");a.observe("click",function(b){a.blur();b.stop();!a.disabled&&""!=a._x_propnameElt.value&&0<=a._x_proptypeElt.selectedIndex&&(b=this.editedDocument.getURL("edit",Object.toQueryString({xpage:"editclass",xaction:"displayProperty",propName:a._x_propnameElt.value})),b=this.editedDocument.getURL("propadd",Object.toQueryString({propname:a._x_propnameElt.value,
proptype:a._x_proptypeElt.options[a._x_proptypeElt.selectedIndex].value,xredirect:b,form_token:a._x_form_tokenElt.value})),new Ajax.Request(b,{onCreate:function(){a.disabled=!0;a.notification=new e.widgets.Notification("$services.localization.render('core.editors.class.addProperty.inProgress')","inprogress")},onSuccess:function(c){$("xclassContent").insert({bottom:c.responseText});c=$("xclassContent").lastChild;this.expandCollapseMetaProperty(c);this.makeSortable(c);this.ajaxPropertyDeletion(c);this.makeDisableVisible(c);
a.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.class.addProperty.done')","done"))}.bind(this),onFailure:function(c){a.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.class.addProperty.failed') "+c.responseText,"error"))},onComplete:function(){a.disabled=!1},on0:function(c){c.request.options.onFailure(c)}}))}.bindAsEventListener(this))}.bind(this))},ajaxPropertyDeletion:function(a){var b=a.down("a.delete");
b.observe("click",function(c){b.blur();c.stop();b.disabled||new e.widgets.ConfirmedAjaxRequest(b.href,{onCreate:function(){b.disabled=!0},onSuccess:function(){a.remove()},onComplete:function(){b.disabled=!1}},{confirmationText:"$services.localization.render('core.editors.class.deleteProperty.confirm')",progressMessageText:"$services.localization.render('core.editors.class.deleteProperty.inProgress')",successMessageText:"$services.localization.render('core.editors.class.deleteProperty.done')",failureMessageText:"$services.localization.render('core.editors.class.deleteProperty.failed')"})})},
makeDisableVisible:function(a){a.down(".disabletool input").observe("click",function(b){a.toggleClassName("disabled")})},editButtonBehavior:function(a){var b=a.down("a.edit");b&&b.observe("click",function(c){b.blur();c.stop();window.location=b.href}.bindAsEventListener())},updateXObjectCount:function(a){var b=a.select(".xobject").length;0==b?a.remove():(a=a.down(".xclass_xobject_nb"),"undefined"!=typeof a&&a.update("("+b+")"))},expandCollapseObject:function(a){a.addClassName("collapsable");var b=
a.down(".xobject-content");0===b.childElementCount&&a.addClassName("collapsed");var c=a.down(".xobject-title"),g=this.getXClassNameFromXObjectId(a.id),h=this.getXObjectNumberFromXObjectId(a.id);c.observe("click",function(f){0<b.childElementCount||a.hasClassName("loading")?a.toggleClassName("collapsed"):(a.addClassName("loading"),f=this.editedDocument.getURL("edit",Object.toQueryString({xpage:"editobject",xaction:"loadObject",classname:g,objectNumber:h,form_token:$$("input[name=form_token]")[0].value})),
new Ajax.Request(f,{onCreate:function(){a.notification=new e.widgets.Notification("$services.localization.render('core.editors.object.loadObject.inProgress')","inprogress")},onSuccess:function(d){d=this._parseHTMLResponse(d.responseText);b.insertBefore(d,null);a.toggleClassName("collapsed");document.fire("xwiki:dom:updated",{elements:[b]});a.removeClassName("loading");a.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.object.loadObject.done')","done"))}.bind(this),
onFailure:function(d){d=d.statusText||"Server not responding";a.removeClassName("loading");a.notification.replace(new e.widgets.Notification("$services.localization.render('core.editors.object.loadObject.failed') "+d,"error"))},on0:function(d){d.request.options.onFailure(d)}}))}.bindAsEventListener(this))},expandCollapseClass:function(a){var b=a.down(".xclass-title");b&&(a.addClassName("collapsable"),b.observe("click",function(c){b.up().toggleClassName("collapsed")}.bindAsEventListener()))},expandCollapseMetaProperty:function(a){var b=
a.down(".xproperty-title");b&&(a.addClassName("collapsable"),a.addClassName("collapsed"),b.observe("click",function(c){b.up().toggleClassName("collapsed")}.bindAsEventListener()))},makeSortable:function(a){a&&(a.select(".xproperty-content").each(function(b){b.select("input").each(function(c){c.id.endsWith("_number")&&(b.numberProperty=c,c.up().hide(),c.up().previous("dt")&&c.up().previous("dt").hide())})}),a.select(".xproperty-title .tools").each(function(b){var c=(new Element("span",{"class":"tool move",
title:"Drag and drop to change the order"})).update("move");b.makePositioned();b.appendChild(c);c.observe("click",function(g){g.stop()}.bindAsEventListener())}),Sortable.create($("xclassContent"),{tag:"div",only:"xproperty",handle:"move",starteffect:this.startDrag.bind(this),endeffect:this.endDrag.bind(this),onUpdate:this.updateOrder.bind(this)}))},updateOrder:function(a){a=a.childElements();for(var b=0;b<a.length;++b)a[b].down(".xproperty-content").numberProperty.value=b+1},startDrag:function(a){a.addClassName("dragged");
$("xclassContent").childElements().each(function(b){b._expandedBeforeDrag=!b.hasClassName("collapsed");b.addClassName("collapsed")})},endDrag:function(a){a.removeClassName("dragged");$("xclassContent").childElements().each(function(b){b._expandedBeforeDrag&&b.removeClassName("collapsed")})}});e.domIsLoaded&&m()||document.observe("xwiki:dom:loaded",m);return e}(XWiki||{});
require(["jquery","xwiki-events-bridge"],function(e){e("#switch-xclass").on("change",function(m){if(m=e(m.target).val()){m=XWiki.Model.resolve(m,XWiki.EntityType.DOCUMENT,XWiki.currentDocument.documentReference);var n=(new XWiki.Document(m)).getURL("edit","editor=class"),a=function(){window.self.location=n};new XWiki.widgets.ConfirmationBox({onYes:function(){e(document).trigger("xwiki:actions:save",{"continue":!0,form:e("#propupdate")[0]});e(document).on("xwiki:document:saved",a)},onNo:a},{confirmationText:"$services.localization.render('core.editors.class.switchClass.confirm')",
showCancelButton:!0})}})});

//# sourceMappingURL=dataeditors.min.js.map
