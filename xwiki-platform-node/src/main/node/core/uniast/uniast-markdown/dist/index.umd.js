(function(c,y){typeof exports=="object"&&typeof module<"u"?y(exports,require("mdast-util-gfm-strikethrough"),require("mdast-util-gfm-table"),require("mdast-util-gfm-task-list-item"),require("micromark-extension-gfm-strikethrough"),require("micromark-extension-gfm-table"),require("micromark-extension-gfm-task-list-item"),require("inversify"),require("@xwiki/cristal-fn-utils"),require("@xwiki/cristal-model-api"),require("remark-parse"),require("unified"),require("fast-xml-parser")):typeof define=="function"&&define.amd?define(["exports","mdast-util-gfm-strikethrough","mdast-util-gfm-table","mdast-util-gfm-task-list-item","micromark-extension-gfm-strikethrough","micromark-extension-gfm-table","micromark-extension-gfm-task-list-item","inversify","@xwiki/cristal-fn-utils","@xwiki/cristal-model-api","remark-parse","unified","fast-xml-parser"],y):(c=typeof globalThis<"u"?globalThis:c||self,y(c["cristal_uniast-markdown"]={},c.mdastUtilGfmStrikethrough,c.mdastUtilGfmTable,c.mdastUtilGfmTaskListItem,c.micromarkExtensionGfmStrikethrough,c.micromarkExtensionGfmTable,c.micromarkExtensionGfmTaskListItem,c.inversify,c.cristalFnUtils,c.cristalModelApi,c.remarkParse,c.unified,c.fastXmlParser))})(this,function(c,y,A,M,D,E,F,l,v,p,U,N,q){"use strict";function H(e,t){let r=null;for(const{name:n,match:a}of t){const s=e.indexOf(a);s!==-1&&(r===null||r.offset>s)&&(r={name:n,match:a,offset:s})}return r}function G(){const e=this.data();e.micromarkExtensions??=[],e.fromMarkdownExtensions??=[],e.micromarkExtensions.push(D.gfmStrikethrough(),E.gfmTable(),F.gfmTaskListItem()),e.fromMarkdownExtensions.push(y.gfmStrikethroughFromMarkdown(),A.gfmTableFromMarkdown(),M.gfmTaskListItemFromMarkdown())}var B=Object.getOwnPropertyDescriptor,W=(e,t,r,n)=>{for(var a=n>1?void 0:n?B(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a},X=(e,t)=>(r,n)=>t(r,n,e);let k=class{constructor(e){this.cristalApp=e}get(){const e=this.cristalApp.getWikiConfig().getType();try{return this.cristalApp.getContainer().get("Factory<MarkdownParserConfiguration>",{name:e})()}catch{return{supportFlexmarkInternalLinks:!1}}}};k=W([l.injectable(),X(0,l.inject("CristalApp"))],k);var Z=Object.getOwnPropertyDescriptor,V=(e,t,r,n)=>{for(var a=n>1?void 0:n?Z(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a},b=(e,t)=>(r,n)=>t(r,n,e);let $=class{constructor(e,t,r){this.modelReferenceParserProvider=e,this.modelReferenceHandlerProvider=t,this.parserConfigurationResolver=r}async parseMarkdown(e){const t=N.unified().use(U).use(G).parse(e);try{return{blocks:await Promise.all(t.children.map(n=>this.convertBlock(n)))}}catch(r){return r instanceof Error?r:new Error(String(r))}}async convertBlock(e){switch(e.type){case"paragraph":{const t=await this.collectInlineContent(e.children,{});return t.length===1&&t[0].type==="inlineMacro"?{type:"macroBlock",name:t[0].name,params:t[0].params}:{type:"paragraph",content:t,styles:{}}}case"heading":return{type:"heading",level:v.assertInArray(e.depth,[1,2,3,4,5,6],"Invalid heading depth in markdown parser"),content:await this.collectInlineContent(e.children,{}),styles:{}};case"blockquote":return{type:"quote",content:await Promise.all(e.children.map(t=>this.convertBlock(t))),styles:{}};case"list":return{type:"list",items:await Promise.all(e.children.map(async(t,r)=>({number:e.ordered?(e.start??1)+r:void 0,checked:t.checked??void 0,content:await Promise.all(t.children.map(n=>this.convertBlock(n))),styles:{}}))),styles:{}};case"code":return{type:"code",content:e.value,language:e.lang??void 0};case"table":{const[t,...r]=e.children,n=await Promise.all(t?.children.map(async s=>({headerCell:{content:await this.collectInlineContent(s.children,{}),styles:{}}}))),a=await Promise.all(r.map(async s=>{const i=s.children.map(async o=>({content:await this.collectInlineContent(o.children,{}),styles:{}}));return await Promise.all(i)}));return{type:"table",columns:n,rows:a,styles:{}}}case"image":return{type:"image",...await this.convertImage(e)};case"break":case"thematicBreak":return{type:"break"};case"imageReference":case"linkReference":case"definition":case"footnoteDefinition":case"footnoteReference":case"html":throw new Error("TODO: handle blocks of type "+e.type);case"text":case"delete":case"strong":case"emphasis":case"inlineCode":case"link":case"tableCell":case"tableRow":case"yaml":case"listItem":throw new Error("Unexpected block type in markdown parser: "+e.type);default:v.assertUnreachable(e)}}async convertInline(e,t){switch(e.type){case"image":return[{type:"image",...await this.convertImage(e)}];case"strong":return this.collectInlineContent(e.children,{...t,bold:!0});case"emphasis":return this.collectInlineContent(e.children,{...t,italic:!0});case"delete":return this.collectInlineContent(e.children,{...t,strikethrough:!0});case"inlineCode":return[{type:"text",content:e.value,styles:{}}];case"text":return this.convertText(e.value,t);case"html":case"footnoteReference":case"linkReference":case"imageReference":case"break":throw new Error("TODO: handle inlines of type "+e.type);case"link":return await this.convertLink(e,t);default:v.assertUnreachable(e)}}async convertLink(e,t){let r;if(this.supportFlexmark())r={type:"external",url:e.url};else try{r={type:"internal",parsedReference:await this.modelReferenceParserProvider.get().parseAsync(e.url),rawReference:e.url}}catch(a){console.debug("Error parsing reference: ",a),r={type:"external",url:e.url}}return[{type:"link",content:(await this.collectInlineContent(e.children,t)).map(a=>{if(a.type!=="text")throw new Error("Unexpected link inside link in markdown parser");return a}),target:r}]}async convertImage(e){let t;const r=e.url;try{t={type:"internal",parsedReference:await this.modelReferenceParserProvider.get().parseAsync(r,{type:p.EntityType.ATTACHMENT}),rawReference:r}}catch{t={type:"external",url:r}}return{target:t,caption:void 0,alt:e.alt??void 0,styles:{}}}convertText(e,t){const r=[];let n=0;for(;;){const s=[...this.supportFlexmark()?[{name:"image",match:"![["},{name:"link",match:"[["}]:[],{name:"macro",match:"{{"}],i=H(e.substring(n),s);if(!i)break;const o=n+i.offset,m=e.substring(0,o).match(/\\+/);if(!(m&&m[0].length%2!==0))switch(e.substring(n,o).length>0&&r.push({type:"text",content:e.substring(n,o),styles:t}),i.name){case"image":case"link":{n=this.handleLinkOrImage(i,o,e,n,t,r);break}case"macro":{n=this.handleMacro(i,o,e,n,r);break}default:v.assertUnreachable(i.name)}}return e.substring(n).length>0&&r.push({type:"text",content:e.substring(n),styles:t}),r}handleLinkOrImage(e,t,r,n,a,s){const i=e.name==="image";let o,m=!1,u=!1,g=!1;for(o=t+e.match.length;o<r.length;o++){if(m){m=!1;continue}const x=r.charAt(o);if(x==="\\"){m=!0;continue}if(x==="]"){if(u){g=!0;break}u=!0}}if(!g)return n;n=o+1;const f=r.substring(t+e.match.length,o-1);let d,h;const z=f.indexOf("|");z!==-1?(d=f.substring(0,z),h=f.substring(z+1)):(d=null,h=f);let w;try{w=this.modelReferenceParserProvider.get().parse(h,{type:i?p.EntityType.ATTACHMENT:p.EntityType.DOCUMENT})}catch{w=null}const O={type:"internal",rawReference:h,parsedReference:w};d??=w?this.modelReferenceHandlerProvider.get().getTitle(w):"<invalid reference>";const ye=i?{type:"image",target:O,styles:{alignment:"left"},alt:d}:{type:"link",target:O,content:[{type:"text",content:d,styles:a}]};return s.push(ye),n}handleMacro(e,t,r,n,a){const s=r.substring(t+e.match.length).match(/\s*([A-Za-zÀ-ÖØ-öø-ÿ\d]+)(\s+(?=[A-Za-zÀ-ÖØ-öø-ÿ\d/])|(?=\/))/);if(!s)return n=t+e.match.length,a.push({type:"text",content:e.match,styles:{}}),n;const i=s[1];let o,m=!1,u=null;const g={};let f=!1;for(o=t+e.match.length+s[0].length;o<r.length;o++){if(m){if(!u||u.value===null)throw new Error("Unexpected");m=!1,u.value+=r[o];continue}if(!u){if(r[o]===" ")continue;if(r[o].match(/[A-Za-zÀ-ÖØ-öø-ÿ_\d]/)){u={name:r[o],value:null};continue}if(r[o]==="/"){f=!0;break}break}if(u.value===null){if(r[o].match(/[A-Za-zÀ-ÖØ-öø-ÿ_\d]/)){u.name+=r[o];continue}if(r[o]==="="){if(r[o+1]==='"'){o+=1,u.value="";continue}const h=r.substring(o+1).match(/\d+(?=[^A-Za-zÀ-ÖØ-öø-ÿ\d])/);if(!h)break;g[u.name]=h[0],u=null,o+=h[0].length;continue}break}r[o]==="\\"?m=!0:r[o]==='"'?(g[u.name]=u.value,u=null):u.value+=r[o]}const d=r.substring(o).match(/\s*}}/);return!f||!d?(n=t+e.match.length,a.push({type:"text",content:e.match,styles:{}})):(n=o+1+d[0].length,a.push({type:"inlineMacro",name:i,params:g})),n}supportFlexmark(){return this.parserConfigurationResolver.get().supportFlexmarkInternalLinks}async collectInlineContent(e,t={}){return(await Promise.all(e.map(r=>this.convertInline(r,t)))).flat()}};$=V([l.injectable(),b(0,l.inject("ModelReferenceParserProvider")),b(1,l.inject("ModelReferenceHandlerProvider")),b(2,l.inject("ParserConfigurationResolver"))],$);var J=Object.getOwnPropertyDescriptor,K=(e,t,r,n)=>{for(var a=n>1?void 0:n?J(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a},Q=(e,t)=>(r,n)=>t(r,n,e);let I=class{constructor(e){this.cristalApp=e}async get(){const e=this.cristalApp.getWikiConfig().getType();try{return(await this.cristalApp.getContainer().getAsync("Factory<InternalLinksSerializer>",{name:e}))()}catch(t){throw console.debug(t),new Error(`Could not resolve serializer for type ${e}`)}}};I=K([l.injectable(),Q(0,l.inject("CristalApp"))],I);var Y=Object.getOwnPropertyDescriptor,ee=(e,t,r,n)=>{for(var a=n>1?void 0:n?Y(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a},te=(e,t)=>(r,n)=>t(r,n,e);let R=class{constructor(e){this.internalLinksSerializerResolver=e}async toMarkdown(e){const{blocks:t}=e,r=[];for(const n of t){const a=v.tryFallibleOrError(()=>this.blockToMarkdown(n));if(a instanceof Error)return a;r.push(a)}return(await Promise.all(r)).join(`

`)}async blockToMarkdown(e){switch(e.type){case"paragraph":return this.convertInlineContents(e.content);case"heading":return`${"#".repeat(e.level)} ${await this.convertInlineContents(e.content)}`;case"list":return(await Promise.all(e.items.map(t=>this.convertListItem(t)))).join(`
`);case"quote":{const t=e.content.map(r=>this.blockToMarkdown(r)).flatMap(async r=>(await r).split(`
`)).flatMap(async r=>(await r).map(a=>`> ${a}`).join(`
`));return(await Promise.all(t)).join(`
`)}case"code":return`\`\`\`${e.language??""}
${e.content}
\`\`\``;case"table":return this.convertTable(e);case"image":return this.convertImage(e);case"break":return"---";case"macroBlock":return this.convertMacro(e.name,e.params)}}async convertListItem(e){let t=e.number!==void 0?`${e.number}. `:"* ";e.checked!==void 0&&(t+=`[${e.checked?"x":" "}] `);const r=[];for(const n of e.content){const s=(await this.blockToMarkdown(n)).split(`
`);r.push(s.map((i,o)=>(o>0?" ".repeat(t.length):"")+i).join(`
`))}return`${t}${r.join(`
`)}`}async convertImage(e){return e.target.type==="external"?`![${e.alt??""}](${e.target.url})`:await(await this.internalLinksSerializerResolver.get()).serializeImage(e.target,e.alt)}async convertTable(e){const{columns:t,rows:r}=e,n=[(await Promise.all(t.map(a=>a.headerCell?this.convertTableCell(a.headerCell):""))).join(" | "),t.map(()=>" - ").join(" | ")];for(const a of r)n.push((await Promise.all(a.map(s=>this.convertTableCell(s)))).join(" | "));return n.map(a=>`| ${a} |`).join(`
`)}convertTableCell(e){return this.convertInlineContents(e.content)}async convertInlineContents(e){return(await Promise.all(e.map(t=>this.convertInlineContent(t)))).join("")}async convertInlineContent(e){switch(e.type){case"text":return this.convertText(e);case"image":return this.convertImage(e);case"link":return this.convertLink(e);case"inlineMacro":return this.convertMacro(e.name,e.params)}}async convertLink(e){switch(e.target.type){case"external":return`[${await this.convertInlineContents(e.content)}](${e.target.url})`;case"internal":return(await this.internalLinksSerializerResolver.get()).serialize(e.content,e.target,this)}}convertMacro(e,t){return`{{${e}${Object.entries(t).map(([r,n])=>` ${r}="${n.toString().replace(/\\/g,"\\\\\\").replace(/"/g,'\\\\"')}"`).join("")} /}}`}convertText(e){const{content:t,styles:r}=e,{bold:n,italic:a,strikethrough:s,code:i}=r,o=[];return i&&o.push("`"),s&&o.push("~~"),a&&o.push("_"),n&&o.push("**"),`${o.join("")}${t}${o.reverse().join("")}`}};R=ee([l.injectable(),te(0,l.inject("InternalLinksSerializerResolver"))],R);const L="MarkdownToUniAstConverter",j="UniAstToMarkdownConverter";class re{constructor(t){t.bind(L).to($).whenDefault(),t.bind(j).to(R).whenDefault(),t.bind("InternalLinksSerializerResolver").to(I),this.initXWikiFactory(t),this.initNextcloudFactory(t),this.initGitHubFactory(t),this.initFileSystemFactory(t),t.bind("ParserConfigurationResolver").to(k).whenDefault(),t.bind("Factory<MarkdownParserConfiguration>").toFactory(()=>()=>({supportFlexmarkInternalLinks:!0})).whenNamed("XWiki")}initXWikiFactory(t){const r="XWiki";t.bind("Factory<InternalLinksSerializer>").toFactory(n=>async()=>{const a=(await Promise.resolve().then(()=>se)).XWikiInternalLinkSerializer;return this.bindAndLoad(t,r,a,n)}).whenNamed(r)}initNextcloudFactory(t){const r="Nextcloud";t.bind("Factory<InternalLinksSerializer>").toFactory(n=>async()=>{const a=(await Promise.resolve().then(()=>ce)).NextcloudInternalLinkSerializer;return this.bindAndLoad(t,r,a,n)}).whenNamed(r)}initGitHubFactory(t){const r="GitHub";t.bind("Factory<InternalLinksSerializer>").toFactory(n=>async()=>{const a=(await Promise.resolve().then(()=>pe)).GitHubInternalLinkSerializer;return this.bindAndLoad(t,r,a,n)}).whenNamed(r)}initFileSystemFactory(t){const r="FileSystem";t.bind("Factory<InternalLinksSerializer>").toFactory(n=>async()=>{const a=(await Promise.resolve().then(()=>ge)).FilesystemInternalLinkSerializer;return this.bindAndLoad(t,r,a,n)}).whenNamed(r)}bindAndLoad(t,r,n,a){return t.isBound("InternalLinksSerializer",{name:r})||t.bind("InternalLinksSerializer").to(n).whenNamed(r),a.get("InternalLinksSerializer",{name:r})}}var ne=Object.getOwnPropertyDescriptor,ae=(e,t,r,n)=>{for(var a=n>1?void 0:n?ne(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a};let P=class{async serialize(e,t,r){return`[[${await r.convertInlineContents(e)}|${t.rawReference}]]`}async serializeImage(e,t){return`![[${t??""}${t?"|":""}${e.rawReference}]]`}};P=ae([l.injectable()],P);const se=Object.freeze(Object.defineProperty({__proto__:null,get XWikiInternalLinkSerializer(){return P}},Symbol.toStringTag,{value:"Module"}));var ie=Object.getOwnPropertyDescriptor,oe=(e,t,r,n)=>{for(var a=n>1?void 0:n?ie(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a},T=(e,t)=>(r,n)=>t(r,n,e);let C=class{constructor(e,t,r){this.remoteURLSerializerProvider=e,this.cristalApp=t,this.documentService=r}async serialize(e,t,r){const n=await r.convertInlineContents(e),a=this.remoteURLSerializerProvider.get().serialize(t.parsedReference??void 0),s=await fetch(a,{method:"PROPFIND",body:`<?xml version="1.0" encoding="UTF-8"?>
 <d:propfind xmlns:d="DAV:">
   <d:prop xmlns:oc="http://owncloud.org/ns">
    <oc:fileid/>
   </d:prop>
 </d:propfind>`,headers:{Authorization:`Basic ${btoa("admin:admin")}`}}),o=new q.XMLParser().parse(await s.text())["d:multistatus"]["d:response"]["d:propstat"]["d:prop"]["oc:fileid"],u=`${this.cristalApp.getWikiConfig().baseURL}/f/${o}`;return`[${n}](${u})`}async serializeImage(e,t){let r;if(e.parsedReference){const n=this.documentService.getCurrentDocumentReference().value;if(e.parsedReference.type==p.EntityType.ATTACHMENT){const a=e.parsedReference,s=a.document;if(n===s)r=`.${s.name}/attachments/${a.name}`;else{const i=[...n.space&&n.space.names.length>0?n.space.names.map(()=>".."):["."]].join("/"),o=[...a.document.space?.names??[],"."+a.document.name].map(encodeURI).join("/");r=`${i}/${o}/attachments/${encodeURI(a.name)}`}}else throw new Error(`Unexpected type ${e.parsedReference.type} for link serialization`)}else r=e.rawReference;return`![${t??""}](${r})`}};C=oe([l.injectable(),T(0,l.inject("RemoteURLSerializerProvider")),T(1,l.inject("CristalApp")),T(2,l.inject("DocumentService"))],C);const ce=Object.freeze(Object.defineProperty({__proto__:null,get NextcloudInternalLinkSerializer(){return C}},Symbol.toStringTag,{value:"Module"}));var le=Object.getOwnPropertyDescriptor,ue=(e,t,r,n)=>{for(var a=n>1?void 0:n?le(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a},me=(e,t)=>(r,n)=>t(r,n,e);let _=class{constructor(e){this.documentService=e}async serialize(e,t,r){const n=await r.convertInlineContents(e),a=this.computeRef(t);return`[${n}](${a})`}async serializeImage(e,t){const r=this.computeRef(e);return`![${t??""}](${r})`}computeRef(e){if(e.parsedReference){const t=this.documentService.getCurrentDocumentReference().value;let r=e.parsedReference;const n=r.type===p.EntityType.ATTACHMENT;if(n)r=r.document;else if(r.type!==p.EntityType.DOCUMENT)throw new Error(`Unexpected type ${r.type} for link serialization`);const a=[...t.space&&t.space.names.length>0?t.space.names.map(()=>".."):["."]].join("/"),s=(n?".":"")+r.name,i=[...r.space?.names??[],s].map(encodeURI).join("/");return n?`${a}/${i}/attachments/${encodeURI(e.parsedReference.name)}`.replace(/^\.\//,""):`${a}/${i}.md`.replace(/^\.\//,"")}else return e.rawReference}};_=ue([l.injectable(),me(0,l.inject("DocumentService"))],_);const pe=Object.freeze(Object.defineProperty({__proto__:null,get GitHubInternalLinkSerializer(){return _}},Symbol.toStringTag,{value:"Module"}));var de=Object.getOwnPropertyDescriptor,he=(e,t,r,n)=>{for(var a=n>1?void 0:n?de(t,r):t,s=e.length-1,i;s>=0;s--)(i=e[s])&&(a=i(a)||a);return a},fe=(e,t)=>(r,n)=>t(r,n,e);let S=class{constructor(e){this.documentService=e}async serialize(e,t,r){return`[${`${await r.convertInlineContents(e)}`}](${this.serializeTarget(t)})`}async serializeImage(e,t){return`![${t??""}](${this.serializeTarget(e)})`}serializeTarget(e){if(e.parsedReference){const t=this.documentService.getCurrentDocumentReference().value;let r=e.parsedReference;const n=r.type===p.EntityType.ATTACHMENT;if(n)r=r.document;else if(r.type!==p.EntityType.DOCUMENT)throw new Error(`Unexpected type ${r.type} for link serialization`);const a=[...t.space&&t.space.names.length>0?t.space.names.map(()=>".."):["."]].join("/"),s=(n?".":"")+r.name,i=[...r.space?.names??[],s].map(encodeURI).join("/");return n?`${a}/${i}/attachments/${encodeURI(e.parsedReference.name)}`.replace(/^\.\//,""):`${a}/${i}.md`.replace(/^\.\//,"")}else return e.rawReference}};S=he([l.injectable(),fe(0,l.inject("DocumentService"))],S);const ge=Object.freeze(Object.defineProperty({__proto__:null,get FilesystemInternalLinkSerializer(){return S}},Symbol.toStringTag,{value:"Module"}));c.ComponentInit=re,c.markdownToUniAstConverterName=L,c.uniAstToMarkdownConverterName=j,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=index.umd.js.map
