/*
 #set ($paths = {
  'gadgetWizard': $xwiki.getSkinFile('uicomponents/dashboard/gadgetWizard.js', true)
})
#set ($l10nKeys = [
  'dashboard.actions.edit.differentsource.information',
  'dashboard.actions.edit.differentsource.warning',
  'dashboard.gadget.actions.drop',
  'dashboard.gadget.actions.delete.tooltip',
  'dashboard.gadget.actions.edit.tooltip',
  'dashboard.actions.add.tooltip',
  'dashboard.actions.add.button',
  'dashboard.actions.add.loading',
  'dashboard.actions.add.failed',
  'dashboard.gadget.actions.edit.error.notmacro',
  'dashboard.gadget.actions.edit.error.notmacro.title',
  'dashboard.gadget.actions.edit.loading',
  'dashboard.gadget.actions.edit.failed',
  'dashboard.gadget.actions.delete.confirm',
  'dashboard.gadget.actions.delete.inProgress',
  'dashboard.gadget.actions.delete.done',
  'dashboard.gadget.actions.delete.failed',
  'dashboard.actions.columns.add.tooltip',
  'dashboard.actions.columns.add.button',
  'dashboard.actions.edit.failed',
  'dashboard.actions.save.loading'
])
#set ($l10n = {})
#foreach ($key in $l10nKeys)
  #set ($discard = $l10n.put($key, $services.localization.render($key)))
#end
#[[*/
'use strict';(function(k,e){function h(){if("inline"==XWiki.contextaction||"edit"==XWiki.contextaction&&$("inline")){var a=$$(".dashboard")[0];a&&require(["scriptaculous/dragdrop"],function(){new XWiki.Dashboard(a)})}return!0}require.config({paths:k});window.XWiki=window.XWiki||{};XWiki.Dashboard=Class.create({initialize:function(a){this.element=a;this.gadgetsClass="XWiki.GadgetClass";this.readMetadata();this.displayWarning();this.edited=!1;this.removed=[];this.element.addClassName("dashboard-edit");
this.containers=a.select(".gadget-container");this.createDragAndDrops();this.addGadgetsHandlers();this.addNewGadgetHandler();this.addNewContainerHandler();document.observe("xwiki:actions:beforeSave",this.saveChanges.bindAsEventListener(this))},readMetadata:function(){this.editURL=this.element.down(".metadata .editurl").readAttribute("href");this.removeURL=this.element.down(".metadata .removeurl").readAttribute("href");this.addURL=this.element.down(".metadata .addurl").readAttribute("href");this.sourcePage=
this.element.down(".metadata .sourcepage").innerHTML;this.sourceSpace=this.element.down(".metadata .sourcespace").innerHTML;this.sourceWiki=this.element.down(".metadata .sourcewiki").innerHTML;this.sourceURL=this.element.down(".metadata .sourceurl").readAttribute("href")},displayWarning:function(){if(XWiki.currentDocument.page!=this.sourcePage||XWiki.currentDocument.space!=this.sourceSpace||XWiki.currentDocument.wiki!=this.sourceWiki){var a=new Element("div",{"class":"box warningmessage differentsource"}),
b=e["dashboard.actions.edit.differentsource.information"],d=e["dashboard.actions.edit.differentsource.warning"],c=new Element("a",{href:this.sourceURL});c.update(this.sourceWiki+":"+this.sourceSpace+"."+this.sourcePage);a.insert(b);a.insert(c);a.insert(d);this.element.insert({top:a})}},_getContainerId:function(a){return a.readAttribute("id").substring(16)},_getGadgetId:function(a){return a.readAttribute("id").substring(7)},_getMacroCallComment:function(a){return"\x3c!--"+a+"--\x3e\x3c!--stopmacro--\x3e"},
_parseMacroCallComment:function(a){var b=a.indexOf("--\x3e");return a.startsWith("\x3c!--startmacro:")&&0<b?a.substr(4,b-4):null},_insertPlaceholder:function(a){if(!a.down(".gadget")&&!a.down(".gadget-placeholder")){var b=(new Element("div",{"class":"gadget-placeholder"})).update(e["dashboard.gadget.actions.drop"]);a.insert(b)}},_removePlaceholder:function(a){a.select(".gadget-placeholder").each(function(b){b.remove()})},_doOnStartDrag:function(){this.containers.each(this._insertPlaceholder)},_doOnEndDrag:function(){this.containers.each(this._removePlaceholder)},
createDragAndDrops:function(){var a=[];this.containers.each(function(b){a.push(b.readAttribute("id"))});a.each(function(b){this.makeSortable(b,a,this.onMoveGadget.bind(this))}.bind(this));Draggables.addObserver({onStart:this._doOnStartDrag.bind(this),onEnd:this._doOnEndDrag.bind(this)})},makeSortable:function(a,b,d){Sortable.create(a,{tag:"div",only:"gadget",handle:"gadget-title",overlap:"vertical",scroll:window,containment:b,dropOnEmpty:!0,constraint:!1,ghosting:!1,hoverclass:"gadget-container-hover-highlight",
onUpdate:d})},addGadgetsHandlers:function(){this.element.select(".gadget").each(this.addGadgetHandlers.bind(this))},addGadgetHandlers:function(a){var b=new Element("span",{"class":"remove action",title:e["dashboard.gadget.actions.delete.tooltip"]});b.observe("click",this.onRemoveGadget.bindAsEventListener(this));var d=new Element("span",{"class":"edit action",title:e["dashboard.gadget.actions.edit.tooltip"]});d.observe("click",this.onEditGadgetClick.bindAsEventListener(this));var c=new Element("div",
{"class":"gadget-actions"});c.insert(d);c.insert(b);a.insert(c)},addNewGadgetHandler:function(){var a=new Element("div",{"class":"addgadget",title:e["dashboard.actions.add.tooltip"]});a.update(e["dashboard.actions.add.button"]);a.observe("click",this.onAddGadgetClick.bindAsEventListener(this));var b=this.element.down(".differentsource");b?b.insert({after:a}):this.element.insert({top:a});a.insert({after:new Element("div",{"class":"clearfloats"})})},onAddGadgetClick:function(a){this.runGadgetWizard($(a.target),
null,this.onAddGadgetComplete.bind(this))},runGadgetWizard:function(a,b,d){a.hasClassName("loading")||(a.addClassName("loading"),require(["gadgetWizard"],function(c){c(b).then(d).finally(()=>{a.removeClassName("loading")})}))},onAddGadgetComplete:function(a){var b=this._getMacroCallComment(a.content),d=this.containers.length,c=this.containers.last().select(".gadget").length+1,f=new Hash;f.set("classname",this.gadgetsClass);f.set(this.gadgetsClass+"_title",a.title);f.set(this.gadgetsClass+"_content",
b);f.set("RequiresHTMLConversion",this.gadgetsClass+"_content");f.set(this.gadgetsClass+"_content_syntax","xwiki/2.0");f.set(this.gadgetsClass+"_position",d+", "+c);a=this.getFormToken();f.set("form_token",a);this._x_notification=new XWiki.widgets.Notification(e["dashboard.actions.add.loading"],"inprogress");new Ajax.Request(this.addURL,{parameters:f,onSuccess:function(g){window.location.reload()}.bind(this),onFailure:function(g){this._x_notification.replace(new XWiki.widgets.Notification(e["dashboard.actions.add.failed"]+
(g.statusText||"Server not responding"),"error",{timeout:5}))}.bind(this),on0:function(g){g.request.options.onFailure(g)}.bind(this)})},onEditGadgetClick:function(a){var b=a.element().up(".gadget");if(b){var d=b.down(".metadata");if(d){var c=d.down(".isMacro");if(c&&"true"==c.innerHTML){var f=this._getGadgetId(b),g;if(b=d.down(".title"))var l=b.innerHTML;(d=d.down(".content"))&&(g=this._parseMacroCallComment(d.innerHTML));this.runGadgetWizard($(a.target),{title:l,content:g},function(m){this.onEditGadgetComplete(f,
m)}.bind(this))}else(new XWiki.widgets.ModalPopup(e["dashboard.gadget.actions.edit.error.notmacro"],{},{title:e["dashboard.gadget.actions.edit.error.notmacro.title"]})).showDialog()}}},onEditGadgetComplete:function(a,b){var d=this._getMacroCallComment(b.content),c=new Hash;c.set(this.gadgetsClass+"_"+a+"_title",b.title);c.set(this.gadgetsClass+"_"+a+"_content",d);c.set("RequiresHTMLConversion",this.gadgetsClass+"_"+a+"_content");c.set(this.gadgetsClass+"_"+a+"_content_syntax","xwiki/2.0");c.set("ajax",
"1");a=this.getFormToken();c.set("form_token",a);this._x_notification=new XWiki.widgets.Notification(e["dashboard.gadget.actions.edit.loading"],"inprogress");new Ajax.Request(this.editURL,{parameters:c,onSuccess:function(f){window.location.reload()}.bind(this),onFailure:function(f){this._x_notification.replace(new XWiki.widgets.Notification(e["dashboard.gadget.actions.edit.failed"]+(f.statusText||"Server not responding"),"error",{timeout:5}))}.bind(this),on0:function(f){f.request.options.onFailure(f)}.bind(this)})},
onRemoveGadget:function(a){var b=a.element(),d=b.up(".gadget");d&&(a=this._getGadgetId(d),this.removed.push(a),new XWiki.widgets.ConfirmedAjaxRequest(this.removeURL,{parameters:{classname:encodeURIComponent(this.gadgetsClass),classid:encodeURIComponent(a),ajax:"1",form_token:this.getFormToken()},onCreate:function(){b.disabled=!0},onSuccess:function(c){d.remove()}.bind(this)},{confirmationText:e["dashboard.gadget.actions.delete.confirm"],progressMessageText:e["dashboard.gadget.actions.delete.inProgress"],
successMessageText:e["dashboard.gadget.actions.delete.done"],failureMessageText:e["dashboard.gadget.actions.delete.failed"]}))},addNewContainerHandler:function(){var a=new Element("div",{"class":"addcontainer",title:e["dashboard.actions.columns.add.tooltip"]});a.update(e["dashboard.actions.columns.add.button"]);a.observe("click",this.onAddColumn.bindAsEventListener(this));this.element.down(".addgadget").insert({before:a})},onAddColumn:function(a){a=this.containers.last();var b=this._getContainerId(a);
b="gadgetcontainer_"+(1+parseInt(b,10));b=new Element("div",{"class":a.readAttribute("class"),id:b});a.removeClassName("last-column");a.insert({after:b});this.containers.push(b);b="container-columns-"+(this.containers.length-1);a=a.parentNode;a.addClassName("container-columns-"+this.containers.length);a.removeClassName(b);var d=[];this.containers.each(function(c){d.push(c.readAttribute("id"))});this.createDragAndDrops()},doEditGadgets:function(a){var b=this.prepareEditParameters();b.set("ajax","1");
var d=this.getFormToken();b.set("form_token",d);new Ajax.Request(this.editURL,{parameters:b,onSuccess:function(c){this.edited=!1;c.responseJSON&&c.responseJSON.newVersion?require(["xwiki-meta"],function(f){f.setVersion(c.responseJSON.newVersion);a&&a()}):a&&a()}.bind(this),onFailure:function(c){this._x_notification=new XWiki.widgets.Notification(e["dashboard.actions.edit.failed"]+(c.statusText||"Server not responding"),"error",{timeout:5});a&&a()}.bind(this),on0:function(c){c.request.options.onFailure(c)}.bind(this)})},
onMoveGadget:function(a){this.edited=!0},saveChanges:function(a){if(this.edited){a.stop();var b=a.element();this._x_edit_notification=new XWiki.widgets.Notification(e["dashboard.actions.save.loading"],"inprogress");this.doEditGadgets(function(){this.edited||b.click();this._x_edit_notification&&this._x_edit_notification.hide()}.bind(this))}},prepareEditParameters:function(){var a=new Hash;this.containers.each(function(b){var d=this._getContainerId(b);b.select(".gadget").each(function(c,f){c=this._getGadgetId(c);
a.set(this.gadgetsClass+"_"+c+"_position",d+", "+(f+1))},this)},this);return a},getFormToken:function(){var a=this.element.up("form");return a&&(a=a.form_token)?a.value:""}});XWiki.domIsLoaded&&h()||document.observe("xwiki:dom:loaded",h)}).apply("]]#",$jsontool.serialize([$paths,$l10n]));

//# sourceMappingURL=dashboard.min.js.map
