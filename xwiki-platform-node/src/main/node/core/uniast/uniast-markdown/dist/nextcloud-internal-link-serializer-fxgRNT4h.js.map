{"version":3,"file":"nextcloud-internal-link-serializer-fxgRNT4h.js","sources":["../src/markdown/internal-links/serializer/nextcloud-internal-link-serializer.ts"],"sourcesContent":["/**\n * See the LICENSE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n */\nimport { EntityType } from \"@xwiki/cristal-model-api\";\nimport { XMLParser } from \"fast-xml-parser\";\nimport { inject, injectable } from \"inversify\";\nimport type { InternalLinksSerializer } from \"./internal-links-serializer\";\nimport type { UniAstToMarkdownConverter } from \"../../uni-ast-to-markdown-converter\";\nimport type { CristalApp } from \"@xwiki/cristal-api\";\nimport type { DocumentService } from \"@xwiki/cristal-document-api\";\nimport type { RemoteURLSerializerProvider } from \"@xwiki/cristal-model-remote-url-api\";\nimport type { Link, LinkTarget } from \"@xwiki/cristal-uniast-api\";\n\n/**\n * @since 0.22\n */\n@injectable()\nexport class NextcloudInternalLinkSerializer\n  implements InternalLinksSerializer\n{\n  constructor(\n    @inject(\"RemoteURLSerializerProvider\")\n    private readonly remoteURLSerializerProvider: RemoteURLSerializerProvider,\n    @inject(\"CristalApp\") private readonly cristalApp: CristalApp,\n    @inject(\"DocumentService\")\n    private readonly documentService: DocumentService,\n  ) {}\n\n  async serialize(\n    content: Link[\"content\"],\n    target: Extract<LinkTarget, { type: \"internal\" }>,\n    uniAstToMarkdownConverter: UniAstToMarkdownConverter,\n  ): Promise<string> {\n    const label =\n      await uniAstToMarkdownConverter.convertInlineContents(content);\n    const urlFromReference = this.remoteURLSerializerProvider\n      .get()!\n      .serialize(target.parsedReference ?? undefined)!;\n    const response = await fetch(urlFromReference, {\n      method: \"PROPFIND\",\n      body: `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <d:propfind xmlns:d=\"DAV:\">\n   <d:prop xmlns:oc=\"http://owncloud.org/ns\">\n    <oc:fileid/>\n   </d:prop>\n </d:propfind>`,\n      headers: {\n        Authorization: `Basic ${btoa(\"admin:admin\")}`,\n      },\n    });\n    const xml = new XMLParser().parse(await response.text());\n    const fileId =\n      xml[\"d:multistatus\"][\"d:response\"][\"d:propstat\"][\"d:prop\"][\"oc:fileid\"];\n    const baseURL = this.cristalApp.getWikiConfig().baseURL;\n    const url = `${baseURL}/f/${fileId}`;\n    return `[${label}](${url})`;\n  }\n\n  // eslint-disable-next-line max-statements\n  async serializeImage(\n    target: Extract<LinkTarget, { type: \"internal\" }>,\n    alt?: string,\n  ): Promise<string> {\n    let ref: string;\n    if (target.parsedReference) {\n      const currentDocumentReference =\n        this.documentService.getCurrentDocumentReference().value!;\n      if (target.parsedReference.type == EntityType.ATTACHMENT) {\n        const parsedReference = target.parsedReference;\n        const imageDocumentReference = parsedReference.document;\n        if (currentDocumentReference === imageDocumentReference) {\n          ref = `.${imageDocumentReference.name}/attachments/${parsedReference.name}`;\n        } else {\n          const down = [\n            ...(currentDocumentReference.space &&\n            currentDocumentReference.space.names.length > 0\n              ? currentDocumentReference.space.names.map(() => \"..\")\n              : [\".\"]),\n          ].join(\"/\");\n          const up = [\n            ...(parsedReference.document.space?.names ?? []),\n            \".\" + parsedReference.document.name,\n          ]\n            .map(encodeURI)\n            .join(\"/\");\n          ref = `${down}/${up}/attachments/${encodeURI(parsedReference.name)}`;\n        }\n      } else {\n        throw new Error(\n          `Unexpected type ${target.parsedReference.type} for link serialization`,\n        );\n      }\n    } else {\n      ref = target.rawReference;\n    }\n\n    return `![${alt ?? \"\"}](${ref})`;\n  }\n}\n"],"names":["NextcloudInternalLinkSerializer","remoteURLSerializerProvider","cristalApp","documentService","content","target","uniAstToMarkdownConverter","label","urlFromReference","response","fileId","XMLParser","url","alt","ref","currentDocumentReference","EntityType","parsedReference","imageDocumentReference","down","up","__decorateClass","injectable","__decorateParam"],"mappings":";;;;;;;;AAiCO,IAAMA,IAAN,MAEP;AAAA,EACE,YAEmBC,GACsBC,GAEtBC,GACjB;AAJiB,SAAA,8BAAAF,GACsB,KAAA,aAAAC,GAEtB,KAAA,kBAAAC;AAAA,EAChB;AAAA,EAEH,MAAM,UACJC,GACAC,GACAC,GACiB;AACjB,UAAMC,IACJ,MAAMD,EAA0B,sBAAsBF,CAAO,GACzDI,IAAmB,KAAK,4BAC3B,IAAA,EACA,UAAUH,EAAO,mBAAmB,MAAS,GAC1CI,IAAW,MAAM,MAAMD,GAAkB;AAAA,MAC7C,QAAQ;AAAA,MACR,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAMN,SAAS;AAAA,QACP,eAAe,SAAS,KAAK,aAAa,CAAC;AAAA,MAAA;AAAA,IAC7C,CACD,GAEKE,IADM,IAAIC,EAAA,EAAY,MAAM,MAAMF,EAAS,MAAM,EAEjD,eAAe,EAAE,YAAY,EAAE,YAAY,EAAE,QAAQ,EAAE,WAAW,GAElEG,IAAM,GADI,KAAK,WAAW,cAAA,EAAgB,OAC1B,MAAMF,CAAM;AAClC,WAAO,IAAIH,CAAK,KAAKK,CAAG;AAAA,EAC1B;AAAA;AAAA,EAGA,MAAM,eACJP,GACAQ,GACiB;AACjB,QAAIC;AACJ,QAAIT,EAAO,iBAAiB;AAC1B,YAAMU,IACJ,KAAK,gBAAgB,4BAAA,EAA8B;AACrD,UAAIV,EAAO,gBAAgB,QAAQW,EAAW,YAAY;AACxD,cAAMC,IAAkBZ,EAAO,iBACzBa,IAAyBD,EAAgB;AAC/C,YAAIF,MAA6BG;AAC/B,UAAAJ,IAAM,IAAII,EAAuB,IAAI,gBAAgBD,EAAgB,IAAI;AAAA,aACpE;AACL,gBAAME,IAAO;AAAA,YACX,GAAIJ,EAAyB,SAC7BA,EAAyB,MAAM,MAAM,SAAS,IAC1CA,EAAyB,MAAM,MAAM,IAAI,MAAM,IAAI,IACnD,CAAC,GAAG;AAAA,UAAA,EACR,KAAK,GAAG,GACJK,IAAK;AAAA,YACT,GAAIH,EAAgB,SAAS,OAAO,SAAS,CAAA;AAAA,YAC7C,MAAMA,EAAgB,SAAS;AAAA,UAAA,EAE9B,IAAI,SAAS,EACb,KAAK,GAAG;AACX,UAAAH,IAAM,GAAGK,CAAI,IAAIC,CAAE,gBAAgB,UAAUH,EAAgB,IAAI,CAAC;AAAA,QACpE;AAAA,MACF;AACE,cAAM,IAAI;AAAA,UACR,mBAAmBZ,EAAO,gBAAgB,IAAI;AAAA,QAAA;AAAA,IAGpD;AACE,MAAAS,IAAMT,EAAO;AAGf,WAAO,KAAKQ,KAAO,EAAE,KAAKC,CAAG;AAAA,EAC/B;AACF;AAjFad,IAANqB,EAAA;AAAA,EADNC,EAAA;AAAA,EAKIC,OAAO,6BAA6B,CAAA;AAAA,EAEpCA,OAAO,YAAY,CAAA;AAAA,EACnBA,OAAO,iBAAiB,CAAA;AAAA,GAPhBvB,CAAA;"}