###
### Copy document template
###
#if(!$xwiki.hasAccessLevel("edit"))
  #template("accessdenied.vm")
#elseif($doc.isNew())
  $response.setStatus(404)
  #template("startpage.vm")
  <div class="main layoutsubsection">
  <div id="mainContentArea">
    #error("$msg.get('core.rename.nonexistingDocument')")
  </div>## mainContentArea
  </div>## main
  #template("endpage.vm")
#else
  #template("startpage.vm")
  <div class="main layoutsubsection">
  <div id="mainContentArea">
    <div id="document-title"><h1>$msg.get('core.copy.title', [$escapetool.xml($doc.plainTitle), $doc.getURL()])</h1></div>
    ##------------------------------------------------
    ## Get source reference
    ##------------------------------------------------
    #set($sourcewiki = "$!{request.sourceWikiName}")
    #if("$!sourcewiki" == "")
      #set($sourcewiki = $xcontext.database)
    #end
    #set($sourcespace = "$!{request.sourceSpaceName}")
    #set($sourcepage = "$!{request.sourcePageName}")
    ##------------------------------------------------
    ## Get source reference
    ##------------------------------------------------
    #set($targetwiki = "$!{request.targetWikiName}")
    #if("$!targetwiki" == "")
      #set($targetwiki = $xcontext.database)
    #end
    #set($targetspace = "$!{request.targetSpaceName}")
    #set($targetpage = "$!{request.targetPageName}")
    ##------------------------------------------------
    ## Get which translated pages we need to copy
    ##------------------------------------------------
    #if("$!request.language" != "" && "$!{request.language}" != 'ALL')
      #set($language = "$!{request.language}")
      #set($escapedLanguage = "$!{escapetool.xml($request.language)}")
    #end
    ##-------------------------------------------------------------
    ## Decide whether to perform the copy or display the copy form
    ##-------------------------------------------------------------
    #if($sourcewiki != "" && $sourcespace != "" && $sourcepage != "" && $targetwiki != "" && $targetspace != "" && $targetpage != "" && $!{services.csrf.isTokenValid("$!{request.getParameter('form_token')}")})
      #set($sourceDocReference = $services.model.createDocumentReference($sourcewiki, $sourcespace, $sourcepage))
      #set($targetDocReference = $services.model.createDocumentReference($targetwiki, $targetspace, $targetpage))
      #if($xwiki.copyDocument($sourceDocReference, $targetDocReference, $language, false, true))
        #if($escapedLanguage)
          #set($fromurl = $xwiki.getURL($sourceDocReference, "view", "language=${escapedLanguage}"))
          #set($tourl = $xwiki.getURL($targetDocReference, "view", "language=${escapedLanguage}"))
        #else
          #set($fromurl = $xwiki.getURL($sourceDocReference))
          #set($tourl = $xwiki.getURL($targetDocReference))
        #end
        #set($sourcelink = "<a href='${fromurl}'>$!{escapetool.xml($sourceDocReference.name)} #if($escapedLanguage)($escapedLanguage)#end</a>")
        #set($targetlink = "<a href='${tourl}'>$!{escapetool.xml($targetDocReference.name)}</a>")
        #info("$msg.get('core.copy.copyingdoc', [$sourcelink, $targetlink])")
      #else
        #error("$msg.get('core.rename.targetNotWritable')")
      #end
    #else
    <form action="" class="xform third">
    <div class="hidden">
      ## CSRF prevention
      <input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" />
      <input type="hidden" name="xpage" value="copy" />
    </div>
    <dl>
      ##------------------
      ## Wiki Source field
      ##------------------
      #if($xwiki.isVirtualMode() && $xwiki.hasProgrammingRights())
      <dt>
        <label for="sourceWikiName">$msg.get("core.copy.sourcewiki")</label>
        <span class="xHint">$msg.get('core.copy.sourcewiki.hint')</span>
      </dt>
      <dd>$!{escapetool.xml($doc.wiki)} <input type="hidden" id="sourceWikiName" name="sourceWikiName" value="$!{escapetool.xml($doc.wiki)}" size="60"/></dd>
      #end
      ##------------------
      ## Space Source field
      ##------------------
      <dt>
        <label for="sourceSpaceName">$msg.get("core.copy.sourcespace")</label>
        <span class="xHint">$msg.get('core.copy.sourcespace.hint')</span>
      </dt>
      <dd>$!{escapetool.xml($doc.space)} <input type="hidden" id="sourceSpaceName" name="sourceSpaceName" value="$!{escapetool.xml($doc.space)}" size="60"/></dd>
      ##------------------
      ## Page Source field
      ##------------------
      <dt>
        <label for="sourcePageName">$msg.get("core.copy.sourcepage")</label>
        <span class="xHint">$msg.get('core.copy.sourcepage.hint')</span>
      </dt>
      <dd>$!{escapetool.xml($doc.name)} <input type="hidden" id="sourcePageName" name="sourcePageName" value="$!{escapetool.xml($doc.name)}" size="60"/></dd>
      ##------------------
      ## Translation field
      ##------------------
      #set ($docTranslations = $doc.getTranslationList())
      #if ($xwiki.isMultiLingual() && $docTranslations.size() > 0)
      <dt>
        <label for="language">$msg.get("language")</label>
        <span class="xHint">$msg.get('core.copy.language.hint')</span>
      </dt>
      <dd>
        <select id="language" name="language">
          ## Add a special "All Translations" combo box entry to copy all translations.
          <option value="ALL" selected="selected">$msg.get("core.copy.allTranslations")</option>
          ## Add all the existing translations
          #foreach ($docTranslation in $docTranslations)
            <option>$docTranslation</option>
          #end
        </select>
      </dd>
      #end
      ##------------------
      ## Wiki Target field
      ##------------------
      #if($xwiki.isVirtualMode() && $xwiki.hasProgrammingRights())
      <dt>
        <label for="targetWikiName">$msg.get("core.copy.targetwiki")</label>
        <span class="xHint">$msg.get('core.copy.targetwiki.hint')</span>
      </dt>
      <dd>
        <select id="targetWikiName" name="targetWikiName">
          #set ($wikis = $xwiki.getXWiki().getVirtualWikisDatabaseNames($context.getContext()))
          ## Add the main wiki in case of it does not have a proper descriptor
          #if (!$wikis.contains($context.getMainWikiName()))
            $wikis.add($context.getMainWikiName())
          #end
          #foreach ($wiki in $wikis)
            <option #if ($wiki == $doc.wiki) selected="selected" #end>$!{escapetool.xml($wiki)}</option>
          #end
        </select>
      </dd>
      #end
      ##-------------------
      ## Space Target field
      ##-------------------
      <dt>
        <label for="targetSpaceName">$msg.get('core.copy.targetspace')</label>
        <span class="xHint">$msg.get('core.copy.targetspace.hint')</span>
      </dt>
      <dd>
        <input type="text" name="targetSpaceName" id="targetSpaceName" size="60" class="suggestSpaces" value="$!{escapetool.xml($doc.space)}"/>
      </dd>
      ##------------------
      ## Page Target field
      ##------------------
      <dt>
        <label for="targetPageName">$msg.get("core.copy.targetpage")</label>
        <span class="xHint">$msg.get('core.copy.targetpage.hint')</span>
      </dt>
      <dd><input type="text" id="targetPageName" name="targetPageName" value="$!{escapetool.xml($doc.name)}" size="60" /></dd>
    </dl>
    <div class="buttons">
      <span class="buttonwrapper"><input type="submit" value="$msg.get('core.copy.submit')" class="button"/></span>
      <span class="buttonwrapper"><a class="secondary button" href="$doc.getURL()">$msg.get('core.copy.cancel')</a></span>
    </div>
    </form>
    #end
    <div class="clearfloats"></div>
  </div>## mainContentArea
  </div>## main
#template("endpage.vm")
#end
