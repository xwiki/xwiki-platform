<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.3" reference="AppWithinMinutes.DBList" locale="">
  <web>AppWithinMinutes</web>
  <name>DBList</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>AppWithinMinutes.FormFieldClass</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title>$services.localization.render('platform.appwithinminutes.classEditorDBListFieldName')</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content/>
  <class>
    <name>AppWithinMinutes.DBList</name>
    <customClass/>
    <customMapping/>
    <defaultViewSheet/>
    <defaultEditSheet/>
    <defaultWeb/>
    <nameField/>
    <validationScript/>
    <databaseList>
      <cache>0</cache>
      <classname>AppWithinMinutes.FormFieldClass</classname>
      <customDisplay/>
      <defaultValue/>
      <disabled>0</disabled>
      <displayType>input</displayType>
      <freeText/>
      <hint/>
      <idField>doc.fullName</idField>
      <multiSelect>0</multiSelect>
      <name>databaseList</name>
      <number>1</number>
      <picker>1</picker>
      <prettyName>Database List</prettyName>
      <relationalStorage>1</relationalStorage>
      <separator> </separator>
      <separators/>
      <size>1</size>
      <sort>none</sort>
      <sql/>
      <unmodifiable>0</unmodifiable>
      <validationMessage/>
      <validationRegExp/>
      <valueField>doc.name</valueField>
      <classType>com.xpn.xwiki.objects.classes.DBListClass</classType>
    </databaseList>
  </class>
  <object>
    <name>AppWithinMinutes.DBList</name>
    <number>0</number>
    <className>AppWithinMinutes.FormFieldClass</className>
    <guid>b9f6894f-9a28-44cb-81f4-cb63825c0522</guid>
    <class>
      <name>AppWithinMinutes.FormFieldClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <category>
        <cache>0</cache>
        <classname>AppWithinMinutes.FormFieldCategoryClass</classname>
        <customDisplay/>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <idField/>
        <multiSelect>0</multiSelect>
        <name>category</name>
        <number>2</number>
        <picker>0</picker>
        <prettyName>Category</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators/>
        <size>1</size>
        <sort>none</sort>
        <sql/>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <valueField/>
        <classType>com.xpn.xwiki.objects.classes.DBListClass</classType>
      </category>
      <icon>
        <customDisplay/>
        <disabled>0</disabled>
        <name>icon</name>
        <number>2</number>
        <picker>0</picker>
        <prettyName>Icon</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </icon>
      <priority>
        <customDisplay/>
        <disabled>0</disabled>
        <name>priority</name>
        <number>3</number>
        <numberType>long</numberType>
        <prettyName>Priority</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.NumberClass</classType>
      </priority>
      <properties>
        <customDisplay/>
        <disabled>0</disabled>
        <name>properties</name>
        <number>5</number>
        <picker>0</picker>
        <prettyName>Properties</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </properties>
    </class>
    <property>
      <category>AppWithinMinutes.Advanced</category>
    </property>
    <property>
      <icon>icons/datamodel/database.png</icon>
    </property>
    <property>
      <priority>0</priority>
    </property>
    <property>
      <properties>displayType picker size multiSelect relationalStorage classname idField valueField sql</properties>
    </property>
  </object>
  <object>
    <name>AppWithinMinutes.DBList</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>489cd8ec-d480-441d-8104-4cfb53a163c6</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <defaultValue>long</defaultValue>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <contenttype>PureText</contenttype>
        <disabled>0</disabled>
        <editor>PureText</editor>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>define('xwiki-awm-class-field-enhancer', ['jquery', 'xwiki-events-bridge'], function($) {
  var maybeEnhanceClassField = function(field, fieldEnhancer) {
    var fieldContainer = field.getContainer();
    var enhancedFlag = '_enhanced' + fieldEnhancer.id;
    // Enhance the field if it's not already enhanced and if it matches the template.
    if (!fieldContainer[enhancedFlag] &amp;&amp; $('#' + 'template-' + field.getName()).val() === fieldEnhancer.fieldTemplate) {
      fieldContainer[enhancedFlag] = true;
      fieldEnhancer.enhance(field);
    }
  };

  return function(fieldEnhancer) {
    // Enhance the class fields right after they are displayed.
    $(document).on('xwiki:class:displayField', function(event, data) {
      maybeEnhanceClassField(data.field, fieldEnhancer);
    });

    // Enhance the class fields that have been already displayed.
    $('#fields').children().each(function() {
      var field = new XWiki.FormField(this);
      if (field.getConfig()) {
        maybeEnhanceClassField(field, fieldEnhancer);
      }
    });
  };
});

define('xwiki-awm-list-enhancer', ['jquery', 'xwiki-awm-class-field-enhancer'], function($, classFieldEnhancer) {
  var enhance = function(field) {
    enhanceMultiSelect(field);
    enhanceDisplayType(field);
  };

  var maybeUpdateListSize = function(field) {
    var multiSelectField = $('#' + field.getPropertyId('multiSelect'));
    var displayTypeField = $('#' + field.getPropertyId('displayType'));
    if (multiSelectField.prop('checked') &amp;&amp; displayTypeField.val() === 'select') {
      // Select box with multiple selection enabled should be displayed as an expanded list box so we have to adjust the
      // size (size 1 means drop down list box).
      var sizeField = $('#' + field.getPropertyId('size'));
      if (parseInt(sizeField.val()) &lt; 2) {
        sizeField.val(5);
      }
    }
  };

  var enhanceMultiSelect = function(field) {
    var relationalStorageField = $('#' + field.getPropertyId('relationalStorage'));

    // Hide the "relational storage" meta property because it's too technical and because the recommendation is to use
    // relational storage if multiple selection is on.
    relationalStorageField.closest('dt').hide();

    $('#' + field.getPropertyId('multiSelect')).on('click', function(event) {
      if ($(this).prop('checked')) {
        // Enable relational storage whenever multiple selection is enabled.
        relationalStorageField.prop('checked', true);

        // Synchronize multiple selection with display type.
        var displayTypeField = $('#' + field.getPropertyId('displayType'));
        if (displayTypeField.val() === 'radio') {
          // Radio display type doesn't support multiple selection.
          displayTypeField.val('checkbox');
        }
      }

      maybeUpdateListSize(field);
    });
  };

  var enhanceDisplayType = function(field) {
    var displayTypeField = $('#' + field.getPropertyId('displayType'));
    var useSuggestField = $('#' + field.getPropertyId('picker'));
    var sizeField = $('#' + field.getPropertyId('size'));

    // Hide the "Use suggest" meta property because it makes sense only for the input display type.
    useSuggestField.closest('dt').hide();

    // Initialize the state of the size meta property.
    sizeField.prop('readOnly', displayTypeField.val() !== 'select');

    displayTypeField.on('change', function(event) {
      // Use suggest picker whenever input display type is selected.
      useSuggestField.prop('checked', $(this).val() === 'input');

      // The size meta property makes sense only when display type is select.
      sizeField.prop('readOnly', $(this).val() !== 'select');

      // Radio display type doesn't support multiple selection.
      if ($(this).val() === 'radio') {
        $('#' + field.getPropertyId('multiSelect')).prop('checked', false);
      }

      maybeUpdateListSize(field);
    });
  }

  return function(fieldTemplate) {
    classFieldEnhancer({
      id: 'List',
      fieldTemplate: fieldTemplate,
      enhance: enhance
    });
  };
});

// Database List Class Field Enhancer
require(['jquery', 'xwiki-awm-list-enhancer'], function($, listEnhancer) {
  listEnhancer($jsontool.serialize($doc.fullName));
});</code>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
</xwikidoc>
