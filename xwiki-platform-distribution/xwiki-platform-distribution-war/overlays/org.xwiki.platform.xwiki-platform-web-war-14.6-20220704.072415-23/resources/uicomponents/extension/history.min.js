'use strict';require(["jquery","xwiki-events-bridge"],function(c){c(".extension-history-source-upload input[type=submit]").addClass("hidden");c(".extension-history-sources-header").on("click",function(){c(this).closest(".extension-history-sources-selector").toggleClass("opened")});c(".extension-history-sources-selector").removeClass("opened");var v=function(a){a.preventDefault();var b=c(this);window.confirm(b.attr("data-confirmation"))&&(b.addClass("loading").children().hide(),a=b.attr("href").replace(/xredirect=/,
"xfoo="),c.get(a).then(()=>{var d=b.closest(".extension-history-source");if(d.hasClass("selected")){var e=d.parent().children().first();h.call(e.children(".extension-history-source-name"))}d.remove()}).catch(()=>{b.removeClass("loading").children().show()}))},h=function(a){a&&a.preventDefault();a=c(this).closest(".extension-history-source");if(!a.hasClass("selected")){a.parent().children(".selected").removeClass("selected");a.addClass("selected");var b=a.closest(".extension-history-sources-selector");
b.removeClass("opened").find(".extension-history-sources-header em").text(c(this).text());var d=b.next(".extension-history-records-form");d.find(".extension-history-record").hide();d.find(".extension-history-actions").hide();d.children(".extension-history-records").append('<li class="extension-history-record loading"><span style="visibility:hidden">Loading</span></li>');c.get(a.attr("data-recordsURL")).then(e=>{d.replaceWith(e);d=b.next(".extension-history-records-form");d.length&&c(document).trigger("xwiki:dom:updated",
{elements:d.toArray()})}).catch(()=>{})}},m=function(a){a.find(".extension-history-source a.deleteLink").on("click",v);a.find("a.extension-history-source-name").on("click",h)};m(c(".extension-history-sources"));var w=function(a,b){if("done"===b.type){a=c(a.target).closest(".extension-history-sources-body");m(a);var d=b.parameters.name;b=a.find(".extension-history-source").filter(function(){return c(this).attr("data-fileName")===d}).first();h.call(b.find(".extension-history-source-name"))}};"undefined"!=
typeof XWiki.FileUploader&&c('.extension-history-source-upload input[type="file"]').each(function(){c(this).on("xwiki:html5upload:message",w);new XWiki.FileUploader(this,{maxFilesize:1E6,fileFilter:/application\/xml|text\/xml/i,progressAutohide:!0,responseContainer:c(".extension-history-sources")[0]})});var x=function(a){a.preventDefault();var b=c(a.target).css("visibility","hidden"),d=b.closest(".extension-history-record").addClass("loading");c.get(b.attr("href")).then(e=>{var f=c(document.createElement("div"));
e=f.append(e).find(".extension-history-record");c(document).trigger("xwiki:dom:updated",{elements:f.toArray()});d.replaceWith(e)}).catch(()=>{d.removeClass("loading");b.css("visibility",null)})},n=function(){var a=c(this).closest(".extension-history-records-form"),b=a.find('input[name="extensionHistoryRecord"]:checked').length;a.find("button").prop("disabled",0==b)},p=function(a){a.find(".extension-history-record a.more").on("click",x);n.call(a);a.find('.extension-history-record input[type="checkbox"]').on("click",
n)};p(c(".extension-history-records-form"));c(document).on("xwiki:dom:updated",function(a,b){p(c(b.elements))});var r=function(a){a.preventDefault();a=c(a.target).closest(".extension-history");var b=a.find(".extension-history-replay-options");0<b.length?(b.removeClass("hidden").prevAll().hide(),b.get(0).scrollIntoView()):q(a)};c('.extension-history-actions button[value="replayPlan"]').on("click",r);c(document).on("xwiki:dom:updated",function(a,b){c(b.elements).find('.extension-history-actions button[value="replayPlan"]').on("click",
r)});c('.extension-history-replay-options button[value="replayPlan"]').on("click",function(a){a.preventDefault();q(c(a.target).closest(".extension-history"))});c(".extension-history-replay-options a.btn-default").on("click",function(a){a.preventDefault();g&&g.abort();c(a.target).closest(".extension-history-replay-options").addClass("hidden").prevAll().show()});var g,q=function(a){var b=a.children("form"),d=b.serialize()+"&data=replayPlan";b.find(":input").prop("disabled",!0);g=c.post(b.attr("action"),
d);Promise.resolve(g).then(e=>{a.children().hide();a.find(".extension-history-replay-options").show().addClass("hidden");a.append(e);e=a.find(".extension-history-replay-plan");e.length&&c(document).trigger("xwiki:dom:updated",{elements:e.toArray()});e.find("a.btn-default").on("click",y);e.find('button[value="replay"]').on("click",z)}).finally(()=>{b.find(":input").prop("disabled",!1)})},y=function(a){a.preventDefault();a=c(a.target).closest(".extension-history");a.children(".extension-history-replay-plan").remove();
a.children().show()},z=function(a){a.preventDefault();var b=c(this).prop("disabled",!0);a=b.closest("form");var d=a.serialize()+"&action=replay";c.post(a.attr("action"),d).then(e=>{var f=window.location.href.replace(/#.*$/,"");f+=0>f.indexOf("?")?"?":"&";window.location=f+c.param({data:"replayStatus",jobId:e.jobId})}).catch(()=>{b.prop("disabled",!1)})},u=function(a,b){b=b||{};var d=t(a);!!b.logOpened!==d.logOpened&&a.find(".extension-history-replay-log .collapse-toggle").click();b=a.attr("data-jobState");
"WAITING"==b?(a.find('form.extension-question button[value="continue"]').on("click",k.bind(null,a,"action=continue")),a.find('form.extension-question button[name="extensionAction"]').on("click",k.bind(null,a,"data=replayStatus"))):"string"==typeof b&&"FINISHED"!=b&&setTimeout(k.bind(null,a),1E3)},t=function(a){return{logOpened:!a.find(".log.hidden").length}},k=function(a,b,d){d?(d.preventDefault(),b+="&"+c(d.target).closest("form").serialize()):b=b||{data:"replayStatus",jobId:a.attr("data-jobId")};
c.post(a.attr("data-extensionHistoryURL"),b).then(e=>{var f=t(a),l=c(document.createElement("div"));l.append(e);u(l.find(".extension-history-replay-status"),f);e=l.children();a.replaceWith(e);c(document).trigger("xwiki:dom:updated",{elements:e.toArray()})}).catch(()=>{})};u(c(".extension-history-replay-status"))});

//# sourceMappingURL=history.min.js.map
