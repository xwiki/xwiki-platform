{"version":3,"file":"github-internal-link-serializer-Cr_EgYzo.js","sources":["../src/markdown/internal-links/serializer/github-internal-link-serializer.ts"],"sourcesContent":["/**\n * See the LICENSE file distributed with this work for additional\n * information regarding copyright ownership.\n *\n * This is free software; you can redistribute it and/or modify it\n * under the terms of the GNU Lesser General Public License as\n * published by the Free Software Foundation; either version 2.1 of\n * the License, or (at your option) any later version.\n *\n * This software is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n * Lesser General Public License for more details.\n *\n * You should have received a copy of the GNU Lesser General Public\n * License along with this software; if not, write to the Free\n * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n */\nimport { AttachmentReference, EntityType } from \"@xwiki/cristal-model-api\";\nimport { inject, injectable } from \"inversify\";\nimport type { InternalLinksSerializer } from \"./internal-links-serializer\";\nimport type { UniAstToMarkdownConverter } from \"../../uni-ast-to-markdown-converter\";\nimport type { DocumentService } from \"@xwiki/cristal-document-api\";\nimport type { EntityReference } from \"@xwiki/cristal-model-api\";\nimport type { Link, LinkTarget } from \"@xwiki/cristal-uniast-api\";\n\n/**\n * @since 0.22\n */\n@injectable()\nexport class GitHubInternalLinkSerializer implements InternalLinksSerializer {\n  constructor(\n    @inject(\"DocumentService\")\n    private readonly documentService: DocumentService,\n  ) {}\n\n  async serialize(\n    content: Link[\"content\"],\n    target: Extract<LinkTarget, { type: \"internal\" }>,\n    uniAstToMarkdownConverter: UniAstToMarkdownConverter,\n  ): Promise<string> {\n    const label =\n      await uniAstToMarkdownConverter.convertInlineContents(content);\n\n    const ref = this.computeRef(target);\n    return `[${label}](${ref})`;\n  }\n\n  async serializeImage(\n    target: Extract<LinkTarget, { type: \"internal\" }>,\n    alt?: string,\n  ): Promise<string> {\n    const ref = this.computeRef(target);\n    return `![${alt ?? \"\"}](${ref})`;\n  }\n\n  // eslint-disable-next-line max-statements\n  private computeRef(\n    target: Extract<\n      {\n        type: \"internal\";\n        rawReference: string;\n        parsedReference: EntityReference | null;\n      },\n      { type: \"internal\" }\n    >,\n  ) {\n    if (target.parsedReference) {\n      const currentDocumentReference =\n        this.documentService.getCurrentDocumentReference().value!;\n      let parsedReference = target.parsedReference;\n      const isAttachment = parsedReference.type === EntityType.ATTACHMENT;\n      if (isAttachment) {\n        parsedReference = (parsedReference as AttachmentReference).document;\n      } else if (parsedReference.type !== EntityType.DOCUMENT) {\n        throw new Error(\n          `Unexpected type ${parsedReference.type} for link serialization`,\n        );\n      }\n\n      const down = [\n        ...(currentDocumentReference.space &&\n        currentDocumentReference.space.names.length > 0\n          ? currentDocumentReference.space.names.map(() => \"..\")\n          : [\".\"]),\n      ].join(\"/\");\n\n      const name = (isAttachment ? \".\" : \"\") + parsedReference.name;\n      const up = [...(parsedReference.space?.names ?? []), name]\n        .map(encodeURI)\n        .join(\"/\");\n      if (!isAttachment) {\n        return `${down}/${up}.md`.replace(/^\\.\\//, \"\");\n      } else {\n        return `${down}/${up}/attachments/${encodeURI((target.parsedReference as AttachmentReference).name)}`.replace(\n          /^\\.\\//,\n          \"\",\n        );\n      }\n    } else {\n      return target.rawReference;\n    }\n  }\n}\n"],"names":["GitHubInternalLinkSerializer","documentService","content","target","uniAstToMarkdownConverter","label","ref","alt","currentDocumentReference","parsedReference","isAttachment","EntityType","down","name","up","__decorateClass","injectable","__decorateParam"],"mappings":";;;;;;;AA+BO,IAAMA,IAAN,MAAsE;AAAA,EAC3E,YAEmBC,GACjB;AADiB,SAAA,kBAAAA;AAAA,EAChB;AAAA,EAEH,MAAM,UACJC,GACAC,GACAC,GACiB;AACjB,UAAMC,IACJ,MAAMD,EAA0B,sBAAsBF,CAAO,GAEzDI,IAAM,KAAK,WAAWH,CAAM;AAClC,WAAO,IAAIE,CAAK,KAAKC,CAAG;AAAA,EAC1B;AAAA,EAEA,MAAM,eACJH,GACAI,GACiB;AACjB,UAAMD,IAAM,KAAK,WAAWH,CAAM;AAClC,WAAO,KAAKI,KAAO,EAAE,KAAKD,CAAG;AAAA,EAC/B;AAAA;AAAA,EAGQ,WACNH,GAQA;AACA,QAAIA,EAAO,iBAAiB;AAC1B,YAAMK,IACJ,KAAK,gBAAgB,4BAAA,EAA8B;AACrD,UAAIC,IAAkBN,EAAO;AAC7B,YAAMO,IAAeD,EAAgB,SAASE,EAAW;AACzD,UAAID;AACF,QAAAD,IAAmBA,EAAwC;AAAA,eAClDA,EAAgB,SAASE,EAAW;AAC7C,cAAM,IAAI;AAAA,UACR,mBAAmBF,EAAgB,IAAI;AAAA,QAAA;AAI3C,YAAMG,IAAO;AAAA,QACX,GAAIJ,EAAyB,SAC7BA,EAAyB,MAAM,MAAM,SAAS,IAC1CA,EAAyB,MAAM,MAAM,IAAI,MAAM,IAAI,IACnD,CAAC,GAAG;AAAA,MAAA,EACR,KAAK,GAAG,GAEJK,KAAQH,IAAe,MAAM,MAAMD,EAAgB,MACnDK,IAAK,CAAC,GAAIL,EAAgB,OAAO,SAAS,CAAA,GAAKI,CAAI,EACtD,IAAI,SAAS,EACb,KAAK,GAAG;AACX,aAAKH,IAGI,GAAGE,CAAI,IAAIE,CAAE,gBAAgB,UAAWX,EAAO,gBAAwC,IAAI,CAAC,GAAG;AAAA,QACpG;AAAA,QACA;AAAA,MAAA,IAJK,GAAGS,CAAI,IAAIE,CAAE,MAAM,QAAQ,SAAS,EAAE;AAAA,IAOjD;AACE,aAAOX,EAAO;AAAA,EAElB;AACF;AAzEaH,IAANe,EAAA;AAAA,EADNC,EAAA;AAAA,EAGIC,OAAO,iBAAiB,CAAA;AAAA,GAFhBjB,CAAA;"}