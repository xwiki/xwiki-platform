'use strict';var XWiki=function(d){d.ExtensionBehaviour=Class.create({initialize:function(a){this.finalize();this.container=a;this.container._extensionBehaviour=this;this._enhanceActions();this._enhanceMenuBehaviour();this._enhanceDescriptionBehaviour();this._enhanceDependenciesBehaviour();this._enhanceChanges();this._maybeScheduleRefresh()},finalize:function(){this.container&&(delete this.container._extensionBehaviour,this.container.remove());this.container=void 0},getNamespace:function(){var a=
this.container.down('input[name="extensionNamespace"]');return a?a.value:null},getId:function(){var a=this.container.down('input[name="extensionId"]');return a?a.value:null},getVersion:function(){var a=this.container.down('input[name="extensionVersion"]');return a?a.value:null},getStatus:function(){for(var a=$w(this.container.className),b=0;b<a.length;b++)if(a[b].startsWith("extension-item-"))return a[b].substr(15);return null},_getServiceURL:function(a){a?(a=d.getResource(a),a=new d.Document(a.name,
a.space,a.wiki)):a=d.currentDocument;return a.getURL("view"==d.contextaction||"admin"==d.contextaction?"get":d.contextaction)},_onAjaxRequestFailure:function(a){if(401==a.status)return new d.widgets.ConfirmationBox({onYes:function(){window.location.reload(!0)}},{confirmationText:"$escapetool.javascript($services.localization.render('extensions.info.fetch.unauthorized'))"}),!1;new d.widgets.Notification("$escapetool.javascript($services.localization.render('extensions.info.fetch.failed'))"+(a.statusText||
"Server not responding"),"error");return!0},_submit:function(a,b){a.stop();var c=a.element().form,e=new Hash(c.serialize({submit:!1}));e.set(a.element().name,a.element().value);c.disable();a={parameters:e,onFailure:this._onAjaxRequestFailure.bind(this),on0:function(g){g.request.options.onFailure(g)},onComplete:function(){c.enable()}};a.defaultValues=Object.clone(a);new Ajax.Request(this._getServiceURL(e.get("section")),Object.extend(a,b))},_update:function(a){var b=this.container.down(".extension-body");
b=!b||b.hasClassName("hidden");var c=this.container.down(".innerMenu li a.current");c&&(this._previouslySelectedMenuItem=c.getAttribute("href"));c=this.getStatus();this.container.addClassName("hidden");this.container.insert({after:a});this.initialize(this.container.next());a=this.container.down(".extension-body");a=!a||a.hasClassName("hidden");b&&!a&&this._onToggleShowHideDetails({stop:function(){},element:function(){return this.container.down('button[value="hideDetails"]')}.bind(this)});c!=this.getStatus()&&
document.fire("xwiki:extension:statusChanged",{extension:this});document.fire("xwiki:dom:updated",{elements:[this.container]})},_onShowDetails:function(a){this._submit(a,{onCreate:function(){this.container.insert({bottom:new Element("div",{"class":"extension-body loading"})})}.bind(this),onSuccess:function(b){this._update(b.responseText)}.bind(this),onComplete:function(b){b.request.options.defaultValues.onComplete(b);(b=this.container.down(".extension-body.loading"))&&b.remove()}.bind(this)})},_enhanceShowDetailsBehaviour:function(){var a=
this.container.down('button[value="showDetails"]');if(a)if(a.hasClassName("visibilityAction")){a=a.up();var b=this.container.down('button[value="hideDetails"]').up();a.__otherButton=b;b.__otherButton=a;this.container.select(".visibilityAction").invoke("observe","click",this._onToggleShowHideDetails.bindAsEventListener(this));a.remove()}else a.observe("click",this._onShowDetails.bindAsEventListener(this))},_onToggleShowHideDetails:function(a){a.stop();a=a.element().up("span");this.container.down(".extension-body").toggleClassName("hidden");
a.replace(a.__otherButton)},_enhanceActions:function(){this._enhanceShowDetailsBehaviour();var a=this._startJob.bindAsEventListener(this);this.container.select('button[name="extensionAction"]').each(function(b){b.value.endsWith("Details")||b.observe("click",a)})},_onBeforeStartJob:function(){var a=this.container.down(".extension-body");if(a){a.hasClassName("hidden")&&this._onToggleShowHideDetails({stop:function(){},element:function(){return this.container.down('button[value="showDetails"]')}.bind(this)});
var b=this._prepareProgressSectionForLoading();this._activateMenuItem(a.down('.innerMenu li a[href="#'+b.previous().id+'"]'))}else this.container.insert({bottom:new Element("div",{"class":"extension-body loading"})})},_prepareProgressSectionForLoading:function(){var a=this.container.down(".extension-body-progress");if(a)a.down(".log-item-loading")?a.down(".extension-question").hide():(a.childElements().invoke("hide"),a.addClassName("loading"));else{var b=this.container.select(".extension-body-section").last();
a=new Element("div",{"class":"extension-body-progress extension-body-section loading"});b.insert({after:a});var c="extension-body-progress"+b.previous().id.substr($w(b.className)[0].length);b.insert({after:new Element("div",{id:c})});b=(new Element("a",{href:"#"+c})).update("$escapetool.javascript($services.localization.render('extensions.info.category.progress'))");this._enhanceMenuItemBehaviour(b);this.container.down(".innerMenu").insert((new Element("li")).insert(b))}return a},_onAfterStartJob:function(a){a.request.options.defaultValues.onComplete(a);
(a=this.container.down(".extension-body.loading"))?a.remove():this._restoreProgressSection()},_restoreProgressSection:function(){var a=this.container.down(".extension-body-progress");a&&(a.childElements().invoke("show"),a.removeClassName("loading"))},_startJob:function(a){this._submit(a,{onCreate:this._onBeforeStartJob.bind(this),onSuccess:function(b){this._update(b.responseText)}.bind(this),onComplete:this._onAfterStartJob.bind(this)})},refresh:function(a){this.container.addClassName("extension-item-loading");
this._refresh(a);this.container.disable()},_refresh:function(a){var b=new Hash(this.container.serialize({submit:!1}));a&&b.update(a);this._preserveMenuSelection=!0;new Ajax.Request(this._getServiceURL(b.get("section")),{parameters:b,onSuccess:function(c){this._update(c.responseText)}.bind(this),onFailure:function(c){this._onAjaxRequestFailure(c)&&this._maybeScheduleRefresh(10)}.bind(this),on0:function(c){c.request.options.onFailure(c)}})},_maybeScheduleRefresh:function(a){a=a||1;this.container.hasClassName("extension-item-loading")&&
!this.container.down('button[value="continue"]')&&this._refresh.bind(this).delay(a)},_enhanceMenuBehaviour:function(){var a=this.container.down(".innerMenu li a.current");if(!a||this._preserveMenuSelection)this._previouslySelectedMenuItem?a=this.container.down('.innerMenu li a[href="'+this._previouslySelectedMenuItem+'"]'):a||=this.container.down(".innerMenu li a");this._preserveMenuSelection=!1;a&&(this._activateMenuItem(a),this.container.select(".innerMenu li a").each(this._enhanceMenuItemBehaviour,
this))},_enhanceMenuItemBehaviour:function(a){a.observe("click",function(b){b.stop();this._activateMenuItem(b.element())}.bindAsEventListener(this))},_activateMenuItem:function(a){this.container.select(".extension-body-section").invoke("setStyle",{display:"none"});var b=this.container.down(".innerMenu li a.current");b&&b.removeClassName("current");$(a.getAttribute("href").substring(1)).next(".extension-body-section").setStyle({display:"block"});a.addClassName("current")},_enhanceDependenciesBehaviour:function(){this.container.hasClassName("extension-item-loading")||
this._resolveUnknownDependency(this.container.select(".dependency-item.extension-item-unknown"),0)},_resolveUnknownDependency:function(a,b){if(!(b>=a.length)){var c=new Hash(this.container.serialize({submit:!1}));c.unset("extensionVersion");c.unset("form_token");var e=a[b];c.set("extensionId",e.down(".extension-name").innerHTML);c.set("extensionVersionConstraint",e.down(".extension-version").innerHTML);new Ajax.Request(this._getServiceURL(c.get("section")),{parameters:c,onCreate:function(){e.removeClassName("extension-item-unknown").addClassName("extension-item-loading")},
onSuccess:function(g){e.up("html")&&(e.insert({before:g.responseText}),h(e.previous()),e.remove(),this._resolveUnknownDependency(a,b+1))}.bind(this),onFailure:function(g){e.removeClassName("extension-item-loading").addClassName("extension-item-unknown");this._onAjaxRequestFailure(g)}.bind(this),on0:function(g){g.request.options.onFailure(g)}})}},_enhanceDescriptionBehaviour:function(){var a=this.container.down(".extension-versions-link");a&&a.observe("click",function(b){b.stop();b.element().hide().up().addClassName("loading").setStyle({height:"16px",
width:"16px"});this._refresh({listVersions:!0})}.bindAsEventListener(this))},_enhanceChanges:function(){var a=this._resetDocument.bindAsEventListener(this);this.container.select(".extension-body-changes").each(function(b){b.select(".diff-item-header").each(function(c){var e=new Element("div",{"class":"btn btn-default btn-xs pull-right",style:"margin-top: -.3em;"});e.insert(new Element("span",{"class":"fa fa-undo"}));e.appendChild(document.createTextNode(" ${services.localization.render('extensions.xar.changes.reset.button')}"));
c.insertBefore(e,c.firstChild);e.documentReference=c.getAttribute("data-documentreference");e.documentLocale=c.getAttribute("data-documentlocale");e.documentExtensionId=c.getAttribute("data-documentextensionid");e.documentExtensionVersion=c.getAttribute("data-documentextensionversion");e.observe("click",a)})})},_resetDocument:function(a){var b=new Hash(this.container.serialize({submit:!1}));b.set("extensionAction","revertDocument");b.set("documentReference",a.target.documentReference);b.set("documentLocale",
a.target.documentLocale);b.set("documentExtensionId",a.target.documentExtensionId);b.set("documentExtensionVersion",a.target.documentExtensionVersion);new Ajax.Request(this._getServiceURL(b.get("section")),{parameters:b,onCreate:function(){a.target.setAttribute("disabled","disabled");a.target.firstChild.setAttribute("class","fa fa-spinner fa-pulse")},onSuccess:function(c){c=a.target.parentNode.parentNode;this.container.select("#summary-"+c.id).each(function(e){e.parentNode.removeChild(e)});c.parentNode.removeChild(c)}.bind(this),
onFailure:function(c){a.target.removeAttribute("disabled");a.target.firstChild.setAttribute("class","fa fa-undo");this._onAjaxRequestFailure(c)}.bind(this)})}});d.ExtensionSearchFormBehaviour=Class.create({initialize:function(){this._enhanceSimpleSearch();this._enhanceAdvancedSearch()},_enhanceSimpleSearch:function(){$("extension-search-simple")&&$("extensionSearchRepositoryList").observe("change",function(a){$("extensionSearchInput").focus();a=a.element().form;a.submit.bind(a).defer()}.bindAsEventListener(this))},
_enhanceAdvancedSearch:function(){var a=$("extension-search-advanced");if(a){var b=a.down("legend a");if(b){var c=b.up("legend").next().next();if(c){b.observe("click",function(g){g.stop();b.blur();c.toggleClassName("hidden");b.toggleClassName("expanded")});var e=c.down("a.actionCancel");e&&e.observe("click",function(g){g.stop();e.up("form").select("input[type=text]").each(function(m){m.value=""});b.click()})}}}}});var k=function(a){return 0>a.indexOf("?")?{}:a.toQueryParams()},h=function(a){(a||$("body")).select("a.extension-link, .paginationFilter a").each(function(b){var c=
k(b.getAttribute("href")),e=k(window.location.href);c.extensionId?(e.extensionId=c.extensionId,e.extensionVersion=c.extensionVersion,c.extensionNamespace&&(e.extensionNamespace=c.extensionNamespace)):("extensionId extensionVersion extensionVersionConstraint extensionNamespace invalidPagingReset outdatedPagingReset".split(" ").each(function(g){delete e[g]}),Object.extend(e,c));b.setAttribute("href",d.currentDocument.getURL(d.contextaction,Object.toQueryString(e)))})},l=function(a){(a&&a.memo.elements||
[$("body")]).each(function(b){b.select(".extension-item").each(function(c){!c._extensionBehaviour&&new d.ExtensionBehaviour(c)});h(b)})},f=function(a){new d.ExtensionSearchFormBehaviour;l(a);return!0};d.domIsLoaded&&f()||document.observe("xwiki:dom:loaded",f);document.observe("xwiki:dom:updated",l);return d}(XWiki||{});
require(["jquery"],function(d){var k=function(){var h=this,l=function(c){0==d(c.target).closest(".actions",this).length&&d(this).parent("li").toggleClass("collapsed")},f=function(){var c=d(this).closest(".node",h).next("ul").find(".node").not(".parent").find('input[type="checkbox"]'),e=c.length;c=c.filter(":checked").length;d(this).text("$escapetool.javascript($services.localization.render('extensions.uninstall.cleanPages.selectedCount', ['__selectedCount__', '__total__']))".replace("__selectedCount__",
c).replace("__total__",e));d(this).next().prop("checked",0<c)},a=function(){d(this).closest(".node",h).next("ul").find('input[type="checkbox"]').prop("checked",d(this).prop("checked"))},b=d(this).find("ul").prev(".node").addClass("parent");d(this).hasClass("collapsible")&&b.on("click",l);d(this).hasClass("selectable")&&(b.append('<span class="actions"><input type="checkbox"/></span>'),b.find('.actions input[type="checkbox"]').on("click",a).before('<span class="selectedCount"></span>').prev(".selectedCount").each(f),
d(this).find('input[type="checkbox"]').on("click",function(){d(h).find(".selectedCount").each(f)}))};d(".document-tree").each(k);document.observe("xwiki:dom:updated",function(h){d(h.memo.elements).find(".document-tree").each(k)})});
require(["jquery"],function(d){var k=function(f){d(this).children(".ui-progress").length?setTimeout(h.bind(this),f||1E3):d(this).prev("form").find("button").prop("disabled",!1)},h=function(f){var a=d(this).prev("form").find("input[name=asyncURL]").prop("value");d.post(a,f||{}).then(l.bind(this)).catch(k.bind(this,1E4))},l=function(f){f=d(this).hide().after(f).next(".extensionUpdater");d(this).remove();f.each(k).each(function(){document.fire("xwiki:dom:updated",{elements:[this]})});f.children(".extension-body-progress").find(".log-item-loading").each(function(){this.parentNode.scrollTop=
this.parentNode.scrollHeight})};d(".extensionUpdater").each(k).prev("form").find("button").on("click",function(f){f.preventDefault();d(this).parent(".dropdown-menu").length&&(f=d(this).closest(".button-group").children(".dropdown-toggle"),f.prev().insertAfter(this),f.before(this));f=d(this).closest("form");f.find("button").prop("disabled",!0);var a={};a[this.name]=this.value;f.next(".extensionUpdater").each((b,c)=>h.call(c,a))})});

//# sourceMappingURL=extension.min.js.map
