###
### Document history table
###
### Displays a paged list of document versions, with the possiblity to view a version, compare two
### versions, delete one or a range of versions, restore a version as the current document.
###
##
## Settings, compute what versions should be displayed.
##
  #set($minorVersions = (!$xwiki.hasMinorEdit()) || ("$!request.showminor" == "true"))
## Revision criteria. The following requests for all versions, filtered by the minorVersions option.
  #set($criteria = $xwiki.criteriaService.revisionCriteriaFactory.createRevisionCriteria("", $minorVersions))
  #set($totalVersions = $tdoc.getRevisions($criteria).size())
## This will fill in $startAt, $endAt and the variables needed later by #printPagedViewLinks
  #preparePagedViewParams($totalVersions, $xwiki.getXWikiPreferenceAsInt("web_history_versionsPerPage", 20))
## Since we're displaying revisions starting from the last one, we need to mirror the range inside
## the total versions range.
  #set($startAt = $totalVersions - $startAt)
  #set($endAt = 0 - $itemsPerPage)
  #set($range = $xwiki.criteriaService.rangeFactory.createRange($startAt, $endAt))
## Reuse the old object, just add the range.
  $criteria.setRange($range)
  #if ($tdoc.realLanguage!="")
    #set($lang = "&amp;language=${tdoc.realLanguage}")
  #else
    #set($lang = "")
  #end
##
## Preamble, output some HTML.
##
  <div id="historycontent" class="xwikiintracontent">
    #set($formname="historyform")
    <form id="$formname" action="$doc.getURL("view", "viewer=changes&amp;$docvariant")" method="post">
      <div id="_history">
      <div class="centered">
      <table class="xwikidatatable" summary="$msg.get(document) ${doc.displayTitle} &mdash; $msg.get("history")">
## Print the table header
        <tr>
        #if ($totalVersions > 1)
          <th>$msg.get("from")</th>
          <th>$msg.get("to")</th>
        #end
          <th>$msg.get("version")</th>
          <th>$msg.get("reveditor")</th>
          <th>$msg.get("date")</th>
## Might be disabled in certain wikis.
  #if($xwiki.hasEditComment())
          <th>$msg.get("comment")</th>
  #end
## Editors see the Revert button.
  #if($hasEdit && !$hasAdmin)
          <th></th>
## Admins see the Revert and Delete buttons.
  #elseif($hasAdmin)
          <th colspan="2"></th>
  #end
        </tr>
##
## Display, loop over the extracted revisions and print them in the table.
##
  #foreach ($version in $util.reverseList($tdoc.getRevisions($criteria)))
    #set($revinfo = $tdoc.getRevisionInfo($version))
        <tr class="row#if($velocityCount % 2 == 0) even #else odd #end">
        #if ($totalVersions > 1)
          <td><input type="radio" name="rev1" value="$version" #if ($velocityCount==2) checked="checked" #end/></td>
          <td><input type="radio" name="rev2" value="$version" #if ($velocityCount==1) checked="checked" #end/></td>
        #end
          <td><a href="$tdoc.getURL("viewrev","rev=$version")">$version</a></td>
          <td>$xwiki.getLocalUserName($revinfo.author)</td>
          <td>$xwiki.formatDate($revinfo.date)</td>
    #if($xwiki.hasEditComment())
          <td>$!{revinfo.comment}</td>
    #end
    #if($hasEdit || $hasAdmin)
          <td class="xwikibuttonlink"><a href="$tdoc.getURL("rollback","rev=$version$lang")" onclick="if (confirm('$msg.get("readytorollback") $version')){this.href += '&amp;confirm=1'; return true;} return false;">$msg.get("rollback")</a></td>
    #end
    #if($hasAdmin)
          <td class="xwikibuttonlink"><a href="$tdoc.getURL("deleteversions","rev=$version$lang")" onclick="if (confirm('$msg.get("core.versions.delete.confirm.single", [$version])')){this.href += '&amp;confirm=1'; return true;} return false;">$msg.get("core.versions.delete.single")</a></td>
    #end
        </tr>
  #end ## foreach
##
## Footer, print some more HTML.
##
      </table>
## Print the page navigation links, if needed.
## Since the history can be viewed both in edit and view mode, and these modes use a different parameter name, detect
## and set the right parameter here.
#if($context.action == 'view')
  #set($viewer = 'viewer=history')
#else
  #set($viewer = 'editor=history')
#end
  #printPagedViewLinks($itemsPerPage $totalPages $currentPageNumber "${viewer}&amp;showminor=${minorVersions}" false)
      <div class="buttons">
        #if ($totalVersions > 1)
          <div class="buttonwrapper"><input type="submit" accesskey="c" value="$msg.get("compare")" class="button"/></div>
        #end
        #if($hasAdmin)
          <div class="buttonwrapper"><input class="button" type="submit" name="deleteversions" value="$msg.get("core.versions.delete.many")"
            onclick="document.forms.${formname}.action='$doc.getURL("deleteversions")'; if (document.forms.${formname}.onsubmit) document.forms.${formname}.onsubmit();" /></div>
        #end
        #if($xwiki.hasMinorEdit())
          #if(!$request.getParameter("showminor"))
            <div class="buttonwrapper"><input class="button" type="submit" name="viewminorversions" value="$msg.get("core.minoredit.show")"
              onclick="document.forms.${formname}.action='$tdoc.getURL("view","viewer=history&amp;showminor=true&amp;$docvariant")'; if (document.forms.${formname}.onsubmit) document.forms.${formname}.onsubmit();" /></div>
          #else
            <div class="buttonwrapper"><input class="button" type="submit" name="hideminorversions" value="$msg.get("core.minoredit.hide")"
              onclick="document.forms.${formname}.action='$tdoc.getURL("view","viewer=history&amp;$docvariant")'; if (document.forms.${formname}.onsubmit) document.forms.${formname}.onsubmit();" /></div>
          #end
        #end
      </div>
      </div>
    </div>
  </form>
  </div>
