'use strict';var XWiki=function(g){function k(){require(["xwiki-meta"],function(a){r=a.documentReference});new l.EditActions;new l.AjaxSaveAndContinue;return!0}var l=g.actionButtons=g.actionButtons||{},r,t=$("editingVersionDate"),u=$("previousVersion"),y=$("isNew");document.observe("xwiki:document:changeVersion",function(a){r.equals(a.memo.documentReference)&&(u&&u.setValue(a.memo.version),y&&y.setValue(!1))});l.EditActions=Class.create({initialize:function(){this.addListeners();this.addShortcuts();
this.addValidators()},addListeners:function(){$$("input[name=action_cancel]").each(function(a){a.observe("click",this.onCancel.bindAsEventListener(this))}.bind(this));$$("input[name=action_preview]").each(function(a){a.observe("click",this.onSubmit.bindAsEventListener(this,"preview"))}.bind(this));$$("input[name=action_save]").each(function(a){a.observe("click",this.onSubmit.bindAsEventListener(this,"save"))}.bind(this));$$("input[name=action_saveandcontinue]").each(function(a){a.observe("click",
this.onSubmit.bindAsEventListener(this,"save",!0))}.bind(this))},addShortcuts:function(){var a={action_cancel:"$services.localization.render('core.shortcuts.edit.cancel')",action_preview:"$services.localization.render('core.shortcuts.edit.preview')",action_edit:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_inline:"$services.localization.render('core.shortcuts.edit.backtoedit')",action_save:"$services.localization.render('core.shortcuts.edit.saveandview')",action_propupdate:"$services.localization.render('core.shortcuts.edit.saveandview')",
action_saveandcontinue:"$services.localization.render('core.shortcuts.edit.saveandcontinue')"},b;for(b in a){var c=$$("input[name="+b+"]");c.length&&shortcut.add(a[b],function(){this.click()}.bind(c.first()))}},validators:[],addValidators:function(){for(var a=$("body").select("input.required"),b=0;b<a.length;b++){var c=new LiveValidation(a[b],{validMessage:""});c.add(Validate.Presence,{failureMessage:"$services.localization.render('core.validation.required.message')"});c.validate();this.validators.push(c)}},
validateForm:function(a){for(var b=0;b<this.validators.length;b++)if(!this.validators[b].validate())return!1;if((a=a&&a.comment||$("commentinput"))&&($xwiki.isEditCommentSuggested()||$xwiki.isEditCommentMandatory()))for(;""==a.value;){b=prompt("$services.localization.render('core.comment.prompt')","");if(null===b)return!1;a.value=b;if(!$xwiki.isEditCommentMandatory())break}return!0},onCancel:function(a){a.preventDefault();this.notify(a,"cancel");(a=a.element().form)&&this.cancelForm(a)},cancelForm:function(a){var b=
a.action;"string"!=typeof b&&(b=(b=a.attributes.getNamedItem("action"))?b.nodeValue:window.self.location.href);b=b.split("#",2);var c=2==b.length?b[1]:"";b=b[0];-1==b.indexOf("?")&&(b+="?");var d=a.select('input[name="xredirect"]')[0];d=d?"&xredirect="+escape(d.value):"";a=(a=a.select('input[name="language"]')[0])?"&language="+escape(a.value):"";g.EditLock&&g.EditLock.setLocked(!1);window.location=b+"&action_cancel=true"+d+a+c},onSubmit:function(a,b,c){var d="before"+b.substr(0,1).toUpperCase()+b.substr(1);
this.notify(a,d,{"continue":c})&&(this.validateForm(a.element().form)?this.notify(a,b,{"continue":c}):a.preventDefault())},notify:function(a,b,c){(b=a.element().fire("xwiki:actions:"+b,Object.extend({originalEvent:a,form:a.element().form},c||{})).defaultPrevented||a.defaultPrevented)&&a.preventDefault();return!b}});l.AjaxSaveAndContinue=Class.create({initialize:function(){this.createMessages();this.addListeners()},createMessages:function(){this.savingBox=new g.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.inprogress'))",
"inprogress",{inactive:!0});this.savedBox=new g.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.done'))","done",{inactive:!0});this.failedBox=new g.widgets.Notification('$escapetool.javascript($services.localization.render("core.editors.saveandcontinue.notification.error", ["<span id=""ajaxRequestFailureReason""></span>"]))',"error",{inactive:!0});this.progressMessageTemplate="$escapetool.javascript($services.localization.render('core.editors.savewithprogress.notification'))";
this.progressBox=new g.widgets.Notification(this.progressMessageTemplate.replace("__PROGRESS__","0"),"inprogress",{inactive:!0});this.savedWithMergeBox=new g.widgets.Notification("$escapetool.javascript($services.localization.render('core.editors.saveandcontinue.notification.doneWithMerge'))","done",{inactive:!0})},addListeners:function(){document.observe("xwiki:actions:save",this.onSave.bindAsEventListener(this))},disableEditors:function(){this.form&&this.form.disable()},enableEditors:function(){this.form&&
this.form.enable()},onSave:function(a){if(!a.defaultPrevented){this.savedBox.hide();this.failedBox.hide();var b=a.memo["continue"];this.form=$(a.memo.form);if(-1!=this.form.action.indexOf("/preview/")||-1!=this.form.action.indexOf("/save/")||b){var c=this.form.template&&this.form.template.value;this.form.async&&"true"===this.form.async.value||(c=!1);a.preventDefault();c?this.progressBox.show():this.savingBox.show();var d="action_save";b&&(d="action_saveandcontinue");d=new Hash(this.form.serialize({hash:!0,
submit:d}));b&&d.set("minorEdit","1");Prototype.Browser.Opera||d.set("ajax","true");b||this.disableEditors();a={isContinue:b,isCreateFromTemplate:c,saveButton:a.element()};new Ajax.Request(this.form.action,{method:"post",parameters:d.toQueryString(),onSuccess:this.onSuccess.bind(this,a),on0:this.on0.bind(this),on409:this.on409.bind(this,a),on401:this.on401.bind(this,a),on403:this.on403.bind(this,a),onFailure:this.onFailure.bind(this,a)})}}},on0:function(a){a.request.options.onFailure(a)},onSuccess:function(a,
b){this.form&&this.form.template&&(this.form.template.disabled=!0,this.form.template.value="");$("commentinput")&&($("commentinput").value="");$("forceSave")&&$("forceSave").remove();$$("input[name=mergeChoices]").forEach(function(d){d.remove()});$$("input[name=customChoices]").forEach(function(d){d.remove()});var c=!1;a.isCreateFromTemplate?b.responseJSON&&b.responseJSON.links?this.getStatus(b.responseJSON.links[0].href,a):(this.progressBox.hide(),this.savingBox.replace(this.savedBox),c=!0):(this.progressBox.hide(),
b.responseJSON&&b.responseJSON.mergedDocument?this.savingBox.replace(this.savedWithMergeBox):this.savingBox.replace(this.savedBox),c=!0);if(c&&!a.isContinue||$("body").hasClassName("previewbody"))if(a.saveButton.fire("xwiki:document:saved",b.responseJSON),this.maybeRedirect(a.isContinue))return;b.responseJSON&&b.responseJSON.newVersion&&(require(["xwiki-meta"],function(d){d.setVersion(b.responseJSON.newVersion)}),t&&t.setValue((new Date).getTime()));a.saveButton.fire("xwiki:document:saved",b.responseJSON);
b.responseJSON&&b.responseJSON.mergedDocument&&this.reloadEditor()},displayErrorModal:function(a){g.widgets.ErrorModalPopup=Class.create(g.widgets.ModalPopup,{defaultInteractionParameters:{},initialize:function($super,c){this.interactionParameters=Object.extend(Object.clone(this.defaultInteractionParameters),c||{});$super(a(this.interactionParameters,this),{show:{method:this.showDialog,keys:[]}},{displayCloseButton:!1,verticalPosition:"center",backgroundColor:"#FFF",removeOnClose:!0});this.showDialog()}});
return new g.widgets.ErrorModalPopup},reloadEditor:function(){var a=new URLSearchParams(window.location.search);a.set("timestamp",(new Date).getTime());window.location.search="?"+a.toString()},on401:function(a,b){this.progressBox.hide();this.savingBox.hide();this.savedBox.hide();this.failedBox.hide();this.displayErrorModal(function(c,d){c=new Element("div",{"class":"modal-popup"});var m=new Element("div");c.insert("$services.localization.render('core.editors.save.authorizationError.message')");c.insert(new Element("br"));
c.insert(new Element("br"));var h=g.currentDocument.getURL("login");h=new Element("a",{title:"login",href:h,target:"_new"});h.insert("$services.localization.render('core.editors.save.authorizationError.followLink')");c.insert(h);c.insert(m);h=new Element("br");var n=new Element("button",{"class":"btn btn-primary"});n.insert("OK");m.insert(h);m.insert(n);n.on("click",function(){d.closeDialog()});return c});this.enableEditors();a.saveButton.fire("xwiki:document:saveFailed",{response:b})},on403:function(a,
b){if(!b.responseJSON||"CSRF"!==b.responseJSON.errorType)return this.on401(a,b);this.progressBox.hide();this.savingBox.hide();this.savedBox.hide();this.failedBox.hide();var c=b.responseJSON,d=this;this.enableEditors();this.displayErrorModal(function(m,h){m=new Element("div",{"class":"modal-popup",id:"csrf-warning-modal"});var n=new Element("div");m.insert("$escapetool.json($services.localization.render('csrf.confirmation'))");m.insert(new Element("br"));var p=new Element("button",{"class":"btn btn-default",
id:"force-save-csrf"});p.insert("$services.localization.render('yes')");n.insert(p);p.on("click",function(){$$("input[name=form_token]").each(function(v){v.value=c.newToken});new Ajax.Request(c.resubmissionURI,{method:"post",parameters:"form_token="+c.newToken,onSuccess:d.onSuccess.bind(d,a),on0:d.on0.bind(d),on409:d.on409.bind(d,a),on401:d.on401.bind(d,a),on403:d.on403.bind(d,a),onFailure:d.onFailure.bind(d,a)});h.closeDialog()});p=new Element("button",{"class":"btn btn-primary",id:"cancel-save-csrf"});
p.insert("$services.localization.render('no')");n.insert(p);p.on("click",function(){h.closeDialog()});m.insert(n);return m});a.saveButton.fire("xwiki:document:saveFailed",{response:b})},on409:function(a,b){var c=this;this.progressBox.hide();this.savingBox.hide();this.savedBox.hide();this.failedBox.hide();this.enableEditors();var d=b.responseJSON,m=new Hash(this.form.serialize({hash:!0,submit:"preview"})),h=function(e,f){var q="diff=1&version="+d.latestVersion;0<$$("input[name=warningConflictAction]").length&&
(q+="&warningConflictAction="+$$("input[name=warningConflictAction]:checked")[0].value);if(e&&f){var w=e;var x=f}else 0<$$("select[name=original]").length&&0<$$("select[name=revised]").length&&(w=$$("select[name=original]")[0].value,x=$$("select[name=revised]")[0].value);w&&x&&(q+="&original="+w+"&revised="+x);e=(new g.Document).getURL("preview",q);new Ajax.Request(e,{method:"post",parameters:m.toQueryString(),onSuccess:z,onFailure:c.onFailure.bind(c,a)})},n=function(){$("forceSave")&&$("forceSave").remove();
$$("input[name=mergeChoices]").forEach(function(e){e.remove()});$$("input[name=customChoices]").forEach(function(e){e.remove()});require(["jquery"],function(e){var f=e("input[name=warningConflictAction]:checked").val();A().map(B);e("#previewDiffModal").modal("hide");"reload"===f?c.reloadEditor():(c.form.insert(new Element("input",{type:"hidden",name:"forceSave",id:"forceSave",value:f})),a.isContinue?e("input[name=action_saveandcontinue]").click():e("input[name=action_save]").click())})},p=function(){require(["jquery"],
function(e){e("input[name=warningConflictAction]").parents(".panel").removeClass("panel-primary");e("input[name=warningConflictAction]").parents(".panel").addClass("panel-default");e("input[name=warningConflictAction]:checked").parents(".panel").addClass("panel-primary")})},v=function(e){require(["jquery"],function(f){f(e.currentTarget).find("input[name=warningConflictAction]").click()})},C=function(){var e=$$("input[name=warningConflictAction]:checked")[0].value;"merge"==e?h("NEXT","MERGED"):"override"==
e||"custom"==e?h("NEXT","CURRENT"):"reload"==e&&h("CURRENT","NEXT")},A=function(){return $$("input[name=conflict_id]").map(function(e){return e.value})},B=function(e){var f=$("conflict_decision_select_"+e).value,q=$("conflict_decision_value_custom_"+e).value;c.form.insert(new Element("input",{type:"hidden",name:"mergeChoices",id:"mergeChoices_"+e,value:e+"="+f}));"custom"===f&&c.form.insert(new Element("input",{type:"hidden",name:"customChoices",id:"custom_"+e,value:e+"="+encodeURI(q)}))};var z=function(e){require(["jquery"],
function(f){f("#previewDiffModal")&&(f("#previewDiffChangeDiff").off("click"),f("input[name=warningConflictAction]").off("click"),f("#submitDiffButton").off("click"),f("#previewDiffModal").remove(),f("div.modal-backdrop").remove());f(e.responseText).appendTo("body");p();f("#previewDiffModal").modal("show");f("#previewDiffModal").on("hidden.bs.modal",function(q){f("#previewDiffModal").remove();f("div.modal-backdrop").remove()});f("#previewDiffChoices .panel").on("click",v);f("input[name=warningConflictAction]").on("change",
C);f("#previewDiffChangeDiff").on("click",h);f("#submitDiffButton").on("click",n);f(document).trigger("xwiki:dom:updated",{elements:f("#previewDiffModal").toArray()})})};h();a.saveButton.fire("xwiki:document:saveFailed",{response:b})},onFailure:function(a,b){this.enableEditors();this.savingBox.replace(this.failedBox);this.progressBox.replace(this.failedBox);b.statusText?b.getHeader("Content-Type").match(/^\s*text\/plain/)?$("ajaxRequestFailureReason").update(b.responseText):$("ajaxRequestFailureReason").update(b.statusText):
$("ajaxRequestFailureReason").update("Server not responding");a.saveButton.fire("xwiki:document:saveFailed",{response:b})},startStatusReport:function(a){updateStatus(0)},getStatus:function(a,b){new Ajax.Request(a,{method:"get",parameters:{media:"json"},onSuccess:function(c){c=c.responseJSON.progress.offset;this.updateStatus(c);1>c?setTimeout(this.getStatus.bind(this,a,b),1E3):(this.progressBox.replace(this.savedBox),this.maybeRedirect(b.isContinue))}.bind(this),on0:this.on0.bind(this),onFailure:this.onFailure.bind(this,
b)})},updateStatus:function(a){a=""+100*a;var b=a.indexOf(".");-1<b&&(a=a.substring(0,b+2));a=new g.widgets.Notification(this.progressMessageTemplate.replace("__PROGRESS__",a),"inprogress");this.progressBox.replace(a);this.progressBox=a},maybeRedirect:function(a){if(a)if($("body").hasClassName("previewbody"))a=g.currentDocument.getURL("edit"),this.form.xcontinue&&this.form.xcontinue.value&&(a=this.form.xcontinue.value);else return!1;else{a=g.currentDocument.getURL();var b=this.form.select('input[name="xredirect"]')[0];
b&&b.value&&(a=b.value)}a&&(window.location=a);return!0}});g.domIsLoaded&&k()||document.observe("xwiki:dom:loaded",k);return g}(XWiki||{});
require(["jquery"],function(g){var k=g(".sticky-buttons");if(0!=k.length){var l=g("<div></div>");l.height(0);l.insertBefore(k);g(window).on("scroll resize load click xwiki:dom:refresh",function(){var r=0<g(".fullScreenWrapper").length,t=k.is(":visible");l.height(k.height());var u=l.offset().top+l.height();t&&!r&&g(window).height()+g(window).scrollTop()<u?(k.addClass("sticky-buttons-fixed"),k.innerWidth(k.parent().width())):(k.removeClass("sticky-buttons-fixed"),k.innerWidth(""),l.height(0))})}});

//# sourceMappingURL=actionButtons.min.js.map
