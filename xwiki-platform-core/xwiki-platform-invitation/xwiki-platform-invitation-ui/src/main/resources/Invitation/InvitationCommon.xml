<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.3" reference="Invitation.InvitationCommon" locale="">
  <web>Invitation</web>
  <name>InvitationCommon</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>Invitation.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.0</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
#*
 * Invitation Application
 * This document contains common macros used by all documents in the Invitation Application.
 *
 * Macros in this script don't rely on any variables except those which are passed to them and the following:
 *
 * $doc the com.xpn.xwiki.api.Document object representing the document containing this code.
 * $msg the internationalization message provider containing a get(String) and a get(String, List) function
 * $xcontext the com.xpn.xwiki.Context object for this request
 * $xwiki an object of the com.xpn.xwiki.api.XWiki class.
 * $escapetool an object of class org.apache.velocity.tools.generic.EscapeTool
 * $util used to get a newline character ($util.getNewLine())
 *
 * No macros in this script depend on any other macros.
 *###
##
#if($request.getParameter('test') == '1')
  {{info}}testLoadInvitationConfig{{/info}}
  #testLoadInvitationConfig()
#elseif($doc.getName() == 'InvitationCommon')
  {{info}}$services.localization.render('xe.invitation.internalDocument', ["${doc.getSpace()}.WebHome"]){{/info}}
#end
##
#*
 * Display a message for the sender (preview) or for the admin (review sent messages)
 *
 * $mail (XObject representing email message) the message to view
 *
 * $recipients (List&lt;String&gt;) (Optional) the list of email addresses to override the list provided by $mail
 *                                       used for preview because createMailFromTemplate will exclude addresses
 *                                       which are invalid and we want to show the invalid addresses to the
 *                                       user to tell them that they need to correct them.
 *
 * $invalidAddresses (List&lt;String&gt;) (Optional) List of invalid email addresses in recipients. Needed if you want to
 *                                             show the user that they made a mistake on some addresses.
 *                                             For each email in $invalidEmails, if it is also in $recipients, then it
 *                                             will be marked but left in the same order, emails in $invlaidEmails but
 *                                             not found in $recipients will end up at the end of the list.
 *###
#macro(displayMessage, $mail, $recipients, $invalidAddresses)

  {{html wiki=false clean=false}}
  &lt;div id="invitation-displaymessage" class="invitation"&gt;
   &lt;strong&gt;$services.localization.render('xe.invitation.previewLabel')&lt;/strong&gt;
   &lt;div class="invitation invitation-preview"&gt;
    #set($recips = [])
    #set($invalid = [])
    ## get the lists of valid and invalid email addresses.
    #if("$!invalidAddresses" == '')
      #set($invalid = [])
      #if("$!recipients" == '')
        #set($recips = [$mail.getProperty('recipient').getValue().trim()])
      #else
        #set($discard = $recips.addAll($recipients))
      #end
    #else
      ## Set to local variables to prevent altering input values.
      #set($discard = $recips.addAll($recipients))
      #set($discard = $invalid.addAll($invalidAddresses))
    #end
    ## Print the email addresses to be sent to.
    ## To:
    &lt;strong&gt;$services.localization.render('xe.invitation.toLabel')&lt;/strong&gt;
    &lt;div id="preview-to-field" class="invitation-preview field"&gt;
     #foreach($recip in $recips)
       #if($invalid.contains($recip))
         &lt;span class="invalid-address"&gt;$!escapetool.xml($!recip)&lt;/span&gt; ##
         #set($discard = $invalid.remove($recip))
       #else
         &lt;span class="valid-address"&gt;$!escapetool.xml($!recip)&lt;/span&gt; ##
       #end
     #end
     #foreach($recip in $invalid)
       &lt;span class="invalid-address"&gt;$!escapetool.xml($!recip)&lt;/span&gt; ##
     #end
     &amp;nbsp; ## used to make the field the correct size if it's empty.
    &lt;/div&gt;
    ## Tell the user that some of the email addresses are invalid.
    #if($invalidAddresses &amp;&amp; $invalidAddresses.size() &gt; 0)
      &lt;p class="invalid-address-message"&gt;
       &lt;span class="errormessage"&gt;
        #if($recips.size() == 1)
          ## The email address given is invalid and will not be sent to.
          $services.localization.render('xe.invitation.displayMessage.theAddressIsInvalid')
        #else
          #if($invalid.size() &gt; 1)
            $services.localization.render('xe.invitation.displayMessage.someAddressesAreInvalid', [$invalidAddresses.size()])
          #else
            $services.localization.render('xe.invitation.displayMessage.anAddressesIsInvalid')
          #end
        #end
       &lt;/span&gt;
      &lt;/p&gt;
    #end
     ## Subject:
     &lt;strong&gt;$services.localization.render('xe.invitation.subjectLabel')&lt;/strong&gt;
    &lt;div id="preview-subjectline-field" class="invitation-preview field"&gt;
     $escapetool.xml($mail.getProperty('subjectLine').getValue())
    &lt;/div&gt;
    ## Message:
    &lt;strong&gt;$services.localization.render('xe.invitation.contentLabel')&lt;/strong&gt;
    &lt;div id="preview-messagebody-field" class="invitation-preview field"&gt;
     $mail.getProperty('messageBody').getValue()
    &lt;/div&gt;
   &lt;/div&gt;
  &lt;/div&gt;
  {{/html}}

#end
##
#*
 * Load the configuration.
 * Only works if the script calling this macro has permission to view InvitationConfig 
 * (or create it if it doesn't exist)
 *
 * $config (Map&lt;String, String&gt;) will be populated with invitation configuration.
 *
 * $configDocName (String) (Optional) will load configuration from this document, if not specified will use
 *                                    'InvitationConfig' in the same space as $doc.
 *
 * $configClassName (String) (Optional) will load configuration from object of this class, if not specified will use
 *                                      'Invitation' in the same space as $doc.
 *###
#macro(loadInvitationConfig, $config, $configDocName, $configClassName)
  #define($discard)
    #if("$!configDocName" == '')
      #set($configDocNameInternal = "${doc.getSpace()}.InvitationConfig")
    #else
      #set($configDocNameInternal = $configDocName)
    #end
    #if("$!configClassName" == '')
      #set($configClassNameInternal = "${doc.getSpace()}.WebHome")
    #else
      #set($configClassNameInternal = $configClassName)
    #end
    ##
    ## Load some parameters from the configuration.
    #set($configDoc = $xwiki.getDocumentAsAuthor($configDocNameInternal))
    ##
    ## If no configuration document exists, create one and save it.
    #if($configDoc.isNew())
      ##
      ## load the default configuration from this document.
      #set($thisDocument = $xwiki.getDocumentAsAuthor("${doc.getSpace()}.InvitationCommon"))
      #set($defaultConfigObj = $thisDocument.getObject($configClassNameInternal))
      #foreach($element in $defaultConfigObj.getProperties())
        $config.put($element.getName(), $defaultConfigObj.getProperty($element.getName()).getValue())
      #end
      ##
      #set($configDocContent = '{{velo' + 'city}}{{info}}$services.localization.render(''xe.invitation.internalDocument'', ["'
                               + "$!config.get('mainPage')" + '"]){{/info}}{{/velo' + 'city}}')
      $configDoc.setContent($configDocContent)
      $configDoc.setParent($configClassNameInternal)
      #set($configObj = $configDoc.newObject($configClassNameInternal))
      #foreach($key in $config.keySet())
        $configObj.set($key, $config.get($key))
      #end
      ## Now create the configurable objects.
      #set($cfgable = $configDoc.newObject('XWiki.ConfigurableClass'))
      $cfgable.set('displayInSection', 'Invitation')
      $cfgable.set('configurationClass', $configClassNameInternal)
      $cfgable.set('configureGlobally', 1)
      #set($propsToShow = 'subjectLineTemplate|messageBodyTemplate|emailRegex|from_address|allowUsersOfOtherWikis'
                        + '|usersMayPersonalizeMessage|usersMaySendToMultiple|emailClass|emailContainer')
      $cfgable.set('propertiesToShow', $propsToShow)
      #set($cfgable = $configDoc.newObject('XWiki.ConfigurableClass'))
      $cfgable.set('displayInSection', 'Invitation')
      $cfgable.set('heading', '$services.localization.render(''xe.invitation.configuration.smtpHeading'')')
      $cfgable.set('configurationClass', $configClassNameInternal)
      $cfgable.set('configureGlobally', 1)
      $cfgable.set('propertiesToShow',
                        'smtp_server_password|smtp_server_username|smtp_port|smtp_server|javamail_extra_props')
      $configDoc.saveAsAuthor()
    #else
      ## load the configuration object...
      #set($configObj = $configDoc.getObject($configClassNameInternal))
      #foreach($element in $configObj.getProperties())
        $config.put($element.getName(), $configObj.getProperty($element.getName()).getValue())
      #end
    #end
  #end## define $discard
  ## Now invoke the defined code...
  #set($discard = $discard.toString())
#end
##
#*
 * Basic unit testing of the macro above.
 *###
#macro(testLoadInvitationConfig)
  #set($configDoc = $xwiki.getDocumentAsAuthor("${doc.getSpace()}.InvitationConfig"))
  #if(!$configDoc.isNew())
    $configDoc.deleteAsAuthor()
  #end
  #set($configClass = $xwiki.getDocumentAsAuthor("${doc.getSpace()}.WebHome"))
  #if($configClass.isNew())
    {{error}}Class document [[${doc.getSpace()}.WebHome]] not found. can't run test.{{/error}}
  #else
    #set($config = {})
    #loadInvitationConfig($config, 'HopefullyNonexistantSpace')
    #if($config.size() &lt; 9)
      {{error}}Config map too small{{/error}}
    #end
    #if($config.get('from_address') != 'no-reply@localhost.localdomain')
      {{error}}form_address incorrect, expecting "no-reply@localhost.localdomain" got "$config.get('from_address')"{{/error}}
    #end
    #set($configDoc = $xwiki.getDocumentAsAuthor("${doc.getSpace()}.InvitationConfig"))
    #if($configDoc.isNew())
      {{error}}Config document not created{{/error}}
    #else
      #set($configObj = $configDoc.getObject("${doc.getSpace()}.Invitation"))
      $configObj.set('from_address', 'thisisatest@localhost.localdomain')
      $configDoc.saveAsAuthor()
      $config.clear()
      #loadInvitationConfig($config, 'HopefullyNonexistantSpace')
      #if($config.get('from_address') != 'thisisatest@localhost.localdomain')
        {{error}}altering config parameter failed.{{/error}}
      #end
    #end
  #end
  #set($configDoc = $xwiki.getDocumentAsAuthor("${doc.getSpace()}.InvitationConfig"))
  #if(!$configDoc.isNew())
    $configDoc.deleteAsAuthor()
  #end
#end
##
#**
 * Load mail from mail containing document.
 *
 * $config (Map&lt;String, String&gt;) will be used to get the name of the email class.
 *
 * $emailContainer (Document) the document to get the email from.
 *
 * $mail (Map&lt;String, XObject&gt;) will be populated with email message XObjects by their messageID.
 *###
#macro(loadInvitationMail, $config, $emailContainer, $mail)
  ## If this doesn't already exist, it's created.
  #if($emailContainer.isNew())
    #set($emailContainerContent = '{{velo' + 'city}}{{info}}$services.localization.render(''xe.invitation.internalDocument'', ["'
                                  + "$config.get('emailContainer')" + '"]){{/info}}{{/velo' + 'city}}')
    #set($discard = $emailContainer.setContent($emailContainerContent))
    #set($discard = $emailContainer.setHidden(true))
    #set($discard = $emailContainer.saveAsAuthor())
  #end
  ##
  ## Load messages into a Map by messageID.
  #foreach($obj in $emailContainer.getObjects($config.get('emailClass')))
    #set($discard = $mail.put($obj.getProperty('messageID').getValue(), $obj))
  #end
#end
##
#**
 * Is a guest allowed to accept an invitation?
 *
 * $guestActionsDoc (Document) the document which guests will use to register.
 *###
#macro(canGuestAcceptInvitation, $guestActionsDoc)
  #set($out = 'true')
  #if(!$xwiki.hasAccessLevel('register', 'XWiki.XWikiGuest', 'XWiki.XWikiPreferences')
      &amp;&amp; !$guestActionsDoc.hasProgrammingRights())
  ##
    #set($out = 'false')
  #end
  $out##
#end
##
#**
 * Get the action taken by the user.
 * This will interpret actions taken using displayActionConfirmationForm
 *
 * $parameterMap (Map&lt;String, String&gt;) the parameter map gotten by calling getParameterMap on the servlet request.
 *
 * $actionOutList (List&lt;String&gt;) will be populated with a single value (the action)
 *###
#macro(getUserAction, $parameterMap, $actionOutList)
  #set($actionInternal = 0)
  #foreach($param in $parameterMap.keySet())
    #if($param.indexOf('doAction_') != -1)
      ## Strip 'doAction_'
      #set($actionInternal = $param.substring(9))
    #end
  #end
  #if($actionInternal != 0)
    #set($discard = $actionOutList.add($actionInternal))
  #end
#end
##
#*
 * Display a form allowing a user to confirm doing an action.
 *
 * $messageIDs (List&lt;String&gt;) the unique IDs of the invitations to act upon.
 *
 * $action (String) the action to do.
 *
 * $memoLabel (String) what the memo field should be labeled.
 *
 * $confirmLabel (String) what the confirm button should say.
 *
 * $additionalParameters (Map&lt;String, String&gt;) these parameters will be xml escaped and placed in hidden input fields.
 *###
#macro(displayActionConfirmationForm, $messageIDs, $action, $memoLabel, $confirmLabel, $additionalParameters)
  {{html wiki=false clean=false}}
  &lt;div class="invitation action-confirm"&gt;
   &lt;form action="$doc.getURL()" method="POST"&gt;
    ##
    #foreach($id in $messageIDs)
      &lt;input type="hidden" name="messageID" value="$escapetool.xml($id)" /&gt;
    #end
    &lt;input type="hidden" name="confirm" value="y" /&gt;
    &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
    #if($additionalParameters &amp;&amp; $additionalParameters.size() &gt; 0)
      #foreach($param in $additionalParameters.keySet())
        &lt;input type="hidden" name="$escapetool.xml($param)" value="$escapetool.xml($additionalParameters.get($param))" /&gt;
      #end
    #end
    ##
    &lt;dl&gt;
     &lt;dt&gt;&lt;label for="memo"&gt;$memoLabel&lt;/label&gt;&lt;/dt&gt;
     &lt;dd&gt;&lt;input type="text" size="54" name="memo" /&gt;&lt;/dd&gt;
    &lt;/dl&gt;
    &lt;div class="bottombuttons"&gt;
     &lt;div class="buttons"&gt;
      &lt;span class="buttonwrapper"&gt;
       &lt;input type="submit" class="button" name="doAction_$escapetool.xml($action)" value="$confirmLabel" /&gt;
      &lt;/span&gt;
     &lt;/div&gt;
    &lt;/div&gt;
   &lt;/form&gt;
  &lt;/div&gt;
  {{/html}}
#end
##
#*
 * Set the status of a message and log the memo.
 *
 * $message (Xobject) the message to act on.
 *
 * $status (String) the status to set the message to.
 *
 * $memo (String) what to enter in the log.
 *###
#macro(setMessageStatus, $message, $status, $memo)
   $message.set('status', $status)##
   #set($history = $message.getProperty('history').getValue())
   #set($statusWord = "#messageStatusForCode($status)")
   ## disallow injection of \n which starts a new line or { which may be used for macros.
   #set($log = $memo.replaceAll('\n', ' ').replaceAll('\{', '~{'))
   #set($entry = "|$statusWord|[[$xcontext.getUser()]]|$!log")
   #if("$!history" != '')
     $message.set('history', "$!history$util.getNewline()$entry")##
   #else
     $message.set('history', $entry)##
   #end
#end
##
#*
 * Get the last memo from the message history.
 *
 * $message (Xobject) the message to act on.
 *###
#macro(getLastMemo, $message)
  #set($history = "$!message.getProperty('history').getValue()")
  #set($indexAfterLastNewline = $mathtool.add($history.lastIndexOf($util.getNewline()), 1))
  #if($indexAfterLastNewline &lt; $history.length())
    #set($entry = "$!history.substring($indexAfterLastNewline)")
    #set($indexAfterLastPipe = $mathtool.add($entry.lastIndexOf('|'), 1))
    #if($indexAfterLastPipe &lt; $entry.length())
        $entry.substring($indexAfterLastPipe)##
    #end
  #end
#end
##
#*
 * Get the status of the current message for it's code.
 * unsent - not sent yet.
 * pending - sent and awating a response
 * accepted - sent and accepted by recipient
 * declined - sent and declined by recipient
 * canceled - sent then canceled by sender
 * reported - as spam (by recipient)
 * notSpam - reported as spam and investigated (by admin)
 * sendingFailed - failed to send message
 * else - unknown status
 *
 * $status (String) the status of the message.
 *###
#macro(messageStatusForCode, $status)
  #if($status == 'unsent')
    $services.localization.render('xe.invitation.messageStatus.unsent')##
  #elseif($status == 'pending')
    $services.localization.render('xe.invitation.messageStatus.pending')##
  #elseif($status == 'accepted')
    $services.localization.render('xe.invitation.messageStatus.accepted')##
  #elseif($status == 'declined')
    $services.localization.render('xe.invitation.messageStatus.declined')##
  #elseif($status == 'canceled')
    $services.localization.render('xe.invitation.messageStatus.canceled')##
  #elseif($status == 'reported')
    $services.localization.render('xe.invitation.messageStatus.reported')##
  #elseif($status == 'notSpam')
    $services.localization.render('xe.invitation.messageStatus.investigated')##
  #elseif($status == 'sendingFailed')
    $services.localization.render('xe.invitation.messageStatus.sendingFailed')##
  #else
    $services.localization.render('xe.invitation.messageStatus.unknown', [$escapetool.xml($status)])##
  #end
#end
{{/velocity}}</content>
  <object>
    <name>Invitation.InvitationCommon</name>
    <number>0</number>
    <className>Invitation.WebHome</className>
    <guid>5b0a8220-404d-4d1b-b162-0ebcf323181e</guid>
    <class>
      <name>Invitation.WebHome</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allowUsersOfOtherWikis>
        <defaultValue/>
        <disabled>0</disabled>
        <displayFormType>checkbox</displayFormType>
        <displayType/>
        <name>allowUsersOfOtherWikis</name>
        <number>4</number>
        <prettyName>Let users of other wikis send</prettyName>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allowUsersOfOtherWikis>
      <commonPage>
        <disabled>0</disabled>
        <name>commonPage</name>
        <number>18</number>
        <picker>0</picker>
        <prettyName>common</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </commonPage>
      <emailClass>
        <disabled>0</disabled>
        <name>emailClass</name>
        <number>5</number>
        <picker>0</picker>
        <prettyName>Email message XClass</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </emailClass>
      <emailContainer>
        <disabled>0</disabled>
        <name>emailContainer</name>
        <number>9</number>
        <picker>0</picker>
        <prettyName>Document containing email XObjects</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </emailContainer>
      <emailRegex>
        <disabled>0</disabled>
        <name>emailRegex</name>
        <number>7</number>
        <picker>0</picker>
        <prettyName>Regular expression for validating email addresses</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </emailRegex>
      <from_address>
        <disabled>0</disabled>
        <name>from_address</name>
        <number>1</number>
        <picker>0</picker>
        <prettyName>Email "from" address</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </from_address>
      <guestsActionsPage>
        <disabled>0</disabled>
        <name>guestsActionsPage</name>
        <number>14</number>
        <picker>0</picker>
        <prettyName>guestsActions</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </guestsActionsPage>
      <javamail_extra_props>
        <disabled>0</disabled>
        <editor>---</editor>
        <name>javamail_extra_props</name>
        <number>15</number>
        <picker>0</picker>
        <prettyName>Javamail extra properties</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </javamail_extra_props>
      <mainPage>
        <disabled>0</disabled>
        <name>mainPage</name>
        <number>19</number>
        <picker>0</picker>
        <prettyName>mainPage</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </mainPage>
      <membersActionsPage>
        <disabled>0</disabled>
        <name>membersActionsPage</name>
        <number>16</number>
        <picker>0</picker>
        <prettyName>membersActions</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </membersActionsPage>
      <membersCommonPage>
        <disabled>0</disabled>
        <name>membersCommonPage</name>
        <number>17</number>
        <picker>0</picker>
        <prettyName>membersCommon</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </membersCommonPage>
      <messageBodyTemplate>
        <disabled>0</disabled>
        <editor>---</editor>
        <name>messageBodyTemplate</name>
        <number>3</number>
        <picker>0</picker>
        <prettyName>Email message body HTML template</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </messageBodyTemplate>
      <messageBodyTemplatePlain>
        <disabled>0</disabled>
        <editor>---</editor>
        <name>messageBodyTemplatePlain</name>
        <number>20</number>
        <picker>0</picker>
        <prettyName>Message body plain text template</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </messageBodyTemplatePlain>
      <smtp_port>
        <disabled>0</disabled>
        <name>smtp_port</name>
        <number>13</number>
        <picker>0</picker>
        <prettyName>Smtp port</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </smtp_port>
      <smtp_server>
        <disabled>0</disabled>
        <name>smtp_server</name>
        <number>12</number>
        <picker>0</picker>
        <prettyName>Smtp server host name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </smtp_server>
      <smtp_server_password>
        <disabled>0</disabled>
        <name>smtp_server_password</name>
        <number>11</number>
        <picker>0</picker>
        <prettyName>Smtp password</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </smtp_server_password>
      <smtp_server_username>
        <disabled>0</disabled>
        <name>smtp_server_username</name>
        <number>10</number>
        <picker>0</picker>
        <prettyName>Smtp username</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </smtp_server_username>
      <subjectLineTemplate>
        <disabled>0</disabled>
        <name>subjectLineTemplate</name>
        <number>2</number>
        <picker>0</picker>
        <prettyName>Email subject line template</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </subjectLineTemplate>
      <usersMayPersonalizeMessage>
        <defaultValue/>
        <disabled>0</disabled>
        <displayFormType>checkbox</displayFormType>
        <displayType/>
        <name>usersMayPersonalizeMessage</name>
        <number>8</number>
        <prettyName>Let users personalize messages</prettyName>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </usersMayPersonalizeMessage>
      <usersMaySendToMultiple>
        <defaultValue/>
        <disabled>0</disabled>
        <displayFormType>checkbox</displayFormType>
        <displayType/>
        <name>usersMaySendToMultiple</name>
        <number>6</number>
        <prettyName>Let users send to multiple addresses</prettyName>
        <unmodifiable>0</unmodifiable>
        <validationMessage/>
        <validationRegExp/>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </usersMaySendToMultiple>
    </class>
    <property>
      <allowUsersOfOtherWikis>0</allowUsersOfOtherWikis>
    </property>
    <property>
      <commonPage>Invitation.InvitationCommon</commonPage>
    </property>
    <property>
      <emailClass>Invitation.InvitationMailClass</emailClass>
    </property>
    <property>
      <emailContainer>Invitation.InvitationMessages</emailContainer>
    </property>
    <property>
      <emailRegex>/^([^@\s]+)@((?:[-a-zA-Z0-9]+\.)+[a-zA-Z]{2,})$/</emailRegex>
    </property>
    <property>
      <from_address>no-reply@localhost.localdomain</from_address>
    </property>
    <property>
      <guestsActionsPage>Invitation.InvitationGuestActions</guestsActionsPage>
    </property>
    <property>
      <javamail_extra_props/>
    </property>
    <property>
      <mainPage>Invitation.WebHome</mainPage>
    </property>
    <property>
      <membersActionsPage>Invitation.InvitationMemberActions</membersActionsPage>
    </property>
    <property>
      <membersCommonPage>Invitation.InvitationMembersCommon</membersCommonPage>
    </property>
    <property>
      <messageBodyTemplate>{{velocity}}
#set($discard = "#template('colorThemeInit.vm')")
#if("$!theme" == "")
 #set($theme = {"linkColor":"#4791BC"})
#end
#set($userName = $xwiki.getUserName($xcontext.getUser(), false))
#set($wikiName = $xwiki.getRequestURL().replaceAll("http://([^/:]*).*$", "$1"))
#set($guestActionsURL = $xwiki.getDocumentAsAuthor($config.get("guestsActionsPage")).getExternalURL())
#set($linkStyle = "color:$theme.get('linkColor');text-decoration:none;")
#set($bigText = "font-size:130%;")
#set($joinLink = "float:left;")
#set($declineLink = "color:#f88;float:right;text-decoration:none;")

$services.localization.render('xe.invitation.emailContent.userHasInvitedYouToJoinWiki', [$userName, $wikiName])

{{html clean=false}}
#if("$!messageBody" != "")
  &lt;p style="$bigText"&gt;
  $!escapetool.xml($!messageBody)
  &lt;/p&gt;
#end
&lt;p style="margin-top:30px"&gt;
&lt;a href="${guestActionsURL}?doAction_accept=y&amp;amp;messageID=$messageID" style="$bigText$joinLink$linkStyle"&gt;
$services.localization.render('xe.invitation.emailContent.joinLink')
&lt;/a&gt;
&lt;a href="${guestActionsURL}?doAction_decline=y&amp;amp;messageID=$messageID" style="$bigText$declineLink"&gt;
 $services.localization.render('xe.invitation.emailContent.declineLink')
&lt;/a&gt;&lt;/p&gt;
&lt;hr style="clear:both" /&gt;
$services.localization.render('xe.invitation.emailContent.reportMessage', ["&lt;a href=$escapetool.getQ()${guestActionsURL}?doAction_report=y&amp;amp;messageID=$messageID$escapetool.getQ() style=$escapetool.getQ()$linkStyle$escapetool.getQ()&gt;", "&lt;/a&gt;"])
{{/html}}
{{/velocity}}</messageBodyTemplate>
    </property>
    <property>
      <messageBodyTemplatePlain>{{velocity}}
#set($userName = $xwiki.getUserName($xcontext.getUser(), false))#set($wikiName = $xwiki.getRequestURL().replaceAll("https?://([^/:]*).*$", "$1"))#set($guestActionsURL = $xwiki.getDocumentAsAuthor($config.get('guestsActionsPage')).getExternalURL())$services.localization.render('xe.invitation.emailContent.userHasInvitedYouToJoinWiki', [$userName, $wikiName])#if("$!messageBody" != '')  $messageBody#end$services.localization.render('xe.invitation.emailContent.joinLink')${guestActionsURL}?doAction_accept=y&amp;messageID=$messageID$services.localization.render('xe.invitation.emailContent.declineLink')${guestActionsURL}?doAction_decline=y&amp;messageID=$messageID$services.localization.render('xe.invitation.emailContent.reportMessage', ['', "$util.getNewline()${guestActionsURL}?doAction_decline=y&amp;messageID=$messageID"]){{/velocity}}</messageBodyTemplatePlain>
    </property>
    <property>
      <smtp_port>25</smtp_port>
    </property>
    <property>
      <smtp_server>localhost</smtp_server>
    </property>
    <property>
      <smtp_server_password/>
    </property>
    <property>
      <smtp_server_username/>
    </property>
    <property>
      <subjectLineTemplate>{{velocity}}$services.localization.render('xe.invitation.emailContent.subjectLine', [$xcontext.getUser().replaceAll("^[^\.]*.", ""), $xwiki.getRequestURL().replaceAll("https?://([^/:]*).*$", "$1"), $!subjectLine]){{/velocity}}</subjectLineTemplate>
    </property>
    <property>
      <usersMayPersonalizeMessage>1</usersMayPersonalizeMessage>
    </property>
    <property>
      <usersMaySendToMultiple>0</usersMaySendToMultiple>
    </property>
  </object>
  <object>
    <name>Invitation.InvitationCommon</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>57002efd-3fd9-45a9-bedf-d9741dcc1ac9</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>6</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>3</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>1</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>5</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>4</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>#template("colorThemeInit.vm")
.invitation, .invitation input[type='text'], .invitation textarea, .invitation table {
  float: left;
  width: 450px;
}

/* Keep the table from overflowing */
.invitation .message-table table, .invitation .history-table table {
  table-layout: fixed;
  word-wrap: break-word;
}
.invitation table th.checkboxcol {
  width: 5%
}
.invitation table th.sentDate {
  width: 15%
}
.invitation table th.recipient {
  width: 28%
}
.invitation table th.history {
  width: 18%
}
/* For message history table */
.invitation table th.status-set-to {
  width: 10%
}
.invitation table th.log-entry {
  width: 60%
}

.invitation-preview {
  background-color: #FCFCFC;
  border: 1px solid $theme.get('menuSelectedEntryBackgroundColor');
  padding: 3px;
}

.invitation-preview, .right-side {
  margin-left: 30px;
}

.invitation-preview .field {
  background-color: $theme.get('pageContentBackgroundColor');
  margin-left: 20px;
  margin-bottom: 10px;
  padding: 10px;
  overflow: hidden;

  /* Makes the field fit with padding and margins. */
  width: 390px;
}

.clearboth {
  clear:both;
}

.invitation input[type='text'], .invitation textarea {
  margin-bottom: 10px;
}

/* Labels */
.invitation strong, .invitation label {
  font-size: .85em;
  text-transform: uppercase;
}

/* "Preview:" label */
.invitation strong {
  padding-left: 30px;
}

.invitation-preview strong {
  padding-left: 20px;
}</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name>Invitation Style Sheet</name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>Invitation.InvitationCommon</name>
    <number>0</number>
    <className>XWiki.XWikiRights</className>
    <guid>f5e4ea78-756b-46a6-87e2-8a79d9ea6cee</guid>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAllGroup,</groups>
    </property>
    <property>
      <levels>view</levels>
    </property>
    <property>
      <users>XWiki.XWikiGuest</users>
    </property>
  </object>
</xwikidoc>
