'use strict';var XWiki=function(f){var h=f.importer=f.importer||{},d={availableDocuments:"$services.localization.render('core.importer.availableDocuments')",importHistoryLabel:"$services.localization.render('core.importer.importHistory')",selectionEmpty:"$services.localization.render('core.importer.selectionEmptyWarning')","import":"$services.localization.render('core.importer.import')","package":"$services.localization.render('core.importer.package')",description:"$services.localization.render('core.importer.package.description')",
version:"$services.localization.render('core.importer.package.version')",licence:"$services.localization.render('core.importer.package.licence')",author:"$services.localization.render('core.importer.package.author')",documentSelected:"$services.localization.render('core.importer.documentSelected')",whenDocumentAlreadyExists:"$services.localization.render('core.importer.whenDocumentAlreadyExists')",addNewVersion:"$services.localization.render('core.importer.addNewVersion')",replaceDocumentHistory:"$services.localization.render('core.importer.replaceDocumentHistory')",
resetHistory:"$services.localization.render('core.importer.resetHistory')",importAsBackup:"$services.localization.render('core.importer.importAsBackup')",select:"$services.localization.render('core.importer.select')",all:"$services.localization.render('core.importer.selectAll')",none:"$services.localization.render('core.importer.selectNone')"},l=function(){$$("#packagelistcontainer a.package").invoke("observe","click",function(a){var b=a.element();b=b.href.substring(b.href.indexOf("&file=")+6);a.stop();
$$("div#packagelistcontainer div.active").invoke("removeClassName","active");a.element().up("div.package").addClassName("active");new h.PackageExplorer("packagecontainer",decodeURIComponent(b))});$$("#packagelistcontainer .deletelink").invoke("observe","click",function(a){a.stop();new f.widgets.ConfirmedAjaxRequest(a.findElement("a").href,{onSuccess:function(){a.element().up("div.active")&&$("packagecontainer").update();a.findElement("li").remove()}},{confirmationText:"$services.localization.render('core.viewers.attachments.delete.confirm')"})})};
document.observe("xwiki:dom:loaded",function(){l();var a=$("AddAttachment");if(a&&"undefined"!=typeof f.FileUploader){var b=a.down("input[type='file']");b=new f.FileUploader(b,{progressAutohide:!0,responseContainer:$("packagelistcontainer"),responseURL:window.docgeturl+"?xpage=packagelist&forceTestRights=1",maxFilesize:parseInt(b.readAttribute("data-max-file-size"))});a.observe("xwiki:html5upload:done",l);b.hideFormButtons()}});Element.addMethods("input",{uncheck:function(a){a=$(a);a.checked=!1;return a},
check:function(a){a=$(a);a.checked=!0;return a}});h.PackageInformationRequest=Class.create({initialize:function(a,b){this.name=a;this.successCallback=b.onSuccess||function(){};this.failureCallback=b.onFailure||function(){};a=window.docgeturl+"?xpage=packagedescriptor&package="+encodeURIComponent(a);new Ajax.Request(a,{onSuccess:this.onSuccess.bindAsEventListener(this),on0:this.on0.bindAsEventListener(this),onFailure:this.onFailure.bind(this)})},on0:function(a){a.request.options.onFailure(a)},onSuccess:function(a){this.successCallback(a)},
onFailure:function(a){this.failureCallback(a)}});h.PackageExplorer=Class.create({initialize:function(a,b){this.node=$(a);this.name=b;this.ignore={};this.documentCount={};this.node.addClassName("loading");new h.PackageInformationRequest(b,{onSuccess:this.onPackageInfosAvailable.bind(this),onFailure:this.onPackageInfosRequestFailed.bind(this)})},onPackageInfosAvailable:function(a){a=a.responseText.evalJSON();this.infos=a.infos;this.entities=f.EntityReferenceTree.fromJSONObject(a.entities);a=document.createElement("link");
a.type="text/css";a.rel="stylesheet";a.href="$services.webjars.url('org.xwiki.platform:xwiki-platform-tree-webjar', 'tree.min.css', {'evaluate': true})";document.getElementsByTagName("head")[0].appendChild(a);require(["$!services.webjars.url('org.xwiki.platform:xwiki-platform-tree-webjar', 'require-config.min.js', {'evaluate': true})"],this.requireTree.bind(this))},requireTree:function(){require(["tree"],this.initXTree.bind(this))},initXTree:function(a){this.node.removeClassName("loading");this.node.update();
this.node.empty()&&this.node.insert((new Element("h4",{"class":"legend"})).update(d.availableDocuments));this.container=new Element("div",{id:"packageDescription"});this.node.insert(this.container);this.container.insert(this.createPackageHeader(this.infos));var b=(new Element("span")).update(d.none);b.observe("click",this.onIgnoreAllDocuments.bind(this));var c=(new Element("span")).update(d.all);c.observe("click",this.onRestoreAllDocuments.bind(this));this.container.insert((new Element("div",{"class":"selectLinks"})).insert(d.select).insert(b).insert(", ").insert(c));
this.list=new Element("ul");this.container.insert((new Element("div",{id:"package","class":"package xtree jstree-no-links"})).update(this.list));Object.values(this.entities.children).each(this.addSpace.bind(this));this.container.insert(this.createPackageFormSubmit(this.infos));a("#package").xtree({plugins:["checkbox"]});this.xtree=a.jstree.reference(a("#package"));this.xtree.check_all()},onIgnoreAllDocuments:function(){this.xtree.uncheck_all()},onRestoreAllDocuments:function(){this.xtree.check_all()},
onPackageInfosRequestFailed:function(a){this.node.update();a="Failed to retrieve package information. Reason: "+(a.statusText||"Server not responding");this.node.removeClassName("loading");this.node.update((new Element("div",{"class":"errormessage"})).update(a))},createPackageFormSubmit:function(a){var b=new Element("div",{"class":"packagesubmit"});b.insert((new Element("div")).update(d.whenDocumentAlreadyExists));var c=new Element("input",{type:"radio",name:"historyStrategy",checked:"checked",value:"add"});
b.insert((new Element("div",{"class":"historyStrategyOption"})).insert(c).insert(d.addNewVersion));b.insert((new Element("div",{"class":"historyStrategyOption"})).insert(new Element("input",{type:"radio",name:"historyStrategy",value:"replace"})).insert(d.replaceDocumentHistory));b.insert((new Element("div",{"class":"historyStrategyOption"})).insert(new Element("input",{type:"radio",name:"historyStrategy",value:"reset"})).insert(d.resetHistory));f.hasBackupPackImportRights&&(c=new Element("input",
{type:"checkbox",name:"importAsBackup",value:"true"}),a.backup&&(c.checked=!0),b.insert((new Element("div",{"class":"importOption"})).insert(c).insert(d.importAsBackup)));a=new Element("span",{"class":"buttonwrapper"});c=new Element("input",{type:"submit",value:d["import"],"class":"button"});c.observe("click",this.onPackageSubmit.bind(this));a.insert(c);b.insert(a);return b},onPackageSubmit:function(){var a=this.xtree.get_bottom_checked(!0);if(0==a.length)a=(new Element("span",{"class":"warningmessage"})).update(d.selectionEmpty),
$("packagecontainer").down("div.packagesubmit span.warningmessage")||($("packagecontainer").select("div.packagesubmit input").last().insert({after:a}),Element.remove.delay(5,a));else{var b={action:"import"};b.name=this.name;b.historyStrategy=$("packageDescription").down("input[type=radio][value='add']").checked?"add":$("packageDescription").down("input[type=radio][value='replace']").checked?"replace":"reset";f.hasBackupPackImportRights&&(b.importAsBackup=$("packageDescription").down("input[type=checkbox][name='importAsBackup']").checked?
"true":"false");b.ajax="1";var c=[];a.each(function(e){var g=e.data.reference+":"+e.data.locale;c.push(g);b["language_"+g]=e.data.locale});b.pages=c;this.node.update();this.node.addClassName("loading");this.node.setStyle("min-height:200px");new Ajax.Request(f.currentDocument.getURL("import",Object.toQueryString(window.location.href.parseQuery())),{method:"post",parameters:b,onSuccess:function(e){$("packagecontainer").removeClassName("loading");$("packagecontainer").update(e.responseText)},onFailure:function(e){e=
"Failed to import documents. Reason: "+(e.statusText||"Server not responding");$("packagecontainer").removeClassName("loading");$("packagecontainer").update((new Element("div",{"class":"errormessage"})).update(e))}})}},createPackageHeader:function(a){var b=new Element("div",{"class":"packageinfos"});b.insert((new Element("div")).insert((new Element("span",{"class":"label"})).update(d["package"])).insert((new Element("span",{"class":"filename"})).update(this.name)));""!==a.name&&b.insert((new Element("div")).insert((new Element("span",
{"class":"label"})).update(d.description)).insert((new Element("span",{"class":"name"})).update(a.name)));""!==a.version&&b.insert((new Element("div")).insert((new Element("span",{"class":"label"})).update(d.version)).insert((new Element("span",{"class":"version"})).update(a.version)));""!==a.author&&b.insert((new Element("div")).insert((new Element("span",{"class":"label"})).update(d.author)).insert((new Element("span",{"class":"author"})).update(a.author)));""!==a.licence&&b.insert((new Element("div")).insert((new Element("span",
{"class":"label"})).update(d.licence)).insert((new Element("span",{"class":"licence"})).update(a.licence)));return b},addSpace:function(a){this.addSpaceToList(this.list,a[f.EntityType.SPACE])},addSpaceToList:function(a,b){var c=(new Element("li",{"data-type":"space","data-reference":b.reference,"data-jstree":'{"icon":"fa fa-folder-o","iconOpened":"fa fa-folder-open-o"}'})).update(b.reference.name),e=new Element("ul"),g=this;Object.values(b.children).each(function(k){k.hasOwnProperty(f.EntityType.SPACE)&&
g.addSpaceToList(e,k[f.EntityType.SPACE]);k.hasOwnProperty(f.EntityType.DOCUMENT)&&g.addDocumentToList(e,k[f.EntityType.DOCUMENT])});c.insert(e);a.insert(c)},addDocumentToList:function(a,b){Object.values(b.locales).each(function(c){var e=c.name;""!=c.locale&&(e+=" - "+c.locale);c=(new Element("li",{"data-type":"document","data-reference":c,"data-locale":c.locale,"data-jstree":'{"icon":"fa fa-file-o"}'})).update(e);a.insert(c)})}});return f}(XWiki||{});

//# sourceMappingURL=import.min.js.map
